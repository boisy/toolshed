The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 001


00001                    ;
00002                    ; SuperDos E6, Copyright (C) 1986 ???, Grosvenor.
00003                    ;
00004                    ; Disassembled 2004-11-05, P.Harvey-Smith.
00005                    ;
00006                    ; Fixed for assembly with "mamou" cross-assembler,
00007                    ; from NitrOS9 cocotools.
00008                    ;
00009                    ; Ported to the Dragon Alpha/Professional hardware,
00010                    ; 2004-11-21 P.Harvey-Smith.
00011                    ;
00012                    ; Ported to RS-DOS cartrage (FD-500), using WD1773,
00013                    ; 2006-01-16 P.Harvey-Smith.
00014                    ;
00015                    ; Began porting to run natively on Tandy CoCo 1/2 
00016                    ; 2006-01-26 P.Harvey-Smith.
00017                    ;
00018                    ; Completed port to CoCo.
00019                    ; 2006-01-30 P.Harvey-Smith.
00020                    ;
00021                    ; The CoCo port has the following differences from the 
00022                    ; these are largely due to the fact that on the CoCo, C
00023                    ; Extended color basic are in 2 roms that are linked, w
00024                    ; has the equivelent of Extended basic but all in one R
00025                    ; Also some of the meanings of the Low ram vectors are 
00026                    ;
00027                    ; 1) The RUN vector at $829C, is not called before a pr
00028                    ; 	takes over this vector, the upshot of this is that t
00029                    ;	the PLAY command are not reset on each run. However t
00030                    ;	enough remedied by EXEC &H829C as the first line of y
00031                    ;
00032                    ; 2) The error hook at $88F0 is not called however, the
00033                    ;	calls the Basic error handler if needed (if errors ar
00034                    ;	on error)
00035                    ;
00036                    ; 3) The close single file hook gets re-directed to the
00037                    ; 	code this should only be a problem if writing a file
00038                    ;
00039                    ; 4) The Console output hook is overwritten by DOS, thi
00040                    ;	any effect.
00041                    
00042                    ;
00043                    ; These are defined by the makefile, and are the DOS co
00044                    ;
00045                    ;DragonDos	EQU		1	; Define this if compiling for Standa
00046                    ;DragonAlpha	EQU		1	; Define this if compiling for Drag
00047                    ;RSDos		EQU		1	; Define this if compiling for the RS-DO
00048                    ;
00049                    ;These are also defined in the makefile and are the Mac
00050                    ;
00051                    ;Dragon		EQU		1	; Build for Dragon 32/64/Alpha/Tano/200
00052                    ;Tandy		EQU		1	; Build for Tandy CoCo 1/2/3.
00053                    ;
00054                    
00055                    ;
00056                    ; The file RomDefs.asm contains a set of definitions fo
00057                    ; of either the Dragon or CoCo machines, these will be 
00058                    ; depending on weather Dragon or Tandy is defined.
00059                    ;
00060                                   ifp1      



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 002


00064                                   endc      
00065                    
00066                                   ifne      DragonDos
00099                                   endc      
00100                    
00101                                   ifne      DragonAlpha
00144                                   endc      
00145                    
00146                                   ifne      RSDos
00147                    
00148                    ; This is to use the Tandy FD-500 on a Dragon running s
00149                    
00150    0020            DPPIADA        equ       DPPIA1DA
00151    0021            DPPIACRA       equ       DPPIA1CRA
00152    0022            DPPIADB        equ       DPPIA1DB
00153    0023            DPPIACRB       equ       DPPIA1CRB
00154                    
00155    FF20            PIADA          equ       DPPIADA+IO          ; Side A D
00156    FF21            PIACRA         equ       DPPIACRA+IO         ; Side A C
00157    FF22            PIADB          equ       DPPIADB+IO          ; Side A D
00158    FF23            PIACRB         equ       DPPIACRB+IO         ; Side A C
00159                    
00160                    ;WD2797 Floppy disk controler, used in DragonDos.
00161    0048            DPCMDREG       equ       DPCmdRegT           ; command/
00162    0049            DPTRKREG       equ       DPTrkRegT           ; Track re
00163    004A            DPSECREG       equ       DPSecRegT           ; Sector r
00164    004B            DPDATAREG      equ       DPDataRegT          ; Data reg
00165                    
00166    FF48            CMDREG         equ       DPCMDREG+IO         ; command/
00167    FF49            TRKREG         equ       DPTRKREG+IO         ; Track re
00168    FF4A            SECREG         equ       DPSECREG+IO         ; Sector r
00169    FF4B            DATAREG        equ       DPDATAREG+IO        ; Data reg
00170                    
00171                    ; Disk IO bitmasks
00172                    
00173    0020            NMIEn          equ       NMIEnT              ; Enable/d
00174    0010            WPCEn          equ       WPCEnT              ; Write pr
00175    0020            SDensEn        equ       SDensEnT            ; Write pr
00176    0008            MotorOn        equ       MotorOnT            ; Motor on
00177                    
00178    FF40            DskCtl         equ       DskCtlT             ; Disk con
00179    0040            DPDskCtl       equ       DPDskCtlT           ; Disk con
00180                    
00181    0001            Drive0         equ       Drive0T
00182    0002            Drive1         equ       Drive1T
00183    0004            Drive2         equ       Drive2T
00184    0004            Drive3         equ       Drive3T
00185    0007            DriveMask      equ       DriveMaskT          ; Mask to 
00186                                   endc      
00187                    
00188                    
00189                                   ifne      Tandy
00190                    ; Compiling to run on Tandy CoCo
00191                    
00192    0141            NextResJump    equ       BasStub3+StubResJumpOfs ; Jump
00193    0146            NextFuncsJump  equ       BasStub3+StubFuncsJumpOfs ; Ju
00194                    
00195                                   else      
00201                                   endc      
00202                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 003


00203    C000                           org       $C000
00204                    
00205                    ; Disk controler ID, if a cartrage starts with the char
00206                    ; will do a JMP to $C002 to init the cartrage.
00207                    
00208    C000 444B       DC000          fcc       /DK/
00209                    
00210    C002 2026       LC002          bra       DosInit
00211                    
00212                    ;
00213                    ; Jump table containing the addresses of the various do
00214                    ; JSR [JumpAddr] rather than jumping directly to the ro
00215                    ; JSR [JumpAddr] rather than jumping directly to the ro
00216                    ;
00217    C004 C168                      fdb       SuperDosLowLevel    ; Low Leve
00218    C006 00EA                      fdb       DosHWByte           ; Address 
00219    C008 C7EE                      fdb       SuperDosValidFilename ; Valida
00220    C00A C8AE                      fdb       SuperDosOpenFile    ; Open A f
00221    C00C CF40                      fdb       SuperDosCreateFile  ; Create f
00222    C00E CEA5                      fdb       SuperDosGetFLen     ; Get file
00223    C010 CEE7                      fdb       SuperDosCloseAll    ; Close al
00224    C012 CEFD                      fdb       SuperDosCloseFile   ; Close fi
00225    C014 C9C3                      fdb       SuperDosFRead       ; Read dat
00226    C016 CB85                      fdb       SuperDosFWrite      ; Write da
00227    C018 D179                      fdb       SuperDosGetFree     ; Get free
00228    C01A CFE5                      fdb       SuperDosDeleteFile  ; Delete a
00229    C01C D0CB                      fdb       SuperDosProtect     ; Protect/
00230    C01E D0FD                      fdb       SuperDosRename      ; Rename a
00231    C020 D20A                      fdb       SuperDosGetDirEntry ; Get a di
00232    C022 D27C                      fdb       SuperDosFindAndRead ; Find fre
00233    C024 C764                      fdb       SuperDosSyncDir     ; Copy upd
00234    C026 D33D                      fdb       SuperDosReadAbsSector ; Read a
00235    C028 D32D                      fdb       SuperDosWriteAbsSector ; Write
00236                    
00237                    ;
00238                    ; Init Dos
00239                    ; 
00240                    
00241    C02A 8E0600     DosInit        ldx       #DosAreaStart       ; Point to
00242    C02D 1F12                      tfr       X,Y
00243    C02F 6F80       LC02F          clr       ,X+                 ; Clear a 
00244    C031 313F                      leay      -1,Y                ; decremen
00245    C033 26FA                      bne       LC02F               ; loop aga
00246                    
00247                    ; X now points to the top of the dos variable area
00248                    
00249    C035 1F10                      tfr       X,D
00250    C037 1F89                      tfr       A,B
00251    C039 CB18                      addb      #$18
00252    C03B D719                      stb       <BasStartProg       ; Setup ne
00253    C03D BD96EC                    jsr       >BasLocateScreen
00254    C040 96BA                      lda       <GrDisplayStartAddr ; Adjust g
00255    C042 8B06                      adda      #$06
00256    C044 97B7                      sta       <GrLastDisplayAddr
00257                    
00258                    ;
00259                    ; Init various low ram stuff, inturrupt vectors, basic 
00260                    ; 
00261                    
00262    C046 8EDE2B                    ldx       #DDE24              ; Point to



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 004


00263    C049 E680       LC049          ldb       ,X+                 ; Get byte
00264    C04B 2707                      beq       LC054               ; zero= en
00265    C04D EE81                      ldu       ,X++                ; Get dest
00266    C04F BDA59A                    jsr       >UtilCopyBXtoU      ; do copy
00267    C052 20F5                      bra       LC049               ; do next
00268                    
00269    C054 7F0607     LC054          clr       DosHWMaskFF48       ; clear ha
00270    C057 730608                    com       DosVerifyFlag       ; function
00271    C05A 8E0683                    ldx       #DosNewUSRTable     ; Adjust u
00272    C05D 9FB0                      stx       <BasUSRTableAddr
00273    C05F CEB44A                    ldu       #BasFCError         ; Setup th
00274    C062 C60A                      ldb       #$0A                ; do 10
00275    C064 EF81       LC064          stu       ,X++                ; setup ve
00276    C066 5A                        decb                          ; decremen
00277    C067 26FB                      bne       LC064               ; loop aga
00278                    
00279    C069 7C060A                    inc       DosDefDriveNo
00280    C06C 8D2F                      bsr       LC09D
00281                    
00282    C06E 8E015E                    ldx       #VectBase           ; Point to
00283    C071 108EDEA2                  ldy       #RamHookTable       ; Point to
00284    C075 CC137E                    ldd       #$137E              ; load A w
00285    C078 E780       LC078          stb       ,X+                 ; setup ju
00286    C07A EEA1                      ldu       ,Y++                ; setup ve
00287    C07C EF81                      stu       ,X++
00288    C07E 4A                        deca                          ; decremen
00289    C07F 26F7                      bne       LC078               ; Loop aga
00290                    
00291    C081 8EC70C                    ldx       #ResetVector        ; Setup ne
00292    C084 9F72                      stx       <IndVecReset
00293    C086 1CAF                      andcc     #$AF                ; reenable
00294                    
00295    C088 8E80E7                    ldx       #BasSignonMess      ; Print st
00296    C08B BDB99C                    jsr       >TextOutString
00297    C08E BDC164                    jsr       >DosDoRestore
00298                    
00299    C091 8EDFD5                    ldx       #DosSignonMess
00300    C094 BDB99C                    jsr       >TextOutString
00301    C097 BDDC0F                    jsr       >LDC08
00302    C09A 7EAC73                    jmp       >BasCmdMode         ; Jump to 
00303                    
00304                    
00305    C09D 86D0       LC09D          lda       #WDCmdForceInt      ; Force WD
00306    C09F B7FF48                    sta       cmdreg
00307    C0A2 8E0697                    ldx       #DosD0Online        ; Clear dr
00308    C0A5 DC8A                      ldd       <Misc16BitScratch   ; load D w
00309    C0A7 ED84                      std       ,X
00310    C0A9 ED02                      std       2,X
00311                    
00312    C0AB 8E0621                    ldx       #Drv0Details+5      ; last byt
00313    C0AE 6F84                      clr       ,X
00314    C0B0 6F06                      clr       6,X
00315    C0B2 6F0C                      clr       12,X
00316    C0B4 6F8812                    clr       $12,X
00317                    
00318    C0B7 0FF6                      clr       <DosIOInProgress    ; Flag to 
00319                    
00320    C0B9 8E06AB                    ldx       #DosDirSecStatus    ; Clear Di
00321    C0BC 6F80       LC0BC          clr       ,X+
00322    C0BE 8C07F3                    cmpx      #DosFCBEnd



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 005


00323    C0C1 26F9                      bne       LC0BC
00324                    
00325                    
00326    C0C3 C604                      ldb       #$04                ; Count of
00327    C0C5 8E0634                    ldx       #Buff1Details       ; Setup di
00328    C0C8 CE0800                    ldu       #$0800              ; addr of 
00329    C0CB 6F02       LC0CB          clr       2,X
00330    C0CD E704                      stb       4,X
00331    C0CF EF05                      stu       5,X
00332    C0D1 33C90100                  leau      $0100,U             ; Incremen
00333    C0D5 3007                      leax      7,X                 ; do next 
00334    C0D7 5A                        decb                          ; done all
00335    C0D8 26F1                      bne       LC0CB               ; no : do 
00336    C0DA 39                        rts       
00337                    
00338    C0DB 2A                        fcb       $2A
00339    C0DC 20                        fcb       $20
00340                    
00341    C0DD F60605     LC0DD          ldb       DosTimeout          ; Get time
00342    C0E0 B70605                    sta       DosTimeout
00343    C0E3 5D                        tstb                          ; Timeout 
00344    C0E4 2607                      bne       LC0ED               ; no : ret
00345    C0E6 8ED800                    ldx       #SpinUpDelay        ; wait som
00346    C0E9 301F       LC0E9          leax      -1,X
00347    C0EB 26FC                      bne       LC0E9
00348    C0ED 39         LC0ED          rts       
00349                    
00350                    ; These bytes are here to ensure that the entry points 
00351                    ; address as they are in DragonDos, so that badly behav
00352                    ; direct calls (rather than going through jump table) w
00353    C0EE 20202020                  fcc       /          /
00354                    ;
00355                    ; The following code is quite clever, there are actuall
00356                    ; This involves having a 2 byte instruction encoded as 
00357                    ; byte instruction eg :-
00358                    ;
00359                    ; L00FA	CMPX	#$C605
00360                    ;
00361                    ; CMPX is one byte long, so a jump to L00DB, will execu
00362                    ; CMPX, which decodes as LDB #$05 this saves a few byte
00363                    ; BRA label.
00364                    ;
00365                    ; There are several examples of this in the Dos ROM !
00366                    ;
00367                    
00368    C0F8 C606       LC0F8          ldb       #DosFnReadAddr
00369                    
00370    C0FA 8C                        fcb       Skip2               ; CMPX
00371                    DosDoWriteTrack           
00372    C0FB C605                      ldb       #DosFnWriteTrack
00373                    
00374    C0FD 8C                        fcb       Skip2               ; CMPX
00375                    DosDoWriteSec2           
00376    C0FE C604                      ldb       #DosFnWriteSec2
00377                    
00378    C100 8C                        fcb       Skip2               ; CMPX
00379                    DosDoWriteSec            
00380    C101 C603                      ldb       #DosFnWriteSec
00381                    
00382    C103 8C                        fcb       Skip2               ; CMPX



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 006


00383                    DosDoReadSec             
00384    C104 C602                      ldb       #DosFnReadSec
00385                    
00386                    DosDoFuncinB             
00387    C106 3402                      pshs      A
00388    C108 327E                      leas      -2,S                ; Make roo
00389    C10A 7F0600                    clr       $0600
00390    C10D 8603       LC10D          lda       #$03                ; retry co
00391    C10F EDE4                      std       ,S                  ; save on 
00392                    
00393    C111 8D4E       LC111          bsr       DosDoSeek           ; Try to s
00394    C113 2508                      bcs       LC11D               ; Error ?
00395    C115 E661                      ldb       1,S                 ; No error
00396    C117 D7EA                      stb       <DosHWByte          ; Save ope
00397    C119 8D4D                      bsr       SuperDosLowLevel
00398    C11B 243C                      bcc       LC159               ; No error
00399                    
00400    C11D C184       LC11D          cmpb      #$84
00401    C11F 2727                      beq       LC148
00402                    
00403    C121 6AE4                      dec       ,S                  ; Dec retr
00404    C123 2715                      beq       LC13A               ; Any retr
00405    C125 E6E4                      ldb       ,S                  ; get retr
00406    C127 54                        lsrb                          ; gety lsb
00407    C128 2408                      bcc       LC132               ; on even 
00408                    
00409    C12A 0CEC                      inc       <DskTrackNo         ; step out
00410    C12C 8D33                      bsr       DosDoSeek
00411    C12E 0AEC                      dec       <DskTrackNo         ; step bac
00412    C130 20DF                      bra       LC111
00413                    
00414    C132 96EC       LC132          lda       <DskTrackNo         ; Save Tra
00415    C134 8D2E                      bsr       DosDoRestore        ; Restore 
00416    C136 97EC                      sta       <DskTrackNo         ; Put trac
00417    C138 20D7                      bra       LC111               ; Try agai
00418                    
00419                    ; We come here when all reties exhausted
00420    C13A C180       LC13A          cmpb      #$80
00421    C13C 2618                      bne       LC156
00422    C13E 7D0600                    tst       $0600
00423    C141 2613                      bne       LC156
00424    C143 730600                    com       $0600
00425    C146 200A                      bra       LC152
00426                    
00427                    ; Something to do with dir track ? Make sure same op do
00428    C148 96EC       LC148          lda       <DskTrackNo         ; Get trac
00429    C14A 8114                      cmpa      #$14                ; Track 20
00430    C14C 2608                      bne       LC156               ; no : err
00431    C14E 8610                      lda       #$10                ; set trac
00432    C150 97EC                      sta       <DskTrackNo
00433    C152 E661       LC152          ldb       1,S                 ; Get Dos 
00434    C154 20B7                      bra       LC10D               ; So same 
00435                    
00436    C156 1A01       LC156          orcc      #$01                ; Flag err
00437    C158 21                        fcb       Skip1               ; opcocode
00438    C159 5F         LC159          clrb                          ; Flag no 
00439    C15A 3262                      leas      2,S                 ; Drop byt
00440    C15C 3582                      puls      A,PC                ; restore 
00441                    
00442                    ;



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 007


00443                    ; Another LDB, enbeded in CMPX sequence....
00444                    ; 
00445                    
00446                    DosDoReadSec2            
00447    C15E C607                      ldb       #DosFnReadSec2
00448                    
00449    C160 8C                        fcb       Skip2               ; CMPX
00450                    DosDoSeek                
00451    C161 C601                      ldb       #DosFnSeek
00452                    
00453    C163 8C                        fcb       Skip2               ; CMPX
00454                    DosDoRestore             
00455    C164 C600                      ldb       #DosFnRestore
00456    C166 D7EA                      stb       <DosHWByte          ; save in 
00457                    
00458                    ;
00459                    ; Low level hardware command, operation is in $00E8
00460                    ;
00461                    
00462                    SuperDosLowLevel           
00463    C168 347B                      pshs      CC,A,DP,X,Y,U
00464    C16A 1A50                      orcc      #$50                ; Disable 
00465    C16C 66E4                      ror       ,S
00466    C16E 0FF0                      clr       <DosDiskError       ; Flag no 
00467    C170 96EA                      lda       <DosHWByte          ; get HW b
00468    C172 8107                      cmpa      #$07                ; Valid op
00469    C174 2302                      bls       LC178               ; yes : do
00470    C176 2008                      bra       LC180               ; No: erro
00471                    
00472    C178 BDC290     LC178          jsr       >ResetAndStartDrive
00473    C17B 240E                      bcc       LC18B               ; Error ?
00474    C17D C6FD                      ldb       #$FD                ; yes flag
00475                    
00476    C17F 8C                        fcb       Skip2               ; Andothe 
00477                    
00478    C180 C6FC       LC180          ldb       #$FC                ; Set erro
00479    C182 1A01                      orcc      #$01                ; and carr
00480    C184 69E4                      rol       ,S
00481    C186 D7F0                      stb       <DosDiskError       ; Flag dis
00482    C188 7EC253                    jmp       >LC24D
00483                    
00484                    ; Disable IRQ
00485                    
00486    C18B 8EFF01     LC18B          ldx       #PIA0CRA            ; Point to
00487    C18E A684       LC18E          lda       ,X                  ; Get old 
00488    C190 3402                      pshs      A                   ; save on 
00489    C192 84FC                      anda      #$FC                ; Turn off
00490    C194 A781                      sta       ,X++                ; Save it 
00491    C196 A684                      lda       ,X                  ; Get old 
00492    C198 3402                      pshs      A                   ; save it 
00493    C19A 84FC                      anda      #$FC                ; Disable 
00494    C19C A784                      sta       ,X
00495    C19E 30881E                    leax      $1E,X               ; Point to
00496    C1A1 8CFF23                    cmpx      #PIA1CRB            ; PIA1 ?	
00497    C1A4 25E8                      bcs       LC18E               ; No : do 
00498                    
00499                                   ifeq      RSDos
00503                                   endc      
00504                    
00505    C1A6 8603                      lda       #$03



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 008


00506    C1A8 3402                      pshs      A
00507                    
00508    C1AA 96ED                      lda       <DskSectorNo        ; Get disk
00509                    
00510                                   ifne      RSDos
00511                    ; Set side select correctly on RSDos controler.
00512                    
00513                    RSDosSetSide             
00514    C1AC 8112                      cmpa      #$12                ; >$12, th
00515    C1AE 2307                      bls       RSDosSide0          ; Yes, on 
00516                    
00517    C1B0 C640                      ldb       #SS0                ; turn on 
00518    C1B2 FA0607                    orb       DosHWMaskFF48
00519    C1B5 2005                      bra       RSDosSetSide01      ; Set it
00520                    
00521                    RSDosSide0               
00522    C1B7 F60607                    ldb       DosHWMaskFF48       ; Turn off
00523    C1BA C4BF                      andb      #~SS0
00524                    
00525                    RSDosSetSide01           
00526    C1BC F70607                    stb       DosHWMaskFF48       ; Resave
00527    C1BF F7FF40                    stb       DskCtl              ; Write to
00528                                   endc      
00529                    
00530    C1C2 8112                      cmpa      #$12                ; >$12, th
00531    C1C4 2302                      bls       LC1C2               ; no: don'
00532                    
00533    C1C6 8012                      suba      #$12                ; Calculat
00534                    
00535                                   ifeq      RSDos
00539                                   endc      
00540                    
00541    C1C8 B7FF4A     LC1C2          sta       secreg              ; Save in 
00542    C1CB 97F8                      sta       <DosSectorSeek      ; Save sec
00543    C1CD 109E8A     LC1C7          ldy       <Misc16BitScratch
00544    C1D0 9EEE                      ldx       <DiskBuffPtr        ; Point to
00545    C1D2 D6EA                      ldb       <DosHWByte          ; Get hard
00546    C1D4 58                        aslb                          ; Calculat
00547    C1D5 CEDDE1                    ldu       #DosFunctionTable   ; Point to
00548    C1D8 96F8                      lda       <DosSectorSeek      ; Get sect
00549    C1DA B1FF4A                    cmpa      secreg              ; Found it
00550    C1DD 26E9                      bne       LC1C2
00551                    
00552    C1DF 86FF                      lda       #$FF                ; Set DP=$
00553    C1E1 1F8B                      tfr       A,DP
00554    C1E3 ADD5       LC1DD          jsr       [B,U]               ; Jump to 
00555    C1E5 97F0                      sta       <DosDiskError       ; Save err
00556    C1E7 2402                      bcc       LC1E5               ; No error
00557    C1E9 202E                      bra       LC213
00558                    
00559    C1EB B40609     LC1E5          anda      DosErrorMask        ; Mask out
00560    C1EE 97F0                      sta       <DosDiskError       ; save err
00561    C1F0 270E                      beq       LC1FA               ; No error
00562                    
00563    C1F2 96EA                      lda       <DosHWByte          ; Get oper
00564    C1F4 8107                      cmpa      #DosFnReadSec2      ; ReadSec2
00565    C1F6 2704                      beq       LC1F6
00566    C1F8 6AE4                      dec       ,S                  ; Dec retr
00567    C1FA 26D1                      bne       LC1C7               ; retry
00568                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 009


00569    C1FC 1A01       LC1F6          orcc      #$01                ; Flag err
00570    C1FE 2019                      bra       LC213
00571                    
00572    C200 7D0609     LC1FA          tst       DosErrorMask        ; is this 
00573    C203 2A14                      bpl       LC213               ; no : jum
00574                    
00575    C205 96EC                      lda       <DskTrackNo         ; Get trac
00576    C207 8114                      cmpa      #$14                ; Primary 
00577    C209 270B                      beq       LC210
00578                    
00579    C20B 8110                      cmpa      #$10                ; Secondar
00580    C20D 2707                      beq       LC210
00581                    
00582    C20F 7D0608                    tst       DosVerifyFlag
00583    C212 1CFE                      andcc     #$FE                ; re-enabl
00584    C214 2A03                      bpl       LC213
00585                    
00586    C216 17FF45     LC210          lbsr      DosDoReadSec2
00587    C219 3261       LC213          leas      1,S
00588    C21B 6964                      rol       4,S
00589    C21D 8E069A                    ldx       #DosD0Track-1       ; Point to
00590    C220 D6EB                      ldb       <LastActiveDrv      ; Get last
00591    C222 3A                        abx                           ; get poin
00592    C223 B6FF49                    lda       trkreg              ; Get curr
00593    C226 91EC                      cmpa      <DskTrackNo         ; Same as 
00594    C228 2711                      beq       LC235               ; yes : up
00595                    
00596    C22A F60609                    ldb       DosErrorMask        ; is this 
00597    C22D C119                      cmpb      #$19
00598    C22F 260A                      bne       LC235
00599                    
00600    C231 C6FF                      ldb       #$FF
00601    C233 D7F0                      stb       <DosDiskError
00602    C235 6664                      ror       4,S
00603    C237 1A01                      orcc      #$01                ; flag err
00604    C239 6964                      rol       4,S
00605                    
00606    C23B A784       LC235          sta       ,X                  ; Update c
00607    C23D 8EFF23                    ldx       #PIA1CRB            ; Restore 
00608    C240 3502       LC23A          puls      A
00609    C242 A784                      sta       ,X
00610    C244 3502                      puls      A
00611    C246 A783                      sta       ,--X
00612                    
00613    C248 3088E2                    leax      -$1E,X              ; Do PIA0
00614    C24B 8CFF01                    cmpx      #PIA0CRA
00615    C24E 22F0                      bhi       LC23A
00616                    
00617    C250 7F0606                    clr       DosHWMaskFF40       ; Clear ha
00618    C253 5F         LC24D          clrb                          ; Flag no 
00619    C254 357B                      puls      CC,A,DP,X,Y,U       ; Restore 
00620                    
00621    C256 2437                      bcc       LC289
00622    C258 D6F0                      ldb       <DosDiskError       ; get last
00623    C25A 2733                      beq       LC289               ; no error
00624                    
00625    C25C 2A20                      bpl       LC278
00626                    
00627                    ;
00628                    ; Work out the dragon error code that coresponds to the



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 010


00629                    ; error reported by WD.
00630                    ;
00631                    
00632    C25E C1FC                      cmpb      #$FC
00633    C260 2604                      bne       LC260
00634                    
00635    C262 C6A4                      ldb       #$A4
00636    C264 2027                      bra       LC287
00637                    
00638    C266 C1FD       LC260          cmpb      #$FD
00639    C268 2604                      bne       LC268
00640                    
00641    C26A C628                      ldb       #$28
00642    C26C 201F                      bra       LC287
00643                    
00644    C26E C1FE       LC268          cmpb      #$FE
00645    C270 2604                      bne       LC270
00646                    
00647    C272 C680                      ldb       #$80
00648    C274 2017                      bra       LC287
00649                    
00650    C276 C1FF       LC270          cmpb      #$FF
00651    C278 2611                      bne       LC285
00652                    
00653    C27A C682                      ldb       #$82
00654    C27C 200F                      bra       LC287
00655                    
00656    C27E 1F98       LC278          tfr       B,A
00657    C280 C682                      ldb       #$82
00658    C282 49                        rola      
00659    C283 CB02       LC27D          addb      #$02
00660    C285 49                        rola      
00661    C286 4D                        tsta      
00662    C287 2504                      bcs       LC287
00663    C289 26F8                      bne       LC27D
00664    C28B C6A6       LC285          ldb       #$A6
00665    C28D 1A01       LC287          orcc      #$01
00666    C28F 39         LC289          rts       
00667                    
00668                    ;
00669                    ; Reset controler chip, and spin up drive.
00670                    ;
00671                    
00672                    ResetAndStartDrive           
00673    C290 86D0                      lda       #WDCmdForceInt      ; Force in
00674    C292 B7FF48                    sta       cmdreg
00675    C295 96EB                      lda       <DosLastDrive       ; Get last
00676    C297 2B07                      bmi       LC29A               ; invalid,
00677    C299 2708                      beq       StartDrive          ; Zero ? :
00678    C29B 4A                        deca                          ; Make dri
00679    C29C 8103                      cmpa      #$03                ; Drive va
00680    C29E 2305                      bls       StartDrive2         ; yes : co
00681                    
00682    C2A0 1A01       LC29A          orcc      #$01                ; flag err
00683                    DosHookRetDevParam           
00684    C2A2 39                        rts                           ; return
00685                    
00686                    ;
00687                    ; Select drive, and start motor & load track reg.
00688                    ;



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 011


00689                    ; A=Drive no 0..3
00690                    ;
00691                    
00692                    StartDrive               
00693    C2A3 0CEB                      inc       <DosLastDrive       ; Flag dri
00694                    StartDrive2              
00695                    
00696                                   ifne      RSDos
00697                    ;
00698                    ; Translate Dragon Drive number to RSDos hardware numbe
00699                    ;	Dragon		RSDos
00700                    ;	00000000	00000001
00701                    ;	00000001	00000010
00702                    ;	00000010	00000100
00703                    ;	00000011	00000100
00704                    ; A=Dragon Mask
00705                    ;
00706                    
00707    C2A5 308D1D44                  leax      TDriveTab,pcr       ; Point at
00708    C2A9 A686                      lda       a,x                 ; get driv
00709                                   endc      
00710                    
00711    C2AB 8A28                      ora       #NMIEn+MotorOn      ; Mask in 
00712    C2AD 3402                      pshs      A
00713    C2AF B60607                    lda       DosHWMaskFF48       ; Get HW b
00714                    
00715    C2B2 84F8                      anda      #~DriveMask         ; Mask out
00716    C2B4 AAE0                      ora       ,S+                 ; Mask in 
00717                    
00718                                   ifne      DragonAlpha
00720                                   else      
00721    C2B6 B7FF40                    sta       DskCtl              ; Write to
00722                                   endc      
00723                    
00724    C2B9 B70607                    sta       DosHWMaskFF48       ; Resave h
00725    C2BC 8E069A                    ldx       #DosD0Track-1       ; Point to
00726    C2BF 96EB                      lda       <LastActiveDrv      ; Get acti
00727    C2C1 A686                      lda       A,X                 ; Get driv
00728    C2C3 B7FF49                    sta       trkreg              ; Write to
00729    C2C6 86D2                      lda       #$D2
00730    C2C8 BDC0DD                    jsr       >LC0DD
00731    C2CB 5F                        clrb                          ; no error
00732    C2CC 39                        rts       
00733                    ;
00734                    ; Dos function 0 comes here
00735                    ;
00736                    
00737                    DosFunctionRestore           
00738    C2CD 4F                        clra      
00739  W C2CE B700EC                    sta       >DskTrackNo         ; Save Tra
00740    C2D1 2012                      bra       LC2D9
00741                    
00742                    ;
00743                    ; Dos function 1
00744                    ;
00745                    
00746                    DosFunctionSeek           
00747  W C2D3 B600EC                    lda       >DskTrackNo         ; Get curr
00748    C2D6 9149                      cmpa      dptrkreg            ; Are we o
00749    C2D8 2607                      bne       SeekTrackinA        ; no : see



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 012


00750    C2DA 4F                        clra      
00751    C2DB B70609                    sta       DosErrorMask        ; Turn off
00752    C2DE 1F8B                      tfr       A,DP                ; Reset DP
00753    C2E0 39                        rts       
00754                    
00755                    ;
00756                    ; Seek to a track, routine will exit either with an err
00757                    ; On entry A contains track to seek to.
00758                    ;
00759                    
00760                    SeekTrackinA             
00761    C2E1 974B                      sta       dpdatareg
00762    C2E3 8610                      lda       #WDCmdSeek          ; Seek com
00763                    
00764    C2E5 C619       LC2D9          ldb       #$19
00765    C2E7 F70609                    stb       DosErrorMask
00766    C2EA 8E069E                    ldx       #DosD0StepRate-1    ; Point to
00767  W C2ED F600EB                    ldb       >LastActiveDrv      ; Get acti
00768    C2F0 AA85                      ora       B,X                 ; Mask in 
00769    C2F2 9748                      sta       dpcmdreg            ; save in 
00770    C2F4 3D         LC2E8          mul                           ; burn up 
00771    C2F5 3D                        mul                           ; NMI will
00772    C2F6 313F                      leay      -1,Y                ; decremen
00773    C2F8 26FA                      bne       LC2E8               ; count ex
00774    C2FA 203E                      bra       LC337               ; yes : er
00775                    
00776                    
00777                    
00778                    
00779                    
00780                                   ifne      RSDos
00781                    ;
00782                    ; Dos function 6 : Read address mark (RS-Dos)
00783                    ; 
00784                    DosFunctionReadAddr           
00785    C2FC C6C0                      ldb       #WDCmdReadAddr      ; Read add
00786    C2FE 8C                        fcb       Skip2               ; CMPX aga
00787                    
00788                    ;
00789                    ; Dos function 2 : Read sector (RS-Dos)
00790                    ; 
00791                    DosFunctionReadSec           
00792    C2FF C680                      ldb       #WDCmdReadSec       ; Read a s
00793    C301 FA0606                    orb       DosHWMaskFF40       ; Mask in 
00794                    
00795    C304 863F                      lda       #$3F
00796    C306 B70609                    sta       DosErrorMask
00797                    
00798    C309 8D4D                      bsr       TSetHalt            ; Get IO b
00799                    
00800    C30B D748                      stb       dpcmdreg            ; Send com
00801                    
00802    C30D C602                      ldb       #02                 ; Busy bit
00803    C30F D548       LC301          bitb      <DPCMDREG           ; still bu
00804    C311 2604                      bne       TReadSec            ; no : rea
00805    C313 313F                      leay      -1,Y                ; decremen
00806    C315 26F8                      bne       LC301               ; check fo
00807                    
00808                    TReadSec                 
00809                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 013


00810    C317 D64B       RNext          ldb       dpDataReg           ; Get byte
00811    C319 E780                      stb       ,X+                 ; save in 
00812    C31B 9740                      sta       dpDSKCTL            ; Update r
00813    C31D 20F8                      bra       RNext
00814                    
00815                                   else      
00856                                   endc      
00857                    
00858                    ;
00859                    ; Dos function 7 read first two bytes of a sector, used
00860                    ;
00861                    
00862                    DosFunctionReadSec2           
00863    C31F 8E004F                    ldx       #$004F
00864    C322 863F                      lda       #$3F
00865    C324 B70609                    sta       DosErrorMask
00866                    
00867                                   ifne      RSDos
00868                    ;
00869                    ; Code to wait for DRQ when using RS-DOS controler.
00870                    ;
00871    C327 8D2F                      bsr       TSetHalt            ; Get IO b
00872                    
00873    C329 C680                      ldb       #WDCmdReadSec       ; Read sec
00874    C32B FA0606                    orb       DosHWMaskFF40       ; mask in 
00875    C32E D748                      stb       dpcmdreg            ; write it
00876                    
00877    C330 C602       LC32A          ldb       #$02                ; Bitmask 
00878    C332 D548                      bitb      <DPCMDREG           ; DRQ asse
00879    C334 2610                      bne       LC343               ; Yes, rea
00880    C336 313F                      leay      -1,Y                ; decremen
00881    C338 26F6                      bne       LC32A               ; check ag
00882                    
00883                                   else      
00899                                   endc      
00900                    
00901    C33A 86D0       LC337          lda       #WDCmdForceInt      ; Force th
00902    C33C 9748                      sta       dpcmdreg
00903    C33E 4F                        clra                          ; Reset DP
00904    C33F 1F8B                      tfr       A,DP
00905    C341 86FE                      lda       #$FE                ; return e
00906    C343 1A01                      orcc      #$01
00907    C345 39                        rts       
00908                    
00909                    ; Read data from WD, as normal exited with NMI
00910                    
00911                                   ifne      RSDos
00912                    ;
00913                    ; Read bytes code when using RS-DOS controler.
00914                    ;
00915                    LC343                    
00916                    ;	LDA	DosHWMaskFF48		; Get Drive control reg
00917                    ;	ORA	#HaltEn			; enable halt
00918                    
00919    C346 D64B                      ldb       dpDataReg           ; Get byte
00920    C348 E780                      stb       ,X+                 ; save in 
00921    C34A 9740                      sta       dpDSKCTL            ; Update r
00922                    
00923    C34C D64B                      ldb       dpDataReg           ; Get byte
00924    C34E E784                      stb       ,X                  ; save in 



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 014


00925    C350 9740                      sta       dpDSKCTL            ; Update r
00926                    
00927    C352 D64B       LC350          ldb       dpDataReg           ; clear DR
00928    C354 9740                      sta       dpDSKCTL            ; Update r
00929                    
00930    C356 20FA                      bra       LC350
00931                                   else      
00950                                   endc      
00951                    
00952                                   ifne      RSDos
00953                    ;
00954                    ; Load Reg A with CmdReg mask & enable halt, making thi
00955                    ;
00956                    TSetHalt                 
00957    C358 B60607                    lda       DosHWMaskFF48       ; Get Driv
00958    C35B 8A80                      ora       #HaltEn             ; enable h
00959    C35D 39                        rts       
00960                                   endc      
00961                    ;
00962                    ; Dos function 4
00963                    ;
00964                    
00965                    DosFunctionWriteSec2           
00966    C35E 865F                      lda       #$5F
00967                    
00968    C360 8C                        fcb       Skip2
00969                    
00970                    ;
00971                    ; Dos function 3
00972                    ;
00973                    
00974                    DosFunctionWriteSec           
00975    C361 86DF                      lda       #$DF
00976    C363 B70609                    sta       DosErrorMask
00977    C366 8D3C                      bsr       DosSetPrecomp       ; Setup wr
00978                    
00979                                   ifne      RSDos
00980                    ;
00981                    ; Write sector for RS-DOS controlers.
00982                    ;
00983                    ;	LDA	DosHWMaskFF48	; Get Drive control reg
00984                    ;	ORA	#HaltEn		; enable halt
00985                    
00986    C368 8DEE                      bsr       TSetHalt            ; Get IO b
00987                    
00988    C36A C6A0                      ldb       #WDCmdWriteSec      ; Write se
00989    C36C FA0606                    orb       DosHWMaskFF40       ; Mask in 
00990    C36F D748                      stb       dpcmdreg            ; write to
00991                    
00992    C371 C602                      ldb       #2                  ; DRQ MASK
00993    C373 D548       LC36A          bitb      <DPCMDREG           ; DRQ asse
00994    C375 2606                      bne       LC374               ; Yes, go 
00995    C377 313F                      leay      -1,Y                ; Decremen
00996    C379 26F8                      bne       LC36A               ; if not t
00997    C37B 20BD                      bra       LC337               ; timout, 
00998                    
00999    C37D E680       LC374          ldb       ,X+                 ; Fetch by
01000    C37F D74B                      stb       DPDataReg           ; Write it
01001    C381 9740                      sta       DPDskCtl            ; Halt con
01002    C383 20F8                      bra       LC374



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 015


01003                    
01004                                   else      
01030                                   endc      
01031                    ;
01032                    ; Dos function 5 : Write (format) track
01033                    ;
01034                    
01035                    DosFunctionWriteTrack           
01036    C385 8647                      lda       #$47
01037    C387 B70609                    sta       DosErrorMask
01038    C38A 8D18                      bsr       DosSetPrecomp       ; Set writ
01039                    
01040                    
01041                                   ifne      RSDos
01042    C38C 8DCA                      bsr       TSetHalt            ; Get IO b
01043                    
01044    C38E C6F4                      ldb       #WDCmdWriteTrack    ; Write (f
01045    C390 FA0606                    orb       DosHWMaskFF40       ; Mask in 
01046    C393 D748                      stb       dpcmdreg
01047                    
01048    C395 9740                      sta       dpDskCtl            ; Set halt
01049                    
01050    C397 EC81       LC38B          ldd       ,X++                ; Get byte
01051                    LC38D                    
01052    C399 D74B                      stb       dpdatareg           ; Write a 
01053    C39B 4A                        deca                          ; decremen
01054    C39C 26FB                      bne       LC38D               ; continue
01055                    
01056    C39E E680                      ldb       ,X+                 ; get next
01057                    
01058    C3A0 D74B                      stb       dpdatareg           ; write to
01059    C3A2 20F3                      bra       LC38B               ; do next 
01060                    
01061                                   else      
01083                                   endc      
01084                    ;
01085                    ; Set write precompensation based on track
01086                    ;
01087                    
01088                    DosSetPrecomp            
01089    C3A4 9649                      lda       dptrkreg            ; Get trac
01090    C3A6 8110                      cmpa      #TrackPrecomp       ; track < 
01091    C3A8 2307                      bls       LC3AB               ; no : no 
01092                    
01093    C3AA B60607                    lda       DosHWMaskFF48       ; Enable p
01094    C3AD 8A10                      ora       #WPCEn
01095    C3AF 2005                      bra       LC3B0               ; Write to
01096                    
01097    C3B1 B60607     LC3AB          lda       DosHWMaskFF48       ; Turn off
01098    C3B4 84EF                      anda      #~WPCEn             ;#$EF
01099                    LC3B0                    
01100                                   ifne      DragonAlpha
01102                                   else      
01103    C3B6 B7FF40                    sta       DskCtl              ; Write co
01104                                   endc      
01105                    
01106    C3B9 39                        rts       
01107                    
01108                    ;
01109                    ; Dskinit dispatch routine



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 016


01110                    ;
01111                    ; Syntax :
01112                    ;	DSKINIT				(default drive,sides,tracks)
01113                    ;	DSKINIT drive			(specified drive, default sides,track
01114                    ;	DSKINIT drive,sides		(specified drive,sides default t
01115                    ;	DSKINIT drive,sides,tracks	(specified drive,sides,tra
01116                    ;
01117                    
01118                    CmdDskInit               
01119    C3BA 2723                      beq       LC3D9               ; No param
01120    C3BC BDC6B9                    jsr       >GetDriveNoInB      ; Get driv
01121    C3BF D7EB                      stb       <DosLastDrive       ; save it
01122    C3C1 BDC540                    jsr       >GetCommaThen8Bit   ; Get comm
01123    C3C4 271E                      beq       LC3DE               ; Error, u
01124                    
01125    C3C6 5A                        decb                          ; Convert 
01126    C3C7 C101                      cmpb      #$01                ; > 1 side
01127    C3C9 2211                      bhi       LC3D6
01128                    
01129    C3CB D7F4                      stb       <DosRecLenFlag      ; Save sid
01130    C3CD BDC540                    jsr       >GetCommaThen8Bit   ; Get comm
01131    C3D0 2714                      beq       LC3E0               ; Error : 
01132                    
01133    C3D2 C128                      cmpb      #$28                ; 40 track
01134    C3D4 2712                      beq       LC3E2               ; Yes skip
01135                    
01136    C3D6 00F4                      neg       <DosRecLenFlag
01137    C3D8 C150                      cmpb      #$50                ; 80 track
01138    C3DA 270C                      beq       LC3E2               ; yes, ski
01139    C3DC 7EC6C9     LC3D6          jmp       >DosPRError
01140                    
01141                    ;
01142                    ; Set defaults for format : disk=1,sides=1,tracks=40
01143                    ;
01144    C3DF F6060A     LC3D9          ldb       DosDefDriveNo       ; Get defa
01145    C3E2 D7EB                      stb       <DosLastDrive       ; Save as 
01146    C3E4 0FF4       LC3DE          clr       <DosRecLenFlag      ; 1 side o
01147    C3E6 C628       LC3E0          ldb       #$28                ; 40 track
01148    C3E8 D7F2       LC3E2          stb       <DosBytesInDTA
01149                    
01150    C3EA BDD6FB                    jsr       >DosHookCloseSingle ; Close si
01151    C3ED 10260086                  lbne      CmdDskInitErrorExit
01152                    
01153    C3F1 8E0800                    ldx       #$0800              ; Pointer 
01154    C3F4 9FEE                      stx       <DiskBuffPtr
01155    C3F6 BDC164                    jsr       DosDoRestore        ; Restore 
01156    C3F9 267C                      bne       CmdDskInitErrorExit ; Error : 
01157    C3FB 8601                      lda       #$01
01158    C3FD 97ED                      sta       <DskSectorNo
01159    C3FF BDC15E                    jsr       >DosDoReadSec2      ; Read sec
01160    C402 C180                      cmpb      #$80
01161    C404 2771                      beq       CmdDskInitErrorExit
01162                    
01163    C406 0FF3       LC400          clr       <DosNoBytesMove
01164    C408 0FED                      clr       <DskSectorNo
01165    C40A BDC50F                    jsr       >SetupTrackImage
01166    C40D BDC0FB                    jsr       >DosDoWriteTrack
01167    C410 2565                      bcs       CmdDskInitErrorExit
01168    C412 0DF4                      tst       <DosRecLenFlag
01169    C414 270F                      beq       LC41F



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 017


01170    C416 8601                      lda       #$01
01171    C418 97F3                      sta       <DosNoBytesMove
01172    C41A 40                        nega      
01173    C41B 97ED                      sta       <DskSectorNo
01174    C41D BDC50F                    jsr       >SetupTrackImage
01175    C420 BDC0FB                    jsr       >DosDoWriteTrack
01176    C423 2552                      bcs       CmdDskInitErrorExit
01177    C425 0CEC       LC41F          inc       <DskTrackNo
01178    C427 96EC                      lda       <DskTrackNo
01179    C429 91F2                      cmpa      <DosBytesInDTA
01180    C42B 25D9                      bcs       LC400
01181    C42D BDC164                    jsr       >DosDoRestore
01182    C430 2545                      bcs       CmdDskInitErrorExit
01183    C432 BDC161     LC42C          jsr       >DosDoSeek
01184    C435 2540                      bcs       CmdDskInitErrorExit
01185    C437 4F                        clra      
01186    C438 BDC4F8                    jsr       >LC4F2
01187    C43B 0CEC                      inc       <DskTrackNo
01188    C43D 96EC                      lda       <DskTrackNo
01189    C43F 91F2                      cmpa      <DosBytesInDTA
01190    C441 25EF                      bcs       LC42C
01191    C443 9EEE                      ldx       <DiskBuffPtr
01192    C445 DC8A                      ldd       <Misc16BitScratch
01193    C447 ED81       LC441          std       ,X++
01194    C449 8C0B00                    cmpx      #$0B00
01195    C44C 26F9                      bne       LC441
01196    C44E 8601                      lda       #$01
01197    C450 97ED                      sta       <DskSectorNo
01198    C452 8614                      lda       #$14
01199    C454 8D0A                      bsr       LC45A
01200    C456 0AED                      dec       <DskSectorNo
01201    C458 0AEE                      dec       <DiskBuffPtr
01202    C45A 8610                      lda       #$10
01203    C45C 8D08                      bsr       LC460
01204    C45E 201A                      bra       LC474
01205                    
01206    C460 3402       LC45A          pshs      A
01207    C462 8D3D                      bsr       LC49B
01208    C464 3502                      puls      A
01209    C466 97EC       LC460          sta       <DskTrackNo
01210    C468 BDC101                    jsr       >DosDoWriteSec
01211    C46B 250A                      bcs       CmdDskInitErrorExit
01212    C46D 0CED                      inc       <DskSectorNo
01213    C46F 0CEE                      inc       <DiskBuffPtr
01214    C471 BDC101                    jsr       >DosDoWriteSec
01215    C474 2501                      bcs       CmdDskInitErrorExit
01216    C476 39                        rts       
01217                    
01218                    ;
01219                    ; Exit with error, allow basic to handle it.
01220                    ;
01221                    
01222                    CmdDskInitErrorExit           
01223    C477 7EC6CB                    jmp       >DosHookSysError
01224                    
01225    C47A 0CEE       LC474          inc       <DiskBuffPtr
01226    C47C 9EEE                      ldx       <DiskBuffPtr
01227    C47E CC890A                    ldd       #$890A
01228    C481 A784       LC47B          sta       ,X
01229    C483 308819                    leax      $19,X



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 018


01230    C486 5A                        decb      
01231    C487 26F8                      bne       LC47B
01232    C489 8D04                      bsr       LC489
01233    C48B 8614                      lda       #$14
01234    C48D 97EC                      sta       <DskTrackNo
01235    C48F CC1003     LC489          ldd       #$1003
01236    C492 D7ED                      stb       <DskSectorNo
01237    C494 BDC101     LC48E          jsr       >DosDoWriteSec
01238    C497 25DE                      bcs       CmdDskInitErrorExit
01239    C499 0CED                      inc       <DskSectorNo
01240    C49B 4A                        deca      
01241    C49C 26F6                      bne       LC48E
01242    C49E 7EC09D                    jmp       >LC09D
01243                    
01244    C4A1 97EC       LC49B          sta       <DskTrackNo
01245    C4A3 8612                      lda       #$12
01246    C4A5 C65A                      ldb       #$5A
01247    C4A7 0DF4                      tst       <DosRecLenFlag
01248    C4A9 2702                      beq       LC4A7
01249    C4AB 58                        aslb      
01250    C4AC 48                        asla      
01251    C4AD B708FD     LC4A7          sta       $08FD
01252    C4B0 43                        coma      
01253    C4B1 B708FF                    sta       $08FF
01254    C4B4 96F2                      lda       <DosBytesInDTA
01255    C4B6 B708FC                    sta       $08FC
01256    C4B9 0DF4                      tst       <DosRecLenFlag
01257    C4BB 2605                      bne       LC4BC
01258    C4BD 8150                      cmpa      #$50
01259    C4BF 2601                      bne       LC4BC
01260    C4C1 58                        aslb      
01261    C4C2 43         LC4BC          coma      
01262    C4C3 B708FE                    sta       $08FE
01263    C4C6 9EEE                      ldx       <DiskBuffPtr
01264    C4C8 CE0900                    ldu       #$0900
01265    C4CB 86FF                      lda       #$FF
01266    C4CD A780       LC4C7          sta       ,X+
01267    C4CF 5A                        decb      
01268    C4D0 26FB                      bne       LC4C7
01269    C4D2 CC242D                    ldd       #$242D
01270    C4D5 0DF4                      tst       <DosRecLenFlag
01271    C4D7 270D                      beq       LC4E0
01272    C4D9 2A08                      bpl       LC4DD
01273    C4DB CCB4FF                    ldd       #$B4FF
01274    C4DE E7C0       LC4D8          stb       ,U+
01275    C4E0 4A                        deca      
01276    C4E1 26FB                      bne       LC4D8
01277    C4E3 CC485A     LC4DD          ldd       #$485A
01278    C4E6 DE8A       LC4E0          ldu       <Misc16BitScratch
01279    C4E8 3402                      pshs      A
01280    C4EA 8D02                      bsr       LC4E8
01281    C4EC 3504                      puls      B
01282    C4EE 9EEE       LC4E8          ldx       <DiskBuffPtr
01283    C4F0 3A                        abx       
01284    C4F1 86FC                      lda       #$FC
01285    C4F3 EF81                      stu       ,X++
01286    C4F5 A784                      sta       ,X
01287    C4F7 39                        rts       
01288                    
01289    C4F8 0FED       LC4F2          clr       <DskSectorNo



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 019


01290    C4FA 0DF4                      tst       <DosRecLenFlag
01291    C4FC 2702                      beq       LC4FA
01292    C4FE 8D00                      bsr       LC4FA
01293    C500 8612       LC4FA          lda       #$12
01294    C502 0CED       LC4FC          inc       <DskSectorNo
01295    C504 BDC15E                    jsr       >DosDoReadSec2
01296    C507 1025FF6C                  lbcs      CmdDskInitErrorExit
01297    C50B 4A                        deca      
01298    C50C 26F4                      bne       LC4FC
01299    C50E 39         LC508          rts       
01300                    
01301                    ;
01302                    ; Setup format block for write track
01303                    ;
01304                    
01305                    ;LC509
01306                    SetupTrackImage           
01307    C50F DEEE                      ldu       <DiskBuffPtr
01308    C511 8EDE04                    ldx       #DDDFD
01309    C514 108EDDF1                  ldy       #DDDEA
01310    C518 C60C                      ldb       #$0C
01311    C51A 8D21                      bsr       LC537
01312    C51C 8EDE10     LC516          ldx       #DDE09
01313    C51F C606                      ldb       #$06
01314    C521 8D1A                      bsr       LC537
01315    C523 8601                      lda       #$01
01316    C525 D6EC                      ldb       <DskTrackNo
01317    C527 EDC1                      std       ,U++
01318    C529 D6F3                      ldb       <DosNoBytesMove
01319    C52B E7C0                      stb       ,U+
01320    C52D E6A0                      ldb       ,Y+
01321    C52F EDC1                      std       ,U++
01322    C531 A7C0                      sta       ,U+
01323    C533 C612                      ldb       #$12
01324    C535 8D06                      bsr       LC537
01325    C537 6DA4                      tst       ,Y
01326    C539 26E1                      bne       LC516
01327    C53B C603                      ldb       #$03
01328    C53D 7EA59A     LC537          jmp       >UtilCopyBXtoU
01329                    
01330                    ;
01331                    ; GetCommaThen8Bit, scan for comma, error if not found,
01332                    ;
01333                    
01334                    GetCommaThen8Bit           
01335    C540 9DA5                      jsr       <BasChrGetCurr      ; Get curr
01336    C542 27CA                      beq       LC508               ; Any left
01337    C544 BDB26D                    jsr       >VarCKComma         ; check fo
01338    C547 7EC669                    jmp       >Get8BitorError     ; go get i
01339                    
01340                    ;
01341                    ; Backup command dispatch routine
01342                    ;
01343                    ; Syntax :-
01344                    ;	BACKUP SrcDrive TO Destdrive,heads,tracks
01345                    ;
01346                    ; Stack frame as follows :
01347                    ;	16 bytes cleared on stack, U points to base of this a
01348                    ;
01349                    ;	0,U	Drive number of source ?



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 020


01350                    ;	1,U	$00 Source track
01351                    ;	2,U	$01 Source sector
01352                    ;	3,U	$DF5A ???
01353                    ;	5,U	Source buffer addr
01354                    ;	7,U	Drive number of dest ?
01355                    ;	8,U	$00 Dest track
01356                    ;	9,U	$01 Dest sector ????
01357                    ;	10,U	$DF6D ???
01358                    ;	12,U	dest buff addr
01359                    ;	14,U	$12 Sector count per track to copy ?
01360                    ;	15,U	Page number of top of usable RAM
01361                    
01362                    
01363                    CmdBackup                
01364    C54A 3270                      leas      -16,S               ; Make tem
01365    C54C 1F43                      tfr       S,U                 ; Point U 
01366    C54E 1F30                      tfr       U,D
01367    C550 830040                    subd      #$0040              ; reserve 
01368    C553 931F                      subd      <BasVarEnd          ; Check th
01369    C555 102BE6EB                  lbmi      BasOMError          ; NO: repo
01370                    
01371    C559 8101                      cmpa      #$01                ; At least
01372    C55B 102DE6E5                  lblt      BasOMError          ; NO: repo
01373    C55F A74F                      sta       BupAvailPages,U     ; Store me
01374    C561 8612                      lda       #$12                ; Sectors 
01375    C563 A74E                      sta       BupSecTrk,U
01376    C565 DC1F                      ldd       <BasVarEnd          ; Get end 
01377    C567 ED45                      std       BupSrcBuff,U        ; save in 
01378    C569 ED4C                      std       BupDestBuff,U
01379                    
01380    C56B CCDF5A                    ldd       #$DF5A              ; Error ma
01381    C56E ED43                      std       3,U
01382    C570 CCDF6D                    ldd       #$DF6D
01383    C573 ED4A                      std       10,U
01384                    
01385    C575 CC0001                    ldd       #$0001              ; Set sour
01386    C578 ED41                      std       BupSrcTrk,U
01387    C57A ED48                      std       BupDestTrk,U
01388    C57C B6060A                    lda       DosDefDriveNo       ; Get defa
01389    C57F A740                      sta       BupSrcDrive,U       ; save in 
01390    C581 A747                      sta       BupDestDrive,U      ; and dest
01391    C583 108E02D0                  ldy       #$02D0              ; sector c
01392                    
01393    C587 9DA5                      jsr       <BasChrGetCurr
01394    C589 274A                      beq       DoCmdBackup         ; No param
01395    C58B BDC669                    jsr       >Get8BitorError
01396    C58E C104                      cmpb      #$04                ; greater 
01397    C590 10220132                  lbhi      DosDNError
01398                    
01399    C594 E740                      stb       BupSrcDrive,U       ; Save sou
01400    C596 E747                      stb       BupDestDrive,U      ; and defa
01401                    
01402    C598 9DA5                      jsr       <BasChrGetCurr      ; Get curr
01403    C59A 2739                      beq       DoCmdBackup         ; end of l
01404                    
01405    C59C 81BC                      cmpa      #$BC                ; is this 
01406    C59E 2619                      bne       CmdBackupErrorExit  ; no : err
01407                    
01408    C5A0 9D9F                      jsr       <BasChrGet          ; Get next
01409    C5A2 BDC669                    jsr       >Get8BitorError     ; Get dest



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 021


01410    C5A5 C104                      cmpb      #$04                ; Invalid 
01411    C5A7 1022011B                  lbhi      DosDNError          ; yes : er
01412    C5AB E747                      stb       BupDestDrive,U      ; Save in 
01413                    
01414    C5AD 8D91                      bsr       GetCommaThen8Bit    ; Skip com
01415    C5AF 2724                      beq       DoCmdBackup         ; nothing 
01416    C5B1 C102                      cmpb      #$02                ; 2 sided 
01417    C5B3 2707                      beq       BackupDS            ; yes back
01418    C5B5 C101                      cmpb      #$01                ; 1 sided 
01419    C5B7 2709                      beq       BackupSS            ; yes back
01420                    
01421                    CmdBackupErrorExit           
01422    C5B9 7EB277                    jmp       >BasSNError         ; error : 
01423                    
01424                    BackupDS                 
01425    C5BC 1F20                      tfr       Y,D                 ; Double s
01426    C5BE 31AB                      leay      D,Y
01427    C5C0 684E                      asl       BupSecTrk,U         ; Set sect
01428                    
01429                    BackupSS                 
01430    C5C2 BDC540                    jsr       >GetCommaThen8Bit   ; Get next
01431    C5C5 270E                      beq       DoCmdBackup         ; none: co
01432    C5C7 C150                      cmpb      #$50                ; Is this 
01433    C5C9 2706                      beq       Backup80
01434    C5CB C128                      cmpb      #$28                ; Or a 40 
01435    C5CD 2706                      beq       DoCmdBackup
01436    C5CF 20E8                      bra       CmdBackupErrorExit  ; neither 
01437                    
01438                    Backup80                 
01439    C5D1 1F20                      tfr       Y,D                 ; Double s
01440    C5D3 31AB                      leay      D,Y
01441                    
01442                    DoCmdBackup              
01443    C5D5 4F                        clra      
01444                    
01445                    BupReadFromSrc           
01446    C5D6 3121                      leay      1,Y                 ; Get sect
01447    C5D8 3040                      leax      BupSrcDrive,U       ; point to
01448    C5DA 8D6D                      bsr       LC643               ; read 1 s
01449    C5DC 313F       LC5D6          leay      -1,Y                ; decremen
01450    C5DE 2606                      bne       LC5E0               ; if more 
01451    C5E0 8D1D                      bsr       BupWriteToDest      ; no : wri
01452    C5E2 32C810                    leas      $10,U               ; Clear st
01453    C5E5 39         LC5DF          rts                           ; return t
01454                    
01455    C5E6 A14F       LC5E0          cmpa      BupAvailPages,U     ; Filled a
01456    C5E8 260E                      bne       LC5F2               ; no : do 
01457    C5EA 8D13                      bsr       BupWriteToDest      ; Yes : wr
01458    C5EC 3406                      pshs      D
01459    C5EE DC1F                      ldd       <BasVarEnd          ; Get end 
01460    C5F0 ED4C                      std       BupDestBuff,U       ; Save in 
01461    C5F2 ED45                      std       BupSrcBuff,U
01462    C5F4 3506                      puls      D
01463    C5F6 20DE                      bra       BupReadFromSrc      ; Do next 
01464                    
01465    C5F8 C602       LC5F2          ldb       #$02
01466    C5FA 8D12                      bsr       LC608
01467    C5FC 4C                        inca      
01468    C5FD 20DD                      bra       LC5D6
01469                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 022


01470                    BupWriteToDest           
01471    C5FF 4D                        tsta      
01472    C600 27E3                      beq       LC5DF
01473    C602 3047                      leax      BupDestDrive,U      ; Point to
01474    C604 8D43                      bsr       LC643
01475    C606 C603       DC600          ldb       #$03
01476    C608 8D04       LC602          bsr       LC608
01477    C60A 4A         DC604          deca      
01478    C60B 26FB                      bne       LC602
01479    C60D 39         LC607          rts       
01480                    
01481    C60E 3406       LC608          pshs      D
01482    C610 A600                      lda       BupDrive,X          ; Get  dri
01483    C612 97EB                      sta       <LastActiveDrv      ; Set last
01484                    
01485    C614 EC05                      ldd       BupBuff,X
01486    C616 DDEE                      std       <DiskBuffPtr        ; Setup di
01487    C618 EC01                      ldd       BupTrk,X
01488    C61A DDEC                      std       <DskTrackNo         ; and disk
01489    C61C E661                      ldb       1,S                 ; Get func
01490    C61E BDC106                    jsr       >DosDoFuncinB
01491    C621 2414                      bcc       LC631               ; no error
01492    C623 F70603                    stb       DosErrorCode        ; Temp sto
01493                    
01494    C626 A661                      lda       1,S                 ; Get func
01495    C628 8102                      cmpa      #DosFnReadSec       ; Read ?
01496    C62A 2005                      bra       LC62B
01497                    
01498    C62C 3516                      puls      D,X
01499                    ;        FCB     $35
01500                    ;        FCB     $16
01501                    
01502    C62E BDC5FF                    jsr       BupWriteToDest
01503                    
01504                    ;        FCB     $BD
01505                    ;        FCB     $C5
01506                    ;        FCB     $F9
01507                    
01508    C631 F60603     LC62B          ldb       DosErrorCode        ; Retrieve
01509    C634 7EC6CB                    jmp       >DosHookSysError
01510                    
01511    C637 6C02       LC631          inc       2,X                 ; Incremen
01512    C639 A602                      lda       2,X                 ; check se
01513    C63B A14E                      cmpa      14,U                ; Done all
01514    C63D 2306                      bls       LC63F               ; No: do n
01515                    
01516    C63F 8601                      lda       #$01                ; Reset se
01517    C641 A702                      sta       2,X
01518    C643 6C01                      inc       1,X                 ; Incremen
01519    C645 6C05       LC63F          inc       5,X                 ; Move to 
01520    C647 3586                      puls      D,PC                ; restore 
01521                    
01522    C649 E6C4       LC643          ldb       ,U                  ; get sour
01523    C64B E147                      cmpb      7,U                 ; same as 
01524    C64D 26BE                      bne       LC607               ; no : con
01525                    
01526    C64F 3472                      pshs      A,X,Y,U
01527    C651 BDA928                    jsr       >TextCls            ; clear sc
01528    C654 AE61                      ldx       1,S                 ; get mess
01529    C656 AE03                      ldx       3,X



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 023


01530    C658 BDB99C                    jsr       >TextOutString      ; Print me
01531    C65B 8EDF8D                    ldx       #MessPressAnyKey
01532    C65E BDB99C                    jsr       >TextOutString      ; Print pr
01533    C661 BDA171                    jsr       >TextWaitKeyCurs2   ; Wait for
01534    C664 BDA928                    jsr       >TextCls
01535    C667 35F2                      puls      A,X,Y,U,PC
01536                    ;
01537                    ; Get8BitorError, get non zero 8 bit value in B, or gen
01538                    ;
01539                    Get8BitorError           
01540    C669 3460                      pshs      Y,U
01541    C66B BDB70B                    jsr       >VarGet8Bit         ; Get 8 bi
01542    C66E 5D                        tstb                          ; B non ze
01543    C66F 2603                      bne       LC66E
01544    C671 7EB44A                    jmp       >BasFCError         ; No : err
01545                    
01546    C674 35E0       LC66E          puls      Y,U,PC              ; Restore 
01547                    
01548    C676 81FF       LC670          cmpa      #$FF
01549    C678 1027EBFB                  lbeq      BasSNError
01550    C67C 80CE                      suba      #$CE
01551    C67E 2A03                      bpl       LC67D
01552    C680 7EB277     LC67A          jmp       >BasSNError
01553                    
01554    C683 811A       LC67D          cmpa      #$1A
01555    C685 2406                      bcc       LC687
01556    C687 8EDE60                    ldx       #CommandDispatchTable
01557    C68A 7EADD4                    jmp       >BasDoDipatch
01558                    
01559    C68D 6E9F0141   LC687          jmp       [>NextResJump]      ; Jump to 
01560                    
01561    C691 C044       LC68B          subb      #$44
01562    C693 2A02                      bpl       LC691
01563    C695 20E9                      bra       LC67A
01564                    
01565    C697 C10E       LC691          cmpb      #$0E
01566    C699 2408                      bcc       LC69D
01567    C69B 8EDE94                    ldx       #FunctionDipatchTable
01568    C69E AD95                      jsr       [B,X]
01569    C6A0 7EB143                    jmp       >VarGetExprCC
01570                    
01571    C6A3 6E9F0146   LC69D          jmp       [>NextFuncsJump]    ; Jump to 
01572                    
01573    C6A7 8E0634     LC6A1          ldx       #Buff1Details
01574    C6AA BDD2E8     LC6A4          jsr       >LD2E2
01575    C6AD 261C                      bne       DosHookSysError
01576    C6AF 6F02                      clr       2,X
01577    C6B1 3007                      leax      7,X
01578    C6B3 8C0650                    cmpx      #DosCurDriveInfo    ; $0650
01579    C6B6 25F2                      bcs       LC6A4
01580    C6B8 39         LC6B2          rts       
01581                    
01582                    ;
01583                    ; Get drive no in B, returns drive no (from command) in
01584                    ; or causes error if (drive < 0 ) or (drive > 4)
01585                    ;
01586                    
01587                    GetDriveNoInB            
01588    C6B9 BDB70B                    jsr       >VarGet8Bit         ; Get 8 bi
01589    C6BC 5D                        tstb      



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 024


01590    C6BD 2B07                      bmi       DosDNError          ; Minus, i
01591    C6BF 2601                      bne       LC6BC               ; greater 
01592    C6C1 5C                        incb                          ; =0 incre
01593    C6C2 C104       LC6BC          cmpb      #$04                ; Drive in
01594    C6C4 23F2                      bls       LC6B2               ; Yes : re
01595                    
01596                    DosDNError               
01597    C6C6 C628                      ldb       #$28
01598                    
01599    C6C8 8C                        fcb       Skip2               ; CMPX
01600                    DosPRError               
01601    C6C9 C6A4                      ldb       #$A4
01602                    
01603                    DosHookSysError           
01604    C6CB F70619                    stb       DosErrLast          ; save las
01605    C6CE 9E68                      ldx       <BasCurrentLine     ; Get curr
01606    C6D0 BF0617                    stx       DosErrLineNo        ; save for
01607    C6D3 BDAD33                    jsr       >BasResetStack      ; reset ba
01608    C6D6 0FF6                      clr       <DosIOInProgress    ; Flag no 
01609    C6D8 0F6F                      clr       <TextDevN           ; Set devi
01610    C6DA 7D0614                    tst       DosErrGotoFlag      ; Do we ha
01611    C6DD 2A06                      bpl       LC6DF               ; Yes, han
01612    C6DF 9E68                      ldx       <BasCurrentLine     ; Get curr
01613    C6E1 3001                      leax      1,X
01614    C6E3 261A                      bne       LC6F9
01615                    
01616    C6E5 BDB958     LC6DF          jsr       >TextOutCRLF        ; Output a
01617    C6E8 BDA7EB                    jsr       >CasMotorOff        ; turn off
01618    C6EB BDA974                    jsr       >SndDisable         ; disable 
01619    C6EE BDB9AF                    jsr       >TextOutQuestion    ; output '
01620    C6F1 8EABAF                    ldx       #BasErrorCodeTable  ; Point to
01621    C6F4 F60619                    ldb       DosErrLast          ; Get last
01622    C6F7 2A03                      bpl       LC6F6
01623    C6F9 8EDF2E                    ldx       #DosErrorCodeTable-$80 ; Get p
01624    C6FC 7EAC60     LC6F6          jmp       >SysErr2            ; Jump to 
01625                    
01626    C6FF 8EADC4     LC6F9          ldx       #BasBRARun          ; Go back 
01627    C702 3410       DC6FC          pshs      X
01628    C704 FC0615                    ldd       DosErrDestLine
01629    C707 DD2B                      std       <BasTempLine
01630    C709 7EAEB4                    jmp       >BasSkipLineNo
01631                    
01632                    ;
01633                    ; New reset vector
01634                    ;
01635                    
01636                    ResetVector              
01637    C70C 12                        nop                           ; Main ROM
01638    C70D 4F                        clra                          ; Reset DP
01639    C70E 1F8B                      tfr       A,DP
01640    C710 BDC09D                    jsr       >LC09D              ; Reset WD
01641    C713 7F0609                    clr       DosErrorMask        ; reset va
01642    C716 7F0605                    clr       DosTimeout
01643    C719 7F0613                    clr       DosAutoFlag
01644    C71C 8635                      lda       #$35                ; Re-enabl
01645    C71E B7FF03                    sta       PIA0CRB
01646    C721 7E80C0                    jmp       >WarmStart          ; Jump bac
01647                    
01648                    ;
01649                    ; NMI vector, called to break out of read & write loops



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 025


01650                    ; This allows the IO routines to handle sectors of all 
01651                    ;
01652                    
01653                    NMISrv                   
01654    C724 9648                      lda       dpcmdreg            ; Read sta
01655    C726 5F                        clrb                          ; Reset DP
01656    C727 1F9B                      tfr       B,DP
01657    C729 326C                      leas      12,S                ; Drop reg
01658    C72B 4D                        tsta                          ; Setup CC
01659    C72C 39         LC726          rts                           ; Return t
01660                    
01661                    ;
01662                    ; New IRQ vector, used to count down and shut off drive
01663                    ;
01664                    
01665    C72D 4F         IRQSrv         clra                          ; Reset DP
01666    C72E 1F8B                      tfr       A,DP
01667    C730 0DF6                      tst       <DosIOInProgress    ; Doing IO
01668    C732 261A                      bne       LC748               ; Yes: don
01669    C734 B60605                    lda       DosTimeout          ; Get time
01670    C737 2715                      beq       LC748               ; Already 
01671    C739 4A                        deca                          ; Decremen
01672    C73A B70605                    sta       DosTimeout
01673    C73D 260F                      bne       LC748               ; not zero
01674    C73F 8D23                      bsr       SuperDosSyncDir     ; syncrons
01675    C741 260E                      bne       LC74B               ; Error : 
01676    C743 B60607                    lda       DosHWMaskFF48       ; turn off
01677                    
01678                                   ifne      RSDos
01679    C746 84F0                      anda      #~DriveOffMaskT     ; On RSDos
01680                                   else      
01682                                   endc      
01683    C748 B70607                    sta       DosHWMaskFF48       ; Just tur
01684                    
01685                                   ifne      DragonAlpha
01687                                   else      
01688    C74B B7FF40                    sta       DskCtl              ; Actually
01689                                   endc      
01690                    
01691    C74E 7EA9B3     LC748          jmp       >BasIRQVec          ; Jump to 
01692                    
01693    C751 7EC6CB     LC74B          jmp       >DosHookSysError    ; Jump to 
01694                    
01695    C754 1F40       LC74E          tfr       S,D
01696    C756 830100                    subd      #$0100
01697    C759 931F                      subd      <BasVarEnd
01698    C75B 2B04                      bmi       LC75B
01699    C75D 5F                        clrb      
01700    C75E 4D                        tsta      
01701    C75F 26CB                      bne       LC726
01702    C761 7EAC44     LC75B          jmp       >BasOMError
01703                    
01704                    ;
01705                    ; Copy directory from track 20 to track 16.
01706                    ;
01707                    
01708                    SuperDosSyncDir           
01709    C764 BDC6A7                    jsr       >LC6A1
01710    C767 3278                      leas      -8,S                ; Make roo
01711    C769 33E4                      leau      ,S                  ; Point U 



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 026


01712    C76B 3144                      leay      4,U
01713    C76D 8E0800                    ldx       #DosDiskBuffBase    ; Point at
01714    C770 9FEE                      stx       <DiskBuffPtr
01715    C772 6F42                      clr       2,U
01716    C774 D6EB                      ldb       <DosLastDrive       ; Get last
01717    C776 E741                      stb       1,U                 ; Save it
01718    C778 C601                      ldb       #$01
01719    C77A E7C4                      stb       ,U
01720    C77C 0FEB                      clr       <DosLastDrive
01721    C77E 8E06AA                    ldx       #DosDirSecStatus-1  ; $06AA
01722                    
01723    C781 C612       LC77B          ldb       #SectorsPerTrack    ; Sector c
01724    C783 E743                      stb       3,U
01725    C785 0CEB                      inc       <DosLastDrive
01726                    
01727    C787 E643       LC781          ldb       3,U
01728    C789 A685                      lda       B,X
01729    C78B A5C4                      bita      ,U
01730    C78D 271E                      beq       LC7A7
01731                    
01732    C78F 43                        coma      
01733    C790 A485                      anda      B,X
01734    C792 A785                      sta       B,X
01735    C794 6C42                      inc       2,U
01736    C796 D7ED                      stb       <DskSectorNo
01737    C798 E7A0                      stb       ,Y+
01738    C79A C614                      ldb       #DirPrimary         ; Track 20
01739    C79C D7EC                      stb       <DskTrackNo
01740    C79E BDC104                    jsr       >DosDoReadSec       ; Go read 
01741    C7A1 2621                      bne       LC7BE               ; Error !
01742                    
01743    C7A3 0CEE                      inc       <DiskBuffPtr        ; use next
01744    C7A5 E642                      ldb       2,U                 ; Check to
01745    C7A7 C104                      cmpb      #$04
01746    C7A9 2502                      bcs       LC7A7
01747    C7AB 8D1A                      bsr       LC7C1
01748                    
01749    C7AD 6A43       LC7A7          dec       3,U
01750    C7AF 26D6                      bne       LC781
01751    C7B1 6D42                      tst       2,U
01752    C7B3 2702                      beq       LC7B1
01753    C7B5 8D10                      bsr       LC7C1
01754                    
01755    C7B7 68C4       LC7B1          asl       ,U
01756    C7B9 A6C4                      lda       ,U
01757    C7BB 8108                      cmpa      #$08
01758    C7BD 23C2                      bls       LC77B
01759                    
01760    C7BF A641                      lda       SyncDrive,U         ; Restore 
01761    C7C1 97EB                      sta       <DosLastDrive
01762    C7C3 5F                        clrb                          ; Flag no 
01763    C7C4 3248       LC7BE          leas      8,U                 ; Drop sta
01764    C7C6 39                        rts       
01765                    
01766    C7C7 8610       LC7C1          lda       #DirBackup          ; Backup t
01767    C7C9 97EC                      sta       <DskTrackNo
01768    C7CB 0AEE       LC7C5          dec       <DiskBuffPtr
01769    C7CD 313F                      leay      -1,Y
01770    C7CF A6A4                      lda       ,Y
01771    C7D1 97ED                      sta       <DskSectorNo        ; Pickup s



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 027


01772    C7D3 BDC101                    jsr       >DosDoWriteSec      ; Go write
01773    C7D6 2703                      beq       LC7D5
01774    C7D8 3248                      leas      8,U
01775    C7DA 39                        rts       
01776                    
01777    C7DB 6A42       LC7D5          dec       2,U
01778    C7DD 26EC                      bne       LC7C5
01779    C7DF 39                        rts       
01780                    
01781                    FIRQSrv                  
01782    C7E0 7DFF21                    tst       PIACRA              ; Clear In
01783    C7E3 7DFF23                    tst       PIACRB
01784    C7E6 3B                        rti                           ; and retu
01785                    
01786                    DosValidateAndOpen           
01787    C7E7 8D05                      bsr       SuperDosValidFilename ; Valida
01788    C7E9 2672                      bne       LC857               ; Error : 
01789    C7EB 7EC8AE                    jmp       >SuperDosOpenFile   ; Open fil
01790                    
01791                    ;
01792                    ; Validate filename and copy to current drive block
01793                    ;
01794                    ;	  On entry:
01795                    ;	    X points to filename e.g. '3:FILENAME.EXT'
01796                    ;	    B length of filename e.g. 0x0e
01797                    ;	    Y points to default extension to use if none is g
01798                    ;             Use '   ' for no default extension
01799                    ;	  On Return:
01800                    ;	    Filename appears at $0650-$065a
01801                    ;	    CC.Z clear on error
01802                    ;	    B contains error code
01803                    ;	    U $065b always (SuperDosE6)
01804                    ;
01805                    
01806                    
01807                    SuperDosValidFilename           
01808    C7EE B6060A                    lda       DosDefDriveNo
01809    C7F1 B7065B                    sta       DosCurDriveNo       ; Set curr
01810    C7F4 7F0660                    clr       DosCurCount
01811    C7F7 CE0650                    ldu       #DosCurDriveInfo    ; Point at
01812                    
01813    C7FA 8607                      lda       #$07                ; Zero out
01814    C7FC 6FC6       LC7F6          clr       A,U
01815    C7FE 4A                        deca      
01816    C7FF 2AFB                      bpl       LC7F6
01817                    
01818    C801 A622                      lda       2,Y                 ; Transfer
01819    C803 B7065A                    sta       DosCurExtension+2   ; $065A
01820    C806 A621                      lda       1,Y
01821    C808 B70659                    sta       DosCurExtension+1   ; $0659
01822    C80B A6A4                      lda       ,Y
01823    C80D B70658                    sta       DosCurExtension     ; $0658
01824                    
01825    C810 C10E                      cmpb      #MaxFilenameLen     ; Filename
01826    C812 2247                      bhi       LC855               ; Yep : er
01827                    
01828    C814 5D                        tstb                          ; Too shor
01829    C815 2744                      beq       LC855               ; Yep : er
01830                    
01831    C817 C103                      cmpb      #$03                ; Long eno



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 028


01832    C819 2528                      bcs       LC83D               ; nope : s
01833                    
01834                    ; Because of the order of compare a drive letter at the
01835                    ; takes presedence, this would only be siginificant if 
01836                    ; '1:2' which would access a file called '1' on drive 2
01837                    
01838    C81B C002                      subb      #$02                ; Look for
01839    C81D A685                      lda       B,X
01840    C81F 813A                      cmpa      #':                 ; Seperato
01841    C821 2606                      bne       LC823               ; No skip 
01842    C823 5C                        incb      
01843    C824 A685                      lda       B,X                 ; Get driv
01844    C826 5C                        incb      
01845    C827 200A                      bra       LC82D               ; Go proce
01846                    
01847    C829 CB02       LC823          addb      #$02                ; Check fo
01848    C82B A601                      lda       1,X
01849    C82D 813A                      cmpa      #':                 ; Seperato
01850    C82F 2612                      bne       LC83D               ; nope, us
01851                    
01852    C831 A681                      lda       ,X++                ; Get asci
01853    C833 8030       LC82D          suba      #$30                ; Work out
01854    C835 2304                      bls       LC835
01855                    
01856    C837 8104                      cmpa      #MaxDriveNo         ; Drive va
01857    C839 2303                      bls       LC838
01858                    
01859    C83B C61C       LC835          ldb       #$1C                ; Error !
01860    C83D 39                        rts       
01861                    
01862    C83E B7065B     LC838          sta       DosCurDriveNo       ; Set curr
01863    C841 C002                      subb      #$02
01864                    
01865                    ; Parse filename looking for extension seperator
01866                    
01867    C843 A680       LC83D          lda       ,X+                 ; Get next
01868    C845 5A                        decb                          ; Decremen
01869    C846 2B64                      bmi       LC8A6               ; Reached 
01870                    
01871    C848 812F                      cmpa      #'/                 ; Check fo
01872    C84A 2704                      beq       LC84A
01873                    
01874    C84C 812E                      cmpa      #'.                 ; Check fo
01875    C84E 261C                      bne       LC866
01876                    
01877    C850 11830650   LC84A          cmpu      #DosCurDriveInfo    ; $0650
01878    C854 2705                      beq       LC855
01879                    
01880    C856 7D0660                    tst       DosCurCount         ; First pa
01881    C859 2703                      beq       LC858               ; yes : sk
01882                    
01883    C85B C696       LC855          ldb       #$96                ; Error ?
01884    C85D 39         LC857          rts       
01885                    
01886    C85E 7C0660     LC858          inc       DosCurCount         ; Mark sec
01887    C861 CE0658                    ldu       #DosCurExtension    ; $0658
01888    C864 6FC4                      clr       ,U                  ; Zero out
01889    C866 6F41                      clr       1,U
01890    C868 6F42                      clr       2,U
01891    C86A 20D7                      bra       LC83D



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 029


01892                    
01893                    
01894                    ; Validate filename chars
01895                    
01896    C86C 8141       LC866          cmpa      #'A                 ; $41
01897    C86E 2510                      bcs       LC87A               ; Below, c
01898                    
01899    C870 815A                      cmpa      #'Z                 ; $5A
01900    C872 2318                      bls       LC886               ; valid, s
01901                    
01902    C874 8020                      suba      #$20                ; Convert 
01903    C876 8141                      cmpa      #'A                 ; $41
01904    C878 25E1                      bcs       LC855               ; Invalid,
01905                    
01906    C87A 815A                      cmpa      #'Z                 ; $5A
01907    C87C 230E                      bls       LC886               ; Valid: s
01908    C87E 20DB                      bra       LC855
01909                    
01910    C880 812D       LC87A          cmpa      #'-                 ; $2D
01911    C882 2708                      beq       LC886               ; Valid sk
01912                    
01913    C884 8130                      cmpa      #'0                 ; $30
01914    C886 25D3                      bcs       LC855               ; Invalid 
01915    C888 8139                      cmpa      #'9                 ; $39
01916    C88A 22CF                      bhi       LC855               ; Invalid 
01917                    
01918    C88C A7C0       LC886          sta       ,U+                 ; Save cha
01919    C88E 1183065B                  cmpu      #DosCurDriveNo      ; Path ful
01920    C892 2605                      bne       LC893               ; nope : s
01921                    
01922    C894 5D                        tstb                          ; Done all
01923    C895 26C4                      bne       LC855               ; nope : e
01924    C897 2013                      bra       LC8A6
01925                    
01926    C899 11830658   LC893          cmpu      #DosCurExtension    ; Reached 
01927    C89D 26A4                      bne       LC83D
01928                    
01929    C89F A680                      lda       ,X+                 ; Get next
01930    C8A1 5A                        decb                          ; Dec coun
01931    C8A2 2B08                      bmi       LC8A6               ; Done, re
01932                    
01933    C8A4 812E                      cmpa      #'.                 ; Check fo
01934    C8A6 27A8                      beq       LC84A               ; yep loop
01935    C8A8 812F                      cmpa      #'/                 ; Check fo
01936    C8AA 27A4                      beq       LC84A               ; Yep loop
01937                    
01938    C8AC 5F         LC8A6          clrb      
01939    C8AD 39                        rts       
01940                    
01941                    ;
01942                    ; Open a file and copy dir entry into FCB.
01943                    ;
01944                    ;  On entry:
01945                    ;	    Filename at $0650 ??
01946                    ;	  Returns:
01947                    ;	    CC.Z clear on error
01948                    ;	    A FCB number (0-9)
01949                    ;	    B contains error code
01950                    ;
01951                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 030


01952                    
01953                    SuperDosOpenFile           
01954    C8AE 8E06BD                    ldx       #DosFCB0Addr        ; Point to
01955    C8B1 0FF1                      clr       <DosCurrCtrlBlk
01956    C8B3 FC0650                    ldd       DosCurDriveInfo     ; Get firs
01957    C8B6 10A384     LC8B0          cmpd      ,X                  ; Does thi
01958    C8B9 2616                      bne       LC8CB               ; Nope : c
01959                    
01960                    ; Found matching first 2 bytes of name in an FCB
01961                    
01962    C8BB CE0652                    ldu       #DosCurDriveInfo+2  ; Check by
01963    C8BE 3102                      leay      2,X                 ; Compare 
01964    C8C0 C60A                      ldb       #$0A                ; Do 10 by
01965    C8C2 A6C0       LC8BC          lda       ,U+                 ; Get a by
01966    C8C4 A1A0                      cmpa      ,Y+                 ; compare 
01967    C8C6 2606                      bne       LC8C8               ; Don't ma
01968    C8C8 5A                        decb                          ; Decremen
01969    C8C9 26F7                      bne       LC8BC               ; Not at e
01970    C8CB 7EC979                    jmp       >LC973              ; Found it
01971                    
01972                    ; Move to check next FCB
01973                    
01974    C8CE FC0650     LC8C8          ldd       DosCurDriveInfo     ; Re-get f
01975    C8D1 30881F     LC8CB          leax      DosFCBLength,X      ; Skip to 
01976    C8D4 0CF1                      inc       <DosCurrCtrlBlk     ; Set curr
01977    C8D6 8C07F3                    cmpx      #DosFCBEnd          ; End of b
01978    C8D9 25DB                      bcs       LC8B0               ; No, loop
01979                    
01980    C8DB 0FF1                      clr       <DosCurrCtrlBlk     ; Set curr
01981    C8DD 8E06BD                    ldx       #DosFCB0Addr        ; Point at
01982                    
01983    C8E0 6D84       LC8DA          tst       ,X                  ; FCB in u
01984    C8E2 270D                      beq       LC8EB               ; No : ski
01985                    
01986    C8E4 30881F                    leax      DosFCBLength,X      ; Check ne
01987    C8E7 0CF1                      inc       <DosCurrCtrlBlk
01988    C8E9 8C07F3                    cmpx      #DosFCBEnd          ; Done all
01989    C8EC 25F2                      bcs       LC8DA               ; No : che
01990    C8EE C6A2                      ldb       #$A2
01991    C8F0 39         LC8EA          rts       
01992                    
01993    C8F1 C60C       LC8EB          ldb       #$0C                ; Copy 12 
01994    C8F3 1F12                      tfr       X,Y                 ; Point Y 
01995    C8F5 CE0650                    ldu       #DosCurDriveInfo    ; Point at
01996    C8F8 A6C0       LC8F2          lda       ,U+                 ; Copy fil
01997    C8FA A7A0                      sta       ,Y+
01998    C8FC 5A                        decb                          ; Dec coun
01999    C8FD 26F9                      bne       LC8F2               ; if not a
02000                    
02001    C8FF 97EB                      sta       <DosLastDrive       ; Save cur
02002                    
02003                    ; Note in disassembled source, the following was LDU #$
02004                    ; This makes no sense, and is Drv0Details, in DragonDos
02005                    ; bug !!!!!!
02006                    
02007    C901 CE061C                    ldu       #Drv0Details        ; Get driv
02008    C904 C606                      ldb       #$06                ; 6 bytes/
02009    C906 3D                        mul       
02010    C907 33CB                      leau      D,U                 ; Point at
02011    C909 6C45                      inc       5,U                 ; Incremen



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 031


02012                    
02013    C90B C613                      ldb       #$13                ; Clear re
02014    C90D 6FA0       LC907          clr       ,Y+
02015    C90F 5A                        decb                          ; Dec coun
02016    C910 26FB                      bne       LC907               ; Loop if 
02017                    
02018    C912 8680                      lda       #$80
02019    C914 A70F                      sta       15,X
02020    C916 7F0681                    clr       $0681
02021    C919 BDD1A9                    jsr       >DosGetDiskGeometry
02022    C91C 26D2                      bne       LC8EA
02023    C91E 10AE84                    ldy       ,X
02024    C921 3122                      leay      2,Y
02025    C923 8610                      lda       #$10
02026    C925 B70660                    sta       DosCurCount
02027                    
02028    C928 10BF065C   LC922          sty       $065C
02029    C92C BDD27C                    jsr       >SuperDosFindAndRead
02030    C92F 26BF                      bne       LC8EA
02031    C931 AE05                      ldx       5,X
02032    C933 338900FA                  leau      $00FA,X
02033    C937 FF065E                    stu       $065E
02034    C93A A684       LC934          lda       ,X
02035    C93C 8581                      bita      #$81
02036    C93E 261A                      bne       LC954
02037    C940 FC0650                    ldd       DosCurDriveInfo
02038    C943 10A301                    cmpd      1,X
02039    C946 2612                      bne       LC954
02040    C948 CE0652                    ldu       #$0652
02041    C94B 3103                      leay      3,X
02042    C94D C609                      ldb       #$09
02043    C94F A6C0       LC949          lda       ,U+
02044    C951 A1A0                      cmpa      ,Y+
02045    C953 2605                      bne       LC954
02046    C955 5A                        decb      
02047    C956 26F7                      bne       LC949
02048    C958 202C                      bra       LC980
02049                    
02050    C95A A684       LC954          lda       ,X
02051    C95C 8508                      bita      #$08
02052    C95E 2616                      bne       LC970
02053    C960 7C0681                    inc       $0681
02054    C963 308819                    leax      $19,X
02055    C966 BC065E                    cmpx      $065E
02056    C969 25CF                      bcs       LC934
02057    C96B 10BE065C                  ldy       $065C
02058    C96F 3121                      leay      1,Y
02059    C971 7A0660                    dec       DosCurCount
02060    C974 26B2                      bne       LC922
02061    C976 BDCED8     LC970          jsr       >DosFCBNoToAddr
02062    C979 5F         LC973          clrb      
02063    C97A 6D0F                      tst       15,X
02064    C97C 2A02                      bpl       LC97A
02065    C97E C6A0                      ldb       #$A0
02066    C980 300C       LC97A          leax      12,X
02067    C982 96F1                      lda       <DosCurrCtrlBlk
02068    C984 5D                        tstb      
02069    C985 39                        rts       
02070                    
02071    C986 3410       LC980          pshs      X



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 032


02072    C988 BDCED8                    jsr       >DosFCBNoToAddr
02073    C98B 3520                      puls      Y
02074    C98D B60681                    lda       $0681
02075    C990 A7881D                    sta       $1D,X
02076    C993 A6A4                      lda       ,Y
02077    C995 A70F                      sta       15,X
02078    C997 EC2C                      ldd       12,Y
02079    C999 ED8815                    std       $15,X
02080    C99C A62E                      lda       14,Y
02081    C99E A78817                    sta       $17,X
02082    C9A1 A78819                    sta       $19,X
02083    C9A4 6F8818                    clr       $18,X
02084    C9A7 6F8813                    clr       $13,X
02085    C9AA 6F8814                    clr       $14,X
02086    C9AD EC2F                      ldd       15,Y
02087    C9AF ED881A                    std       $1A,X
02088    C9B2 A6A811                    lda       $11,Y
02089    C9B5 A7881C                    sta       $1C,X
02090    C9B8 CCFFFF                    ldd       #$FFFF
02091    C9BB ED8810                    std       $10,X
02092    C9BE A78812                    sta       $12,X
02093    C9C1 20B6                      bra       LC973
02094                    
02095                    ;
02096                    ; Read some data from a file into memory
02097                    ;
02098                    
02099                    SuperDosFRead            
02100    C9C3 0FF5                      clr       <DosIRQTimeFlag
02101    C9C5 97F1                      sta       <DosCurrCtrlBlk
02102    C9C7 2007                      bra       LC9CA
02103                    
02104    C9C9 8601       LC9C3          lda       #$01
02105                    
02106    C9CB 8C                        fcb       Skip2
02107                    
02108    C9CC 86FF       LC9C6          lda       #$FF
02109    C9CE 97F5                      sta       <DosIRQTimeFlag
02110    C9D0 10BF0661   LC9CA          sty       $0661
02111    C9D4 102700DE                  lbeq      LCAB0
02112    C9D8 FF0669                    stu       $0669
02113    C9DB F70663                    stb       $0663
02114    C9DE 3410                      pshs      X
02115    C9E0 BDCED8                    jsr       >DosFCBNoToAddr
02116    C9E3 A60B                      lda       11,X
02117    C9E5 97EB                      sta       <DosLastDrive
02118    C9E7 0DF5                      tst       <DosIRQTimeFlag
02119    C9E9 260B                      bne       LC9F0
02120    C9EB FC0661                    ldd       $0661
02121    C9EE E30D                      addd      13,X
02122    C9F0 2402                      bcc       LC9EE
02123    C9F2 6C0C                      inc       12,X
02124    C9F4 ED0D       LC9EE          std       13,X
02125    C9F6 3510       LC9F0          puls      X
02126    C9F8 F60663                    ldb       $0663
02127    C9FB 4F         LC9F5          clra      
02128    C9FC 50                        negb      
02129    C9FD 2601                      bne       LC9FA
02130    C9FF 4C                        inca      
02131    CA00 10B30661   LC9FA          cmpd      $0661



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 033


02132    CA04 2303                      bls       LCA03
02133    CA06 FC0661                    ldd       $0661
02134    CA09 3416       LCA03          pshs      D,X
02135    CA0B FE0669                    ldu       $0669
02136    CA0E BDCAB8                    jsr       >LCAB2
02137    CA11 260E                      bne       LCA1B
02138    CA13 1F02                      tfr       D,Y
02139    CA15 A60F                      lda       15,X
02140    CA17 8502                      bita      #$02
02141    CA19 2709                      beq       LCA1E
02142    CA1B 0DF5                      tst       <DosIRQTimeFlag
02143    CA1D 2705                      beq       LCA1E
02144    CA1F C698                      ldb       #$98
02145    CA21 3264       LCA1B          leas      4,S
02146    CA23 39                        rts       
02147                    
02148    CA24 AE62       LCA1E          ldx       2,S
02149    CA26 6D61                      tst       1,S
02150    CA28 262A                      bne       LCA4E
02151    CA2A 0DF5                      tst       <DosIRQTimeFlag
02152    CA2C 2707                      beq       LCA2F
02153    CA2E 2A0A                      bpl       LCA34
02154    CA30 BDD336                    jsr       >LD330
02155    CA33 2008                      bra       LCA37
02156                    
02157    CA35 BDD33D     LCA2F          jsr       >SuperDosReadAbsSector
02158    CA38 2003                      bra       LCA37
02159                    
02160    CA3A BDD32D     LCA34          jsr       >SuperDosWriteAbsSector
02161    CA3D 26E2       LCA37          bne       LCA1B
02162    CA3F 6C62                      inc       2,S
02163    CA41 BE0669                    ldx       $0669
02164    CA44 3001                      leax      1,X
02165    CA46 BF0669                    stx       $0669
02166    CA49 7A0661                    dec       $0661
02167    CA4C FC0661                    ldd       $0661
02168    CA4F 3516                      puls      D,X
02169    CA51 26A8                      bne       LC9F5
02170    CA53 39                        rts       
02171                    
02172    CA54 0DF5       LCA4E          tst       <DosIRQTimeFlag
02173    CA56 2B41                      bmi       LCA93
02174    CA58 BDD27C                    jsr       >SuperDosFindAndRead
02175    CA5B 26C4                      bne       LCA1B
02176    CA5D BF0667                    stx       $0667
02177    CA60 10AE62                    ldy       2,S
02178    CA63 F60663                    ldb       $0663
02179    CA66 0DF5                      tst       <DosIRQTimeFlag
02180    CA68 2723                      beq       LCA87
02181    CA6A 86FF                      lda       #$FF
02182    CA6C A702                      sta       2,X
02183    CA6E AE05                      ldx       5,X
02184    CA70 3A                        abx       
02185    CA71 E661                      ldb       1,S
02186    CA73 A6A0       LCA6D          lda       ,Y+
02187    CA75 A780                      sta       ,X+
02188    CA77 5A                        decb      
02189    CA78 26F9                      bne       LCA6D
02190    CA7A 1F10                      tfr       X,D
02191    CA7C 5D                        tstb      



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 034


02192    CA7D 261A                      bne       LCA93
02193    CA7F BE0667                    ldx       $0667
02194    CA82 3420                      pshs      Y
02195    CA84 BDD2E8                    jsr       >LD2E2
02196    CA87 3520                      puls      Y
02197    CA89 2696                      bne       LCA1B
02198    CA8B 200C                      bra       LCA93
02199                    
02200    CA8D AE05       LCA87          ldx       5,X
02201    CA8F 3A                        abx       
02202    CA90 E661                      ldb       1,S
02203    CA92 A680       LCA8C          lda       ,X+
02204    CA94 A7A0                      sta       ,Y+
02205    CA96 5A                        decb      
02206    CA97 26F9                      bne       LCA8C
02207    CA99 BE0669     LCA93          ldx       $0669
02208    CA9C 3001                      leax      1,X
02209    CA9E BF0669                    stx       $0669
02210    CAA1 1F21                      tfr       Y,X
02211    CAA3 FC0661                    ldd       $0661
02212    CAA6 A3E1                      subd      ,S++
02213    CAA8 FD0661                    std       $0661
02214    CAAB 3262                      leas      2,S
02215    CAAD 2707                      beq       LCAB0
02216    CAAF 7F0663                    clr       $0663
02217    CAB2 5F                        clrb      
02218    CAB3 7EC9FB                    jmp       >LC9F5
02219                    
02220    CAB6 5F         LCAB0          clrb      
02221    CAB7 39                        rts       
02222                    
02223    CAB8 BDCED8     LCAB2          jsr       >DosFCBNoToAddr
02224    CABB 1F30       LCAB5          tfr       U,D
02225    CABD A38813                    subd      $13,X
02226    CAC0 250D                      bcs       LCAC9
02227    CAC2 4D                        tsta      
02228    CAC3 260A                      bne       LCAC9
02229    CAC5 E18817                    cmpb      $17,X
02230    CAC8 2405                      bcc       LCAC9
02231    CACA E38815                    addd      $15,X
02232    CACD 2012                      bra       LCADB
02233                    
02234    CACF 1F30       LCAC9          tfr       U,D
02235    CAD1 A38818                    subd      $18,X
02236    CAD4 250E                      bcs       LCADE
02237    CAD6 4D                        tsta      
02238    CAD7 260B                      bne       LCADE
02239    CAD9 E1881C                    cmpb      $1C,X
02240    CADC 2406                      bcc       LCADE
02241    CADE E3881A                    addd      $1A,X
02242    CAE1 1A04       LCADB          orcc      #$04
02243    CAE3 39                        rts       
02244                    
02245    CAE4 3440       LCADE          pshs      U
02246    CAE6 8D3E                      bsr       LCB20
02247    CAE8 260B                      bne       LCAEF
02248    CAEA FC066B                    ldd       $066B
02249    CAED 10B3066D                  cmpd      $066D
02250    CAF1 2204                      bhi       LCAF1
02251    CAF3 C69A                      ldb       #$9A



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 035


02252    CAF5 35C0       LCAEF          puls      U,PC
02253                    
02254    CAF7 E022       LCAF1          subb      2,Y
02255    CAF9 8200                      sbca      #$00
02256    CAFB ED8813                    std       $13,X
02257    CAFE A622                      lda       2,Y
02258    CB00 A78817                    sta       $17,X
02259    CB03 ECA4                      ldd       ,Y
02260    CB05 ED8815                    std       $15,X
02261    CB08 1F20                      tfr       Y,D
02262    CB0A 3440                      pshs      U
02263    CB0C A3E1                      subd      ,S++
02264    CB0E 3540                      puls      U
02265    CB10 C113                      cmpb      #$13
02266    CB12 2410                      bcc       LCB1E
02267    CB14 A625                      lda       5,Y
02268    CB16 A7881C                    sta       $1C,X
02269    CB19 EC23                      ldd       3,Y
02270    CB1B ED881A                    std       $1A,X
02271    CB1E FC066B                    ldd       $066B
02272    CB21 ED8818                    std       $18,X
02273    CB24 2095       LCB1E          bra       LCAB5
02274                    
02275                    ;
02276                    ; Entry : X=Address of a FCB
02277                    ;	  B=File number (on disk), also in $1d,X
02278                    ;
02279                    
02280    CB26 3410       LCB20          pshs      X
02281    CB28 7F066C                    clr       $066C
02282    CB2B 7F066B                    clr       $066B
02283    CB2E FF066D                    stu       $066D
02284    CB31 E6881D                    ldb       FCBDiskFileNo,X
02285    CB34 F70682                    stb       DosCurFileNo
02286    CB37 BDD20A                    jsr       >SuperDosGetDirEntry ; Go get 
02287    CB3A 2646                      bne       LCB7C               ; Error : 
02288    CB3C 1F13                      tfr       X,U
02289    CB3E 3510                      puls      X
02290    CB40 314C                      leay      12,U
02291    CB42 C604                      ldb       #$04
02292    CB44 A6C4       LCB3E          lda       ,U
02293    CB46 8420                      anda      #$20
02294    CB48 2703                      beq       LCB47
02295    CB4A A6C818                    lda       $18,U
02296    CB4D 3406       LCB47          pshs      D
02297    CB4F FC066B     LCB49          ldd       $066B
02298    CB52 EB22                      addb      2,Y
02299    CB54 8900                      adca      #$00
02300    CB56 FD066B                    std       $066B
02301    CB59 10B3066D                  cmpd      $066D
02302    CB5D 2222                      bhi       LCB7B
02303    CB5F 3123                      leay      3,Y
02304    CB61 6A61                      dec       1,S
02305    CB63 26EA                      bne       LCB49
02306    CB65 E6E4                      ldb       ,S
02307    CB67 2716                      beq       LCB79
02308    CB69 3262                      leas      2,S
02309    CB6B F70682                    stb       DosCurFileNo
02310    CB6E 3410                      pshs      X
02311    CB70 BDD20A                    jsr       >SuperDosGetDirEntry



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 036


02312    CB73 1F13                      tfr       X,U
02313    CB75 3510                      puls      X
02314    CB77 260B                      bne       LCB7E
02315    CB79 3141                      leay      1,U
02316    CB7B C607                      ldb       #$07
02317    CB7D 20C5                      bra       LCB3E
02318                    
02319    CB7F 313D       LCB79          leay      -3,Y
02320    CB81 5F         LCB7B          clrb      
02321    CB82 3262       LCB7C          leas      2,S                 ; Drop sta
02322    CB84 39         LCB7E          rts                           ; Return
02323                    
02324                    ;
02325                    ; Write data from memory to file, verify if verify on.
02326                    ;
02327                    
02328                    SuperDosFWrite           
02329    CB85 97F1                      sta       <DosCurrCtrlBlk
02330    CB87 BF0671                    stx       $0671
02331    CB8A FF0673                    stu       $0673
02332    CB8D 10BF0675                  sty       $0675
02333    CB91 F70677                    stb       $0677
02334    CB94 BDCED8                    jsr       >DosFCBNoToAddr
02335    CB97 E60B                      ldb       11,X
02336    CB99 D7EB                      stb       <DosLastDrive
02337    CB9B BDCEA5     LCB95          jsr       >SuperDosGetFLen
02338    CB9E 270E                      beq       LCBA8
02339    CBA0 C19C                      cmpb      #$9C
02340    CBA2 2701                      beq       LCB9F
02341    CBA4 39                        rts       
02342                    
02343    CBA5 96F1       LCB9F          lda       <DosCurrCtrlBlk
02344    CBA7 BDCF40                    jsr       >SuperDosCreateFile
02345    CBAA 26D8                      bne       LCB7E
02346    CBAC 20ED                      bra       LCB95
02347                    
02348    CBAE 11B30675   LCBA8          cmpu      $0675
02349    CBB2 220A                      bhi       LCBB8
02350    CBB4 2505                      bcs       LCBB5
02351    CBB6 B10677                    cmpa      $0677
02352    CBB9 2403                      bcc       LCBB8
02353    CBBB C69A       LCBB5          ldb       #$9A
02354    CBBD 39         LCBB7          rts       
02355                    
02356    CBBE 3402       LCBB8          pshs      A
02357    CBC0 FC0673                    ldd       $0673
02358    CBC3 FB0677                    addb      $0677
02359    CBC6 B90676                    adca      $0676
02360    CBC9 3404                      pshs      B
02361    CBCB 1F89                      tfr       A,B
02362    CBCD B60675                    lda       $0675
02363    CBD0 8900                      adca      #$00
02364    CBD2 3440                      pshs      U
02365    CBD4 A3E1                      subd      ,S++
02366    CBD6 1F98                      tfr       B,A
02367    CBD8 3504                      puls      B
02368    CBDA 2208                      bhi       LCBDE
02369    CBDC 250E                      bcs       LCBE6
02370    CBDE E0E4                      subb      ,S
02371    CBE0 2406                      bcc       LCBE2



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 037


02372    CBE2 2008                      bra       LCBE6
02373                    
02374    CBE4 E0E4       LCBDE          subb      ,S
02375    CBE6 8200                      sbca      #$00
02376    CBE8 8D2E       LCBE2          bsr       LCC12
02377    CBEA 2629                      bne       LCC0F
02378    CBEC 3261       LCBE6          leas      1,S
02379    CBEE F60677                    ldb       $0677
02380    CBF1 BE0671                    ldx       $0671
02381    CBF4 10BE0673                  ldy       $0673
02382    CBF8 FE0675                    ldu       $0675
02383    CBFB BDC9C9                    jsr       >LC9C3
02384    CBFE 26BD                      bne       LCBB7
02385    CC00 7D0608                    tst       DosVerifyFlag
02386    CC03 27B8                      beq       LCBB7
02387    CC05 F60677                    ldb       $0677
02388    CC08 BE0671                    ldx       $0671
02389    CC0B 10BE0673                  ldy       $0673
02390    CC0F FE0675                    ldu       $0675
02391    CC12 7EC9CC                    jmp       >LC9C6
02392                    
02393    CC15 3261       LCC0F          leas      1,S
02394    CC17 39                        rts       
02395                    
02396    CC18 3274       LCC12          leas      -12,S
02397    CC1A EDE4                      std       ,S
02398    CC1C ED6A                      std       10,S
02399    CC1E 8601                      lda       #$01
02400    CC20 97F6                      sta       <DosIOInProgress
02401    CC22 BDD1A9                    jsr       >DosGetDiskGeometry
02402    CC25 102600E5                  lbne      LCD08
02403    CC29 AF68                      stx       8,S
02404    CC2B BDCED8                    jsr       >DosFCBNoToAddr
02405    CC2E E6881E                    ldb       $1E,X
02406    CC31 BDD20A                    jsr       >SuperDosGetDirEntry
02407    CC34 102600D6                  lbne      LCD08
02408    CC38 AF64                      stx       4,S
02409    CC3A FE067F                    ldu       DosCurDirBuff
02410    CC3D 86FF                      lda       #$FF
02411    CC3F A742                      sta       2,U
02412    CC41 4F                        clra      
02413    CC42 E68818                    ldb       $18,X
02414    CC45 2601                      bne       LCC42
02415    CC47 4C                        inca      
02416    CC48 E3E4       LCC42          addd      ,S
02417    CC4A 5D                        tstb      
02418    CC4B 2601                      bne       LCC48
02419    CC4D 4A                        deca      
02420    CC4E EDE4       LCC48          std       ,S
02421    CC50 4D                        tsta      
02422    CC51 102700A1                  lbeq      LCCF0
02423    CC55 C604                      ldb       #$04
02424    CC57 310C                      leay      12,X
02425    CC59 A684                      lda       ,X
02426    CC5B 8501                      bita      #$01
02427    CC5D 2704                      beq       LCC5D
02428    CC5F 3101                      leay      1,X
02429    CC61 C607                      ldb       #$07
02430    CC63 6D22       LCC5D          tst       2,Y
02431    CC65 2614                      bne       LCC75



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 038


02432    CC67 CCFFFF                    ldd       #$FFFF
02433    CC6A ED66                      std       6,S
02434    CC6C 313D                      leay      -3,Y
02435    CC6E 10AF62                    sty       2,S
02436    CC71 AE68                      ldx       8,S
02437    CC73 6D02                      tst       2,X
02438    CC75 1026009B                  lbne      LCD0E
02439    CC79 203E                      bra       LCCB3
02440                    
02441    CC7B 6D22       LCC75          tst       2,Y
02442    CC7D 2705                      beq       LCC7E
02443    CC7F 3123                      leay      3,Y
02444    CC81 5A                        decb      
02445    CC82 26F7                      bne       LCC75
02446    CC84 313D       LCC7E          leay      -3,Y
02447    CC86 ECA4                      ldd       ,Y
02448    CC88 EB22                      addb      2,Y
02449    CC8A 8900                      adca      #$00
02450    CC8C ED66                      std       6,S
02451    CC8E 10AF62                    sty       2,S
02452    CC91 AE68                      ldx       8,S
02453    CC93 6D02                      tst       2,X
02454    CC95 2722                      beq       LCCB3
02455    CC97 EC66                      ldd       6,S
02456    CC99 A303                      subd      3,X
02457    CC9B 272C                      beq       LCCC3
02458    CC9D BDCD5D                    jsr       >LCD57
02459    CCA0 2706                      beq       LCCA2
02460    CCA2 C194                      cmpb      #$94
02461    CCA4 2668                      bne       LCD08
02462    CCA6 206C                      bra       LCD0E
02463                    
02464    CCA8 AE68       LCCA2          ldx       8,S
02465    CCAA 3442                      pshs      A,U
02466    CCAC E602                      ldb       2,X
02467    CCAE AE03                      ldx       3,X
02468    CCB0 BDD041                    jsr       >LD03B
02469    CCB3 3542                      puls      A,U
02470    CCB5 2657                      bne       LCD08
02471    CCB7 2005                      bra       LCCB8
02472                    
02473    CCB9 BDCD5D     LCCB3          jsr       >LCD57
02474    CCBC 2650                      bne       LCD08
02475    CCBE AE68       LCCB8          ldx       8,S
02476    CCC0 EF03                      stu       3,X
02477    CCC2 A702                      sta       2,X
02478    CCC4 11A366                    cmpu      6,S
02479    CCC7 264B                      bne       LCD0E
02480    CCC9 A6E4       LCCC3          lda       ,S
02481    CCCB A102                      cmpa      2,X
02482    CCCD 2502                      bcs       LCCCB
02483    CCCF A602                      lda       2,X
02484    CCD1 10AE62     LCCCB          ldy       2,S
02485    CCD4 3402                      pshs      A
02486    CCD6 AB22                      adda      2,Y
02487    CCD8 2404                      bcc       LCCD8
02488    CCDA 3502                      puls      A
02489    CCDC 2036                      bra       LCD0E
02490                    
02491    CCDE A722       LCCD8          sta       2,Y



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 039


02492    CCE0 A602                      lda       2,X
02493    CCE2 A0E4                      suba      ,S
02494    CCE4 A702                      sta       2,X
02495    CCE6 EC03                      ldd       3,X
02496    CCE8 EBE4                      addb      ,S
02497    CCEA 8900                      adca      #$00
02498    CCEC ED03                      std       3,X
02499    CCEE A661                      lda       1,S
02500    CCF0 A0E0                      suba      ,S+
02501    CCF2 A7E4                      sta       ,S
02502    CCF4 26C3                      bne       LCCB3
02503    CCF6 AE64       LCCF0          ldx       4,S
02504    CCF8 1F13                      tfr       X,U
02505    CCFA BDCED8                    jsr       >DosFCBNoToAddr
02506    CCFD EC6A                      ldd       10,S
02507    CCFF E38811                    addd      $11,X
02508    CD02 2403                      bcc       LCD01
02509    CD04 6C8810                    inc       $10,X
02510    CD07 ED8811     LCD01          std       $11,X
02511    CD0A E7C818                    stb       $18,U
02512    CD0D 5F                        clrb      
02513    CD0E 326C       LCD08          leas      12,S
02514    CD10 0FF6                      clr       <DosIOInProgress
02515    CD12 5D                        tstb      
02516    CD13 39                        rts       
02517                    
02518    CD14 EC62       LCD0E          ldd       2,S
02519    CD16 1F02                      tfr       D,Y
02520    CD18 A364                      subd      4,S
02521    CD1A C113                      cmpb      #$13
02522    CD1C 240B                      bcc       LCD23
02523    CD1E 3123                      leay      3,Y
02524    CD20 10AF62                    sty       2,S
02525    CD23 EC03       LCD1D          ldd       3,X
02526    CD25 EDA4                      std       ,Y
02527    CD27 20A0                      bra       LCCC3
02528                    
02529    CD29 8601       LCD23          lda       #$01
02530    CD2B BDD129                    jsr       >LD123
02531    CD2E 26DE                      bne       LCD08
02532    CD30 10AE64                    ldy       4,S
02533    CD33 A7A818                    sta       $18,Y
02534    CD36 E6A4                      ldb       ,Y
02535    CD38 CA20                      orb       #$20
02536    CD3A E7A4                      stb       ,Y
02537    CD3C C6FF                      ldb       #$FF
02538    CD3E E702                      stb       2,X
02539    CD40 C601                      ldb       #$01
02540    CD42 E7C4                      stb       ,U
02541    CD44 EF64                      stu       4,S
02542    CD46 BDCED8                    jsr       >DosFCBNoToAddr
02543    CD49 A7881E                    sta       $1E,X
02544    CD4C 31C819                    leay      $19,U
02545    CD4F C618                      ldb       #$18
02546    CD51 6FA2       LCD4B          clr       ,-Y
02547    CD53 5A                        decb      
02548    CD54 26FB                      bne       LCD4B
02549    CD56 10AF62                    sty       2,S
02550    CD59 AE68                      ldx       8,S
02551    CD5B 20C6                      bra       LCD1D



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 040


02552                    
02553    CD5D 10FF0601   LCD57          sts       $0601
02554    CD61 3277                      leas      -9,S
02555    CD63 6F64                      clr       4,S
02556    CD65 BDD1A9                    jsr       >DosGetDiskGeometry
02557    CD68 102600F4                  lbne      LCE5A
02558    CD6C 10AE84                    ldy       ,X
02559    CD6F EEE811                    ldu       $11,S
02560    CD72 EF65                      stu       5,S
02561    CD74 3041                      leax      1,U
02562    CD76 270F                      beq       LCD81
02563    CD78 8D3E                      bsr       LCDB2
02564    CD7A 2639                      bne       LCDAF
02565    CD7C 118305A0                  cmpu      #$05A0
02566    CD80 2505                      bcs       LCD81
02567    CD82 CE058E                    ldu       #$058E
02568    CD85 2021                      bra       LCDA2
02569                    
02570    CD87 33A4       LCD81          leau      ,Y
02571    CD89 86FF       LCD83          lda       #$FF
02572    CD8B A7E4                      sta       ,S
02573    CD8D 33C8EE     LCD87          leau      -$12,U
02574    CD90 EF7E                      stu       -2,S
02575    CD92 2B0C                      bmi       LCD9A
02576    CD94 8D22                      bsr       LCDB2
02577    CD96 27F1                      beq       LCD83
02578    CD98 6DE4                      tst       ,S
02579    CD9A 2A19                      bpl       LCDAF
02580    CD9C EFE4                      stu       ,S
02581    CD9E 20ED                      bra       LCD87
02582                    
02583    CDA0 EEE4       LCD9A          ldu       ,S
02584    CDA2 EF7E                      stu       -2,S
02585    CDA4 2A0F                      bpl       LCDAF
02586    CDA6 33A4                      leau      ,Y
02587    CDA8 33C812     LCDA2          leau      $12,U
02588    CDAB 11830B40                  cmpu      #$0B40
02589    CDAF 220A                      bhi       LCDB5
02590    CDB1 8D05                      bsr       LCDB2
02591    CDB3 27F3                      beq       LCDA2
02592    CDB5 7ECE3A     LCDAF          jmp       >LCE34
02593                    
02594    CDB8 7ECE66     LCDB2          jmp       >LCE60
02595                    
02596    CDBB 86FF       LCDB5          lda       #$FF
02597    CDBD A767                      sta       7,S
02598    CDBF A664                      lda       4,S
02599    CDC1 DE8A       LCDBB          ldu       <Misc16BitScratch
02600    CDC3 44                        lsra      
02601    CDC4 2503                      bcs       LCDC3
02602    CDC6 CE05A0                    ldu       #$05A0
02603    CDC9 8DED       LCDC3          bsr       LCDB2
02604    CDCB C6B4                      ldb       #$B4
02605    CDCD A680       LCDC7          lda       ,X+
02606    CDCF 2607                      bne       LCDD2
02607    CDD1 3348                      leau      8,U
02608    CDD3 5A                        decb      
02609    CDD4 26F7                      bne       LCDC7
02610    CDD6 2041                      bra       LCE13
02611                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 041


02612    CDD8 5F         LCDD2          clrb      
02613    CDD9 E768                      stb       8,S
02614    CDDB 3440                      pshs      U
02615    CDDD 5C         LCDD7          incb      
02616    CDDE A680                      lda       ,X+
02617    CDE0 4C                        inca      
02618    CDE1 27FA                      beq       LCDD7
02619    CDE3 E16A                      cmpb      10,S
02620    CDE5 2304                      bls       LCDE5
02621    CDE7 E76A                      stb       10,S
02622    CDE9 EFE4                      stu       ,S
02623    CDEB 301F       LCDE5          leax      -1,X
02624    CDED 8608                      lda       #$08
02625    CDEF 3D                        mul       
02626    CDF0 33CB                      leau      D,U
02627    CDF2 5F         LCDEC          clrb      
02628    CDF3 A680                      lda       ,X+
02629    CDF5 26E6                      bne       LCDD7
02630    CDF7 3348                      leau      8,U
02631    CDF9 1F10                      tfr       X,D
02632    CDFB C1B4                      cmpb      #$B4
02633    CDFD 25F3                      bcs       LCDEC
02634    CDFF 3540                      puls      U
02635    CE01 8D63                      bsr       LCE60
02636    CE03 3348                      leau      8,U
02637    CE05 A684                      lda       ,X
02638    CE07 E668                      ldb       8,S
02639    CE09 C101                      cmpb      #$01
02640    CE0B 2205                      bhi       LCE0C
02641    CE0D 335F       LCE07          leau      -1,U
02642    CE0F 48                        asla      
02643    CE10 24FB                      bcc       LCE07
02644    CE12 48         LCE0C          asla      
02645    CE13 2404                      bcc       LCE13
02646    CE15 335F                      leau      -1,U
02647    CE17 20F9                      bra       LCE0C
02648                    
02649    CE19 C102       LCE13          cmpb      #$02
02650    CE1B 241D                      bcc       LCE34
02651    CE1D E167                      cmpb      7,S
02652    CE1F 2219                      bhi       LCE34
02653    CE21 A667                      lda       7,S
02654    CE23 4C                        inca      
02655    CE24 260A                      bne       LCE2A
02656    CE26 E767                      stb       7,S
02657    CE28 EF65                      stu       5,S
02658    CE2A A664                      lda       4,S
02659    CE2C 8803                      eora      #$03
02660    CE2E 2091                      bra       LCDBB
02661                    
02662    CE30 EE65       LCE2A          ldu       5,S
02663    CE32 8D32                      bsr       LCE60
02664    CE34 2604                      bne       LCE34
02665    CE36 C694                      ldb       #$94
02666    CE38 2026                      bra       LCE5A
02667                    
02668    CE3A 8D2A       LCE34          bsr       LCE60
02669    CE3C 5F                        clrb      
02670    CE3D 5C         LCE37          incb      
02671    CE3E 2717                      beq       LCE51



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 042


02672    CE40 3402                      pshs      A
02673    CE42 43                        coma      
02674    CE43 A484                      anda      ,X
02675    CE45 A784                      sta       ,X
02676    CE47 3502                      puls      A
02677    CE49 48                        asla      
02678    CE4A 2404                      bcc       LCE4A
02679    CE4C 8601                      lda       #$01
02680    CE4E 3001                      leax      1,X
02681    CE50 A584       LCE4A          bita      ,X
02682    CE52 26E9                      bne       LCE37
02683    CE54 1F98                      tfr       B,A
02684                    
02685                    ;LCE51   EQU     *+1
02686                    ;        CMPX    #$86FF
02687                    
02688    CE56 8C                        fcb       Skip2
02689    CE57 86FF       LCE51          lda       #$FF
02690                    
02691    CE59 AE62                      ldx       2,S
02692    CE5B C6FF                      ldb       #$FF
02693    CE5D E702                      stb       2,X
02694    CE5F 5F                        clrb      
02695    CE60 10FE0601   LCE5A          lds       $0601
02696    CE64 5D                        tstb      
02697    CE65 39                        rts       
02698                    
02699    CE66 3460       LCE60          pshs      Y,U
02700    CE68 8601                      lda       #$01
02701    CE6A 118305A0                  cmpu      #$05A0
02702    CE6E 2507                      bcs       LCE71
02703    CE70 3121                      leay      1,Y
02704    CE72 33C9FA60                  leau      $FA60,U
02705    CE76 48                        asla      
02706    CE77 3440       LCE71          pshs      U
02707    CE79 A56C                      bita      12,S
02708    CE7B 260D                      bne       LCE84
02709    CE7D A76C                      sta       12,S
02710    CE7F BDD27C                    jsr       >SuperDosFindAndRead
02711    CE82 26DC                      bne       LCE5A
02712    CE84 AF6A                      stx       10,S
02713    CE86 86FF                      lda       #$FF
02714    CE88 A702                      sta       2,X
02715    CE8A AE6A       LCE84          ldx       10,S
02716    CE8C AE05                      ldx       5,X
02717    CE8E 3506                      puls      D
02718    CE90 44                        lsra      
02719    CE91 56                        rorb      
02720    CE92 44                        lsra      
02721    CE93 56                        rorb      
02722    CE94 44                        lsra      
02723    CE95 56                        rorb      
02724    CE96 A663                      lda       3,S
02725    CE98 8407                      anda      #$07
02726    CE9A CEA672                    ldu       #$A672
02727    CE9D 40                        nega      
02728    CE9E A6C6                      lda       A,U
02729    CEA0 3A                        abx       
02730    CEA1 A584                      bita      ,X
02731    CEA3 35E0                      puls      Y,U,PC



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 043


02732                    
02733                    ;
02734                    ; Get length of a file
02735                    ;
02736                    
02737                    SuperDosGetFLen           
02738    CEA5 97F1                      sta       <DosCurrCtrlBlk
02739    CEA7 8D2F                      bsr       DosFCBNoToAddr
02740    CEA9 6D0F                      tst       15,X
02741    CEAB 2A03                      bpl       LCEAA
02742    CEAD C69C                      ldb       #$9C
02743    CEAF 39         LCEA9          rts       
02744                    
02745    CEB0 A68812     LCEAA          lda       $12,X
02746    CEB3 EE8810                    ldu       $10,X
02747    CEB6 3141                      leay      1,U
02748    CEB8 261C                      bne       LCED0
02749    CEBA BDCB26                    jsr       >LCB20
02750    CEBD 26F0                      bne       LCEA9
02751    CEBF F60682                    ldb       DosCurFileNo
02752    CEC2 E7881E                    stb       $1E,X
02753    CEC5 A6C818     LCEBF          lda       $18,U
02754    CEC8 A78812                    sta       $12,X
02755    CECB FE066B                    ldu       $066B
02756    CECE 4D                        tsta      
02757    CECF 2702                      beq       LCECD
02758    CED1 335F                      leau      -1,U
02759    CED3 EF8810     LCECD          stu       $10,X
02760    CED6 5F         LCED0          clrb      
02761    CED7 39                        rts       
02762                    
02763                    ;
02764                    ; Converts current FCB number in DosCurrCtrlBlk to the 
02765                    ; Exits with :
02766                    ;	X=FCB address
02767                    ; 
02768                    
02769                    DosFCBNoToAddr           
02770    CED8 3406                      pshs      D
02771    CEDA 96F1                      lda       <DosCurrCtrlBlk     ; Get curr
02772    CEDC C61F                      ldb       #DosFCBLength       ; FCB len 
02773    CEDE 3D                        mul                           ; Work out
02774    CEDF 1F01                      tfr       D,X
02775    CEE1 308906BD                  leax      DosFCB0Addr,X       ; Get offs
02776    CEE5 3586                      puls      D,PC
02777                    
02778                    ;
02779                    ; Close all open files.
02780                    ;
02781                    
02782                    SuperDosCloseAll           
02783    CEE7 8609                      lda       #$09
02784    CEE9 97F1                      sta       <DosCurrCtrlBlk
02785    CEEB 8DEB       LCEE5          bsr       DosFCBNoToAddr
02786    CEED A60B                      lda       11,X
02787    CEEF 91EB                      cmpa      <DosLastDrive
02788    CEF1 2604                      bne       LCEF1
02789    CEF3 8D0A                      bsr       LCEF9
02790    CEF5 26B8                      bne       LCEA9
02791    CEF7 0AF1       LCEF1          dec       <DosCurrCtrlBlk



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 044


02792    CEF9 2AF0                      bpl       LCEE5
02793    CEFB 5F         LCEF5          clrb      
02794    CEFC 39                        rts       
02795                    
02796                    ;
02797                    ; Close a single file
02798                    ;
02799                    
02800                    SuperDosCloseFile           
02801    CEFD 97F1                      sta       <DosCurrCtrlBlk
02802    CEFF 8DD7       LCEF9          bsr       DosFCBNoToAddr
02803    CF01 6D84                      tst       ,X
02804    CF03 27F6                      beq       LCEF5
02805    CF05 96EB                      lda       <DosLastDrive
02806    CF07 3402                      pshs      A
02807    CF09 A60B                      lda       11,X
02808    CF0B 97EB                      sta       <DosLastDrive
02809    CF0D 6F84                      clr       ,X
02810    CF0F BDD1A9                    jsr       >DosGetDiskGeometry
02811    CF12 2626                      bne       LCF34
02812    CF14 6D05                      tst       5,X
02813    CF16 2707                      beq       LCF19
02814    CF18 6A05                      dec       5,X
02815    CF1A 2703                      beq       LCF19
02816    CF1C 5F                        clrb      
02817    CF1D 201B                      bra       LCF34
02818                    
02819    CF1F E602       LCF19          ldb       2,X
02820    CF21 270D                      beq       LCF2A
02821    CF23 3410                      pshs      X
02822    CF25 AE03                      ldx       3,X
02823    CF27 BDD041                    jsr       >LD03B
02824    CF2A 3510                      puls      X
02825    CF2C 260C                      bne       LCF34
02826    CF2E 6F02                      clr       2,X
02827    CF30 BDC764     LCF2A          jsr       >SuperDosSyncDir
02828    CF33 CE0696                    ldu       #DosD0Online-1
02829    CF36 96EB                      lda       <DosLastDrive
02830    CF38 6FC6                      clr       A,U
02831    CF3A 3502       LCF34          puls      A
02832    CF3C 97EB                      sta       <DosLastDrive
02833    CF3E 5D                        tstb      
02834    CF3F 39         LCF39          rts       
02835                    
02836                    ;
02837                    ; Create a file, with backup.
02838                    ;
02839                    
02840                    SuperDosCreateFile           
02841    CF40 B7067D                    sta       $067D
02842    CF43 BDCED8                    jsr       >DosFCBNoToAddr
02843    CF46 BF0678                    stx       $0678
02844    CF49 C60C                      ldb       #$0C
02845    CF4B CE0650                    ldu       #DosCurDriveInfo
02846    CF4E A680       LCF48          lda       ,X+
02847    CF50 A7C0                      sta       ,U+
02848    CF52 5A                        decb      
02849    CF53 26F9                      bne       LCF48
02850    CF55 EC5C                      ldd       -4,U
02851    CF57 FD067A                    std       $067A



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 045


02852    CF5A A65E                      lda       -2,U
02853    CF5C B7067C                    sta       $067C
02854    CF5F CC4241                    ldd       #$4241
02855    CF62 ED5C                      std       -4,U
02856    CF64 864B                      lda       #$4B
02857    CF66 A75E                      sta       -2,U
02858    CF68 6D03                      tst       3,X
02859    CF6A 2B2C                      bmi       LCF92
02860    CF6C BDC8AE                    jsr       >SuperDosOpenFile
02861    CF6F C1A0                      cmpb      #$A0
02862    CF71 2707                      beq       LCF74
02863    CF73 5D                        tstb      
02864    CF74 26C9                      bne       LCF39
02865    CF76 8D6D                      bsr       SuperDosDeleteFile
02866    CF78 26C5                      bne       LCF39
02867    CF7A BDCEFF     LCF74          jsr       >LCEF9
02868    CF7D 12                        nop       
02869    CF7E B6067D                    lda       $067D
02870    CF81 6D9F0678                  tst       [$0678]
02871    CF85 2711                      beq       LCF92
02872    CF87 BDD0FD                    jsr       >SuperDosRename
02873    CF8A 2704                      beq       LCF8A
02874    CF8C C19C                      cmpb      #$9C
02875    CF8E 26AF                      bne       LCF39
02876    CF90 B6067D     LCF8A          lda       $067D
02877    CF93 BDCEFD                    jsr       >SuperDosCloseFile
02878    CF96 26A7                      bne       LCF39
02879    CF98 FC067A     LCF92          ldd       $067A
02880    CF9B FD0658                    std       $0658
02881    CF9E B6067C                    lda       $067C
02882    CFA1 B7065A                    sta       $065A
02883    CFA4 BDC8AE                    jsr       >SuperDosOpenFile
02884    CFA7 2704                      beq       LCFA7
02885    CFA9 C1A0                      cmpb      #$A0
02886    CFAB 2692                      bne       LCF39
02887    CFAD 97F1       LCFA7          sta       <DosCurrCtrlBlk
02888    CFAF BDCED8                    jsr       >DosFCBNoToAddr
02889    CFB2 6D0F                      tst       15,X
02890    CFB4 2B03                      bmi       LCFB3
02891    CFB6 C69E                      ldb       #$9E
02892    CFB8 39         LCFB2          rts       
02893                    
02894    CFB9 4F         LCFB3          clra      
02895    CFBA BDD129                    jsr       >LD123
02896    CFBD 26F9                      bne       LCFB2
02897    CFBF BDCED8                    jsr       >DosFCBNoToAddr
02898    CFC2 A7881D                    sta       FCBDiskFileNo,X
02899    CFC5 A7881E                    sta       $1E,X
02900    CFC8 C61C                      ldb       #$1C
02901    CFCA 6F85       LCFC4          clr       B,X
02902    CFCC 5A                        decb      
02903    CFCD C10C                      cmpb      #$0C
02904    CFCF 24F9                      bcc       LCFC4
02905    CFD1 C618                      ldb       #$18
02906    CFD3 6FC5       LCFCD          clr       B,U
02907    CFD5 5A                        decb      
02908    CFD6 2AFB                      bpl       LCFCD
02909    CFD8 3341                      leau      1,U
02910    CFDA C60B                      ldb       #$0B
02911    CFDC A680       LCFD6          lda       ,X+



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 046


02912    CFDE A7C0                      sta       ,U+
02913    CFE0 5A                        decb      
02914    CFE1 26F9                      bne       LCFD6
02915    CFE3 5F                        clrb      
02916    CFE4 39                        rts       
02917                    
02918                    ;
02919                    ; Delete a file from disk.
02920                    ;
02921                    
02922                    SuperDosDeleteFile           
02923    CFE5 BDD0EA                    jsr       >LD0E4
02924    CFE8 26CE                      bne       LCFB2
02925    CFEA 3410                      pshs      X
02926    CFEC E6881D                    ldb       FCBDiskFileNo,X
02927    CFEF BDD23D                    jsr       >LD237
02928    CFF2 2647                      bne       LD035
02929    CFF4 1F13                      tfr       X,U
02930    CFF6 3510                      puls      X
02931    CFF8 314C                      leay      12,U
02932    CFFA C604                      ldb       #$04
02933    CFFC A6C4       LCFF6          lda       ,U
02934    CFFE 8420                      anda      #$20
02935    D000 2703                      beq       LCFFF
02936    D002 A6C818                    lda       $18,U
02937    D005 3406       LCFFF          pshs      D
02938    D007 C681                      ldb       #$81
02939    D009 E7C4                      stb       ,U
02940    D00B 3410                      pshs      X
02941    D00D AEA1       LD007          ldx       ,Y++
02942    D00F E6A0                      ldb       ,Y+
02943    D011 270A                      beq       LD017
02944    D013 3420                      pshs      Y
02945    D015 8D2A                      bsr       LD03B
02946    D017 3520                      puls      Y
02947    D019 1026FA04                  lbne      LCA1B
02948    D01D 6A63       LD017          dec       3,S
02949    D01F 26EC                      bne       LD007
02950    D021 3510                      puls      X
02951    D023 E6E4                      ldb       ,S
02952    D025 2713                      beq       LD034
02953    D027 3262                      leas      2,S
02954    D029 3410                      pshs      X
02955    D02B BDD23D                    jsr       >LD237
02956    D02E 1F13                      tfr       X,U
02957    D030 3510                      puls      X
02958    D032 2684                      bne       LCFB2
02959    D034 3141                      leay      1,U
02960    D036 C607                      ldb       #$07
02961    D038 20C2                      bra       LCFF6
02962                    
02963    D03A 5F         LD034          clrb      
02964    D03B 0FF6       LD035          clr       <DosIOInProgress
02965    D03D 3262                      leas      2,S
02966    D03F 5D                        tstb      
02967    D040 39                        rts       
02968                    
02969    D041 4F         LD03B          clra      
02970    D042 3402                      pshs      A
02971    D044 3416                      pshs      D,X



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 047


02972    D046 BDD1A9                    jsr       >DosGetDiskGeometry
02973    D049 267D                      bne       LD0C2
02974    D04B 10AE84                    ldy       ,X
02975    D04E EC62                      ldd       2,S
02976    D050 8305A0                    subd      #$05A0
02977    D053 250B                      bcs       LD05A
02978    D055 3121                      leay      1,Y
02979    D057 ED62                      std       2,S
02980    D059 E3E4                      addd      ,S
02981    D05B 8305A0                    subd      #$05A0
02982    D05E 2466                      bcc       LD0C0
02983    D060 EC62       LD05A          ldd       2,S
02984    D062 E3E4                      addd      ,S
02985    D064 8305A0                    subd      #$05A0
02986    D067 2507                      bcs       LD06A
02987    D069 E764                      stb       4,S
02988    D06B 50                        negb      
02989    D06C EB61                      addb      1,S
02990    D06E E761                      stb       1,S
02991    D070 BDD27C     LD06A          jsr       >SuperDosFindAndRead
02992    D073 2653                      bne       LD0C2
02993    D075 86FF                      lda       #$FF
02994    D077 A702                      sta       2,X
02995    D079 EC62                      ldd       2,S
02996    D07B 44                        lsra      
02997    D07C 56                        rorb      
02998    D07D 66E4                      ror       ,S
02999    D07F 44                        lsra      
03000    D080 56                        rorb      
03001    D081 66E4                      ror       ,S
03002    D083 44                        lsra      
03003    D084 56                        rorb      
03004    D085 66E4                      ror       ,S
03005    D087 AE05                      ldx       5,X
03006    D089 3A                        abx       
03007    D08A C601                      ldb       #$01
03008    D08C A6E4                      lda       ,S
03009    D08E 2705                      beq       LD08F
03010    D090 58         LD08A          aslb      
03011    D091 8020                      suba      #$20
03012    D093 26FB                      bne       LD08A
03013    D095 E7E4       LD08F          stb       ,S
03014    D097 E661                      ldb       1,S
03015    D099 A6E4       LD093          lda       ,S
03016    D09B AA84                      ora       ,X
03017    D09D A784                      sta       ,X
03018    D09F 5A                        decb      
03019    D0A0 2718                      beq       LD0B4
03020    D0A2 68E4                      asl       ,S
03021    D0A4 24F3                      bcc       LD093
03022    D0A6 8601                      lda       #$01
03023    D0A8 A7E4                      sta       ,S
03024    D0AA 3001                      leax      1,X
03025    D0AC C110       LD0A6          cmpb      #$10
03026    D0AE 25E9                      bcs       LD093
03027    D0B0 86FF                      lda       #$FF
03028    D0B2 A780                      sta       ,X+
03029    D0B4 A780                      sta       ,X+
03030    D0B6 C010                      subb      #$10
03031    D0B8 26F2                      bne       LD0A6



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 048


03032    D0BA 8E05A0     LD0B4          ldx       #$05A0
03033    D0BD 3264                      leas      4,S
03034    D0BF E6E0                      ldb       ,S+
03035    D0C1 2707                      beq       LD0C4
03036    D0C3 7ED041                    jmp       >LD03B
03037                    
03038    D0C6 C690       LD0C0          ldb       #$90
03039    D0C8 3265       LD0C2          leas      5,S
03040    D0CA 39         LD0C4          rts       
03041                    
03042                    ;
03043                    ; Protect/unprotect a file.
03044                    ;
03045                    
03046                    SuperDosProtect           
03047    D0CB 97F1                      sta       <DosCurrCtrlBlk
03048    D0CD BDCED8                    jsr       >DosFCBNoToAddr
03049    D0D0 A60F                      lda       15,X
03050    D0D2 2B26                      bmi       LD0F4
03051    D0D4 5D                        tstb      
03052    D0D5 2703                      beq       LD0D4
03053    D0D7 8A02                      ora       #$02
03054                    
03055                    ;LD0D4   EQU     *+1
03056                    ;        CMPX    #$84FD
03057                    
03058    D0D9 8C                        fcb       Skip2
03059    D0DA 84FD       LD0D4          anda      #$FD
03060                    
03061    D0DC A70F                      sta       15,X
03062    D0DE E6881D                    ldb       FCBDiskFileNo,X
03063    D0E1 BDD23D                    jsr       >LD237
03064    D0E4 26E4                      bne       LD0C4
03065    D0E6 A784                      sta       ,X
03066    D0E8 5F                        clrb      
03067    D0E9 39                        rts       
03068                    
03069    D0EA 97F1       LD0E4          sta       <DosCurrCtrlBlk
03070    D0EC BDCED8                    jsr       >DosFCBNoToAddr
03071    D0EF A60F                      lda       15,X
03072    D0F1 2B07                      bmi       LD0F4
03073    D0F3 8502                      bita      #$02
03074    D0F5 2731                      beq       LD122
03075    D0F7 C698                      ldb       #$98
03076    D0F9 39                        rts       
03077                    
03078    D0FA C69C       LD0F4          ldb       #$9C
03079    D0FC 39                        rts       
03080                    
03081                    ;
03082                    ; Rename a file.
03083                    ;
03084                    
03085                    SuperDosRename           
03086    D0FD 8DEB                      bsr       LD0E4
03087    D0FF 2627                      bne       LD122
03088    D101 C60B                      ldb       #$0B
03089    D103 CE0650                    ldu       #DosCurDriveInfo
03090    D106 A6C0       LD100          lda       ,U+
03091    D108 A780                      sta       ,X+



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 049


03092    D10A 5A                        decb      
03093    D10B 26F9                      bne       LD100
03094    D10D 3015                      leax      -11,X
03095    D10F E6881D                    ldb       FCBDiskFileNo,X
03096    D112 BDD23D                    jsr       >LD237
03097    D115 2611                      bne       LD122
03098    D117 CE0650                    ldu       #DosCurDriveInfo
03099    D11A C60B                      ldb       #$0B
03100    D11C 3001                      leax      1,X
03101    D11E A6C0       LD118          lda       ,U+
03102    D120 A780                      sta       ,X+
03103    D122 5A                        decb      
03104    D123 26F9                      bne       LD118
03105    D125 0FF6                      clr       <DosIOInProgress
03106    D127 5F                        clrb      
03107    D128 39         LD122          rts       
03108                    
03109    D129 5F         LD123          clrb      
03110    D12A FD067D                    std       $067D
03111    D12D 8D7A                      bsr       DosGetDiskGeometry
03112    D12F 26F7                      bne       LD122
03113    D131 AE84                      ldx       ,X
03114    D133 3410                      pshs      X
03115    D135 3002                      leax      2,X
03116    D137 BF066F     LD131          stx       DosCurLSN
03117    D13A 1F12                      tfr       X,Y
03118    D13C BDD27C                    jsr       >SuperDosFindAndRead
03119    D13F 2635                      bne       LD170
03120    D141 EE05                      ldu       5,X
03121    D143 C60A                      ldb       #$0A
03122    D145 7D067D                    tst       $067D
03123    D148 2705                      beq       LD149
03124    D14A 7F067D                    clr       $067D
03125    D14D 2004                      bra       LD14D
03126                    
03127    D14F A6C4       LD149          lda       ,U
03128    D151 2B1B                      bmi       LD168
03129    D153 7C067E     LD14D          inc       $067E
03130    D156 33C819                    leau      $19,U
03131    D159 5A                        decb      
03132    D15A 26F3                      bne       LD149
03133    D15C BDDFF1                    jsr       >LDFF3
03134    D15F 3001                      leax      1,X
03135    D161 1F10                      tfr       X,D
03136    D163 A3E4                      subd      ,S
03137    D165 C112                      cmpb      #$12
03138    D167 25CE                      bcs       LD131
03139    D169 3262                      leas      2,S
03140    D16B C692                      ldb       #$92
03141    D16D 39                        rts       
03142                    
03143    D16E 86FF       LD168          lda       #$FF
03144    D170 A702                      sta       2,X
03145    D172 B6067E                    lda       $067E
03146    D175 5F                        clrb      
03147    D176 3262       LD170          leas      2,S
03148    D178 39                        rts       
03149                    
03150                    ;
03151                    ; Get free space on disk



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 050


03152                    ;
03153                    
03154                    SuperDosGetFree           
03155    D179 8D2E                      bsr       DosGetDiskGeometry
03156    D17B 2610                      bne       LD187
03157    D17D 10AE84                    ldy       ,X
03158    D180 9E8A                      ldx       <Misc16BitScratch
03159    D182 8D0A                      bsr       LD188
03160    D184 2607                      bne       LD187
03161    D186 3121                      leay      1,Y
03162    D188 8D04                      bsr       LD188
03163    D18A 2601                      bne       LD187
03164    D18C 5F                        clrb      
03165    D18D 39         LD187          rts       
03166                    
03167    D18E 3410       LD188          pshs      X
03168    D190 BDD27C                    jsr       >SuperDosFindAndRead
03169    D193 26E1                      bne       LD170
03170    D195 EE05                      ldu       5,X
03171    D197 3510                      puls      X
03172    D199 C6B4                      ldb       #$B4
03173    D19B A6C0       LD195          lda       ,U+
03174    D19D 44         LD197          lsra      
03175    D19E 2402                      bcc       LD19C
03176    D1A0 3001                      leax      1,X
03177    D1A2 4D         LD19C          tsta      
03178    D1A3 26F8                      bne       LD197
03179    D1A5 5A                        decb      
03180    D1A6 26F3                      bne       LD195
03181    D1A8 39                        rts       
03182                    
03183                    ;
03184                    ; Get geometry for a disk and set the apropreate low me
03185                    ;
03186                    ; Entry : DosLastDrive, set to last drive
03187                    ;
03188                    ; Exit  : Drive vars setup in low ram, to be same as di
03189                    ;	  X=Address of buffer detail entry for buffer to use
03190                    
03191                    DosGetDiskGeometry           
03192    D1A9 8E061C                    ldx       #Drv0Details        ; Point at
03193    D1AC CE0696                    ldu       #DosD0Online-1      ; Point at
03194    D1AF C606                      ldb       #DrvDeatailLen      ; Get driv
03195    D1B1 96EB                      lda       <DosLastDrive       ; Get last
03196    D1B3 33C6                      leau      A,U                 ; Point U 
03197    D1B5 4A                        deca                          ; Make zer
03198    D1B6 3D                        mul                           ; Calculat
03199    D1B7 308B                      leax      D,X
03200    D1B9 6DC4                      tst       ,U                  ; Is drive
03201    D1BB 2648                      bne       LD1FF               ; Yes : ex
03202                    
03203    D1BD 108E0168                  ldy       #SectorsPerTrack*DirPrimary ; 
03204    D1C1 8612                      lda       #SectorsPerTrack    ; Set sect
03205    D1C3 A7C810                    sta       $10,U               ; Set it
03206    D1C6 6D4C                      tst       $0C,U               ; Do we kn
03207    D1C8 2606                      bne       LD1CA               ; Yes : sk
03208                    
03209    D1CA BDC164                    jsr       >DosDoRestore       ; No, do r
03210    D1CD 2401                      bcc       LD1CA               ; no error
03211    D1CF 39                        rts       



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 051


03212                    
03213    D1D0 3410       LD1CA          pshs      X                   ; Save dri
03214    D1D2 BDD27C                    jsr       >SuperDosFindAndRead ; Find fr
03215    D1D5 269F                      bne       LD170               ; Error : 
03216                    
03217                    ; At this point X points to buffer details ???
03218                    
03219    D1D7 6F02                      clr       BuffFlag,X          ; Reset bu
03220    D1D9 AE05                      ldx       BuffAddr,X          ; Get addr
03221    D1DB EC8900FE                  ldd       DirTracks1s,X       ; Get comp
03222    D1DF 43                        coma                          ; Compleme
03223    D1E0 53                        comb      
03224    D1E1 10A38900                  cmpd      DirTracks,X         ; compare 
03225    D1E6 3510                      puls      X                   ; restore 
03226    D1E8 261D                      bne       LD201               ; Not the 
03227                    
03228    D1EA E7C810                    stb       $10,U               ; Set Sect
03229    D1ED A74C                      sta       $0C,U               ; Set trac
03230    D1EF 6AC4                      dec       ,U                  ; Mark dri
03231    D1F1 C112                      cmpb      #$12                ; Disk sin
03232    D1F3 2701                      beq       LD1F0               ; yes : sk
03233                    
03234    D1F5 5F                        clrb                          ; zero it
03235    D1F6 3404       LD1F0          pshs      B                   ; save it
03236    D1F8 6F02                      clr       BuffFlag,X          ; Clear bu
03237    D1FA CC0168                    ldd       #SectorsPerTrack*DirPrimary ; 
03238    D1FD 6DE0                      tst       ,S+                 ; Do we ne
03239    D1FF 2602                      bne       LD1FD               ; yes : sk
03240    D201 58                        aslb                          ; Multiply
03241    D202 49                        rola      
03242    D203 ED84       LD1FD          std       ,X                  ; save it
03243    D205 5F         LD1FF          clrb                          ; No error
03244    D206 39                        rts                           ; Return
03245                    
03246    D207 C690       LD201          ldb       #$90                ; Flag err
03247    D209 39                        rts       
03248                    
03249                    ;
03250                    ; Get directory entry.
03251                    ;
03252                    ; Entry : B= File number(on disk) to get entry for???
03253                    ;
03254                    ; Exit  : X=Pointer to required Dir entry.
03255                    ;
03256                    
03257                    SuperDosGetDirEntry           
03258    D20A 86FF                      lda       #$FF                ; Init sec
03259    D20C 4C         LD206          inca                          ; incremen
03260    D20D C00A                      subb      #DirEntPerSec       ; Decremen
03261    D20F 24FB                      bcc       LD206               ; Done all
03262                    
03263    D211 CB0A                      addb      #DirEntPerSec       ; Compensa
03264                    
03265                    ; At this point A contains the sector number within the
03266                    ; and B contains the entry within that sector of the fi
03267                    
03268    D213 3406                      pshs      D                   ; Save the
03269    D215 8D92                      bsr       DosGetDiskGeometry  ; Setup di
03270    D217 1026F967                  lbne      LCB7C               ; Error : 
03271                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 052


03272    D21B EC84                      ldd       ,X                  ; Get LSN 
03273    D21D C30002                    addd      #$0002              ; Advance 
03274    D220 EBE0                      addb      ,S+                 ; Add sect
03275    D222 8900                      adca      #$00                ; Deal wit
03276    D224 FD066F                    std       DosCurLSN           ; Save LSN
03277    D227 1F02                      tfr       D,Y                 ; Get LSN 
03278    D229 8D51                      bsr       SuperDosFindAndRead ; Find fre
03279    D22B 3502                      puls      A                   ; Retrieve
03280                    
03281    D22D 260D                      bne       LD236               ; Error: e
03282    D22F 1F13                      tfr       X,U
03283    D231 C619                      ldb       #$19                ; Length o
03284    D233 3D                        mul                           ; Calculat
03285    D234 BF067F                    stx       DosCurDirBuff       ; Saave bl
03286    D237 AE05                      ldx       BuffAddr,X          ; Get poin
03287    D239 308B                      leax      D,X                 ; Get offs
03288    D23B 5F                        clrb                          ; Flag no 
03289    D23C 39         LD236          rts       
03290                    
03291    D23D 3406       LD237          pshs      D
03292    D23F 8DC9                      bsr       SuperDosGetDirEntry ; Get dire
03293    D241 1026F93D                  lbne      LCB7C               ; Error :
03294    D245 10BE067F                  ldy       DosCurDirBuff       ; Get Buff
03295    D249 86FE                      lda       #$FE                ; Set flag
03296    D24B A722                      sta       BuffFlag,Y
03297    D24D 5F                        clrb                          ; Flag no 
03298    D24E 3586                      puls      D,PC                ; Restore 
03299                    
03300                    ;
03301                    ; Find a free disk buffer.
03302                    ;
03303                    ; Entry	: Y=??
03304                    ;
03305                    ; Exits : U=pointer to detail entry for free buffer.
03306                    ;	  B=Error code
03307                    ;
03308                    
03309                    FindFreeBuffer           
03310    D250 8E0634                    ldx       #Buff1Details       ; Point at
03311    D253 DE8A                      ldu       <Misc16BitScratch   ; Load U w
03312    D255 C604                      ldb       #BuffCount          ; 4 Disk b
03313    D257 A602       LD251          lda       BuffFlag,X          ; Get buff
03314    D259 2717                      beq       LD26C               ; Zero ?
03315                    
03316    D25B 8155                      cmpa      #BuffInUse          ; Is buffe
03317    D25D 2715                      beq       LD26E               ; Yes, try
03318    D25F 10AC84                    cmpy      ,X
03319    D262 260A                      bne       LD268
03320                    
03321    D264 96EB                      lda       <DosLastDrive       ; Get last
03322    D266 A103                      cmpa      BuffDrive,X         ; Is this 
03323    D268 2604                      bne       LD268               ; nope, sk
03324    D26A 8D65                      bsr       MakeBuffYoungest    ; Make thi
03325    D26C 5F                        clrb                          ; Flag no 
03326    D26D 39                        rts       
03327                    
03328    D26E 6D02       LD268          tst       BuffFlag,X          ; Is buffe
03329    D270 2602                      bne       LD26E               ; nope, lo
03330    D272 1F13       LD26C          tfr       X,U                 ; Select t
03331    D274 3007       LD26E          leax      BuffDetailSize,X    ; move on 



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 053


03332    D276 5A                        decb                          ; Decremen
03333    D277 26DE                      bne       LD251               ; Any more
03334    D279 C6FF                      ldb       #$FF                ; Flag err
03335    D27B 39                        rts       
03336                    
03337                    ;
03338                    ; Find a free buffer and read sector.
03339                    ;
03340                    ; Entry : 
03341                    ;	  Y= ???
03342                    ;	  U= ???
03343                    ;
03344                    
03345                    SuperDosFindAndRead           
03346    D27C 3440                      pshs      U
03347    D27E 8DD0                      bsr       FindFreeBuffer      ; Find fre
03348    D280 1027F8FE                  lbeq      LCB7C
03349    D284 30C4                      leax      ,U                  ; Make X p
03350    D286 3540                      puls      U
03351    D288 2604                      bne       LD288
03352    D28A 8D1C                      bsr       FindFreeDiskBuffer  ; Find buf
03353    D28C 2619                      bne       LD2A1               ; Error : 
03354                    
03355    D28E 6F02       LD288          clr       BuffFlag,X          ; Make buf
03356    D290 10AF84                    sty       ,X
03357    D293 96EB                      lda       <DosLastDrive       ; Get last
03358    D295 A703                      sta       BuffDrive,X         ; Set this
03359    D297 3410                      pshs      X                   ; Save buf
03360    D299 AE05                      ldx       BuffAddr,X          ; Get addr
03361    D29B BDD33D                    jsr       >SuperDosReadAbsSector ; Read 
03362    D29E 3510                      puls      X                   ; Restore 
03363    D2A0 2605                      bne       LD2A1               ; Error : 
03364                    
03365    D2A2 8601                      lda       #$01                ; Set flag
03366    D2A4 A702                      sta       BuffFlag,X
03367    D2A6 5F                        clrb                          ; No error
03368    D2A7 39         LD2A1          rts       
03369                    
03370                    ;
03371                    ; Find least recently used disk buffer, if none, and th
03372                    ; a dirty buffer, then flush it and use that one.
03373                    ;
03374                    ; Exit : X=pointer to buffer info block.
03375                    ;
03376                    
03377                    FindFreeDiskBuffer           
03378    D2A8 3466                      pshs      D,Y,U
03379    D2AA 8E0634     LD2A4          ldx       #Buff1Details       ; Point to
03380    D2AD C604                      ldb       #$04                ; Check 4 
03381    D2AF A604       LD2A9          lda       BuffAge,X           ; Get buff
03382    D2B1 8101                      cmpa      #$01                ; Oldest ?
03383    D2B3 2705                      beq       LD2B4               ; Yes go p
03384    D2B5 3007                      leax      7,X                 ; Do next 
03385    D2B7 5A                        decb                          ; Decremen
03386    D2B8 26F5                      bne       LD2A9               ; More : d
03387                    
03388    D2BA 8D15       LD2B4          bsr       MakeBuffYoungest    ; Adjust a
03389    D2BC A602                      lda       BuffFlag,X          ; Get buff
03390    D2BE 8155                      cmpa      #$55                ; In use ?
03391    D2C0 27E8                      beq       LD2A4               ; yes, sel



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 054


03392    D2C2 4C                        inca                          ; Check fo
03393    D2C3 2604                      bne       LD2C3               ; no : ski
03394    D2C5 6A02                      dec       BuffFlag,X          ; yes, sel
03395    D2C7 20E1                      bra       LD2A4
03396                    
03397    D2C9 8D1D       LD2C3          bsr       LD2E2               ; Check fo
03398    D2CB 2702                      beq       LD2C9               ; No error
03399    D2CD E761                      stb       1,S                 ; Flag err
03400    D2CF 35E6       LD2C9          puls      D,Y,U,PC            ; restore 
03401                    
03402                    MakeBuffYoungest           
03403    D2D1 C604                      ldb       #BuffCount          ; Process 
03404    D2D3 A604                      lda       BuffAge,X           ; Get curr
03405    D2D5 CE0634                    ldu       #Buff1Details       ; Point to
03406    D2D8 A144       LD2D2          cmpa      BuffAge,U           ; Compare 
03407    D2DA 2202                      bhi       LD2D8               ; higher ?
03408    D2DC 6A44                      dec       BuffAge,U           ; Decremen
03409                    
03410    D2DE 3347       LD2D8          leau      BuffDetailSize,U    ; Do next 
03411    D2E0 5A                        decb                          ; Decremen
03412    D2E1 26F5                      bne       LD2D2               ; More : d
03413    D2E3 8604                      lda       #$04                ; Mark thi
03414    D2E5 A704                      sta       BuffAge,X
03415    D2E7 39                        rts       
03416                    
03417    D2E8 6D02       LD2E2          tst       BuffFlag,X          ; Buffer d
03418    D2EA 2B02                      bmi       FlushBuffer         ; Yes, flu
03419    D2EC 5F                        clrb                          ; No error
03420    D2ED 39                        rts       
03421                    
03422                    FlushBuffer              
03423    D2EE 96EB                      lda       <DosLastDrive       ; Get last
03424    D2F0 3402                      pshs      A                   ; save it 
03425    D2F2 3410                      pshs      X                   ; Save buf
03426    D2F4 86FF                      lda       #$FF                ; Flag Dos
03427    D2F6 97F6                      sta       <DosIOInProgress
03428    D2F8 6F02                      clr       2,X                 ; Flag buf
03429    D2FA A603                      lda       3,X                 ; Get driv
03430    D2FC 97EB                      sta       <DosLastDrive       ; Save in 
03431    D2FE 10AE84                    ldy       ,X                  ; get LSN 
03432    D301 AE05                      ldx       5,X                 ; Get buff
03433    D303 8D28                      bsr       SuperDosWriteAbsSector ; Write
03434    D305 3510                      puls      X                   ; Retrieve
03435    D307 261C                      bne       LD31F               ; no error
03436    D309 96EC                      lda       <DskTrackNo         ; Get curr
03437    D30B 8114                      cmpa      #$14                ; track 20
03438    D30D 2611                      bne       LD31A               ; no : ski
03439                    
03440                    ;
03441                    ; I do not have a clue why this code does this, it seem
03442                    ; the basic rom do some stuff to it and update the Dire
03443                    ; with it !
03444                    ; 
03445                    ; Looking at $A673, the 8 bytes before it are $80,$40,$
03446                    ; This is the 2 colour pixel mask table, but is a conve
03447                    ; number to the bit it represents.
03448                    ;
03449                    
03450    D30F CE92E5                    ldu       #PixMaskTable4Col   ; This for
03451    D312 96EB                      lda       <DosLastDrive       ; get last



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 055


03452    D314 40                        nega      
03453    D315 A6C6                      lda       A,U
03454                    
03455    D317 CE06AA                    ldu       #DosDirSecStatus-1  ; Point to
03456    D31A D6ED                      ldb       <DskSectorNo        ; get sect
03457    D31C AAC5                      ora       B,U                 ; Put a by
03458    D31E A7C5                      sta       B,U
03459                    
03460    D320 8601       LD31A          lda       #$01                ; Mark buf
03461    D322 A702                      sta       BuffFlag,X
03462    D324 5F                        clrb      
03463    D325 3502       LD31F          puls      A
03464    D327 97EB                      sta       <DosLastDrive       ; Restore 
03465    D329 0FF6                      clr       <DosIOInProgress    ; Mark no 
03466    D32B 5D                        tstb      
03467    D32C 39                        rts       
03468                    
03469                    ;
03470                    ; Write absolute sector.
03471                    ;
03472                    ; Entry	:    X=Address to store data
03473                    ;	     Y=LSN to read
03474                    ;	 $00EA=Drive number
03475                    ;
03476                    
03477                    SuperDosWriteAbsSector           
03478    D32D 8D15                      bsr       CalcTrackFromLSN    ; Setup di
03479    D32F BDC0FE                    jsr       >DosDoWriteSec2
03480    D332 9EEE       LD32C          ldx       <DiskBuffPtr        ; Restore 
03481    D334 5D                        tstb                          ; Test for
03482    D335 39                        rts                           ; return t
03483                    
03484    D336 8D0C       LD330          bsr       CalcTrackFromLSN    ; Setup di
03485    D338 BDC15E                    jsr       >DosDoReadSec2
03486    D33B 20F5                      bra       LD32C
03487                    
03488                    ;
03489                    ; Read absolute sector.
03490                    ;
03491                    ; Entry	:    X=Address to store data
03492                    ;	     Y=LSN to read
03493                    ;	 $00EA=Drive number
03494                    ;
03495                    
03496                    SuperDosReadAbsSector           
03497    D33D 8D05                      bsr       CalcTrackFromLSN    ; Setup di
03498    D33F BDC104                    jsr       >DosDoReadSec       ; Go read 
03499    D342 20EE                      bra       LD32C               ; Return t
03500                    
03501                    ;
03502                    ; Calculate track from Logical sector number.
03503                    ;
03504                    ; Entry : X=Buffer pointer
03505                    ;	  Y=LSN to read/write
03506                    ;
03507                    ; Exit  : D=Disk track no, Low ram vars also set.
03508                    ;
03509                    
03510                    CalcTrackFromLSN           
03511    D344 9FEE                      stx       <DiskBuffPtr        ; Save in 



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 056


03512    D346 8E06A6                    ldx       #DosD0SecTrack-1    ; Point to
03513    D349 D6EB                      ldb       <DosLastDrive       ; Get last
03514    D34B E685                      ldb       B,X                 ; Get Sec/
03515    D34D 4F                        clra      
03516    D34E 3406                      pshs      D                   ; Save it
03517    D350 6FE2                      clr       ,-S                 ; Make roo
03518    D352 1F20                      tfr       Y,D                 ; Get LSN 
03519                    
03520                    ; Calculate which track we need
03521                    
03522    D354 6CE4       LD34E          inc       ,S                  ; Inc trac
03523    D356 A361                      subd      1,S                 ; Decremen
03524    D358 2AFA                      bpl       LD34E               ; keep loo
03525                    
03526    D35A EB62                      addb      2,S                 ; Compensa
03527    D35C A6E4                      lda       ,S                  ; Get trac
03528    D35E 4A                        deca                          ; Compensa
03529    D35F 5C                        incb      
03530    D360 3263                      leas      3,S                 ; Drop sta
03531    D362 DDEC                      std       <DskTrackNo         ; Save tra
03532    D364 39                        rts       
03533                    
03534                    ;
03535                    ; Copy command dispatch routine
03536                    ;
03537                    ; Syntax :
03538                    ;	COPY filespec TO filespec	
03539                    ;
03540                    ; Stack setup as follows 
03541                    ;
03542                    ; offset	size 	purpose
03543                    ; 0		1	Source FCB number
03544                    ; 1		1	Destination FCB number
03545                    ; 2		2	Buffer pointer ?
03546                    ; 4		3	File pointer pos
03547                    ;
03548                    
03549                    CmdCopy                  
03550    D365 BDCEE7                    jsr       >SuperDosCloseAll   ; Close al
03551    D368 263B                      bne       LD39F               ; Error : 
03552    D36A 3279                      leas      -7,S                ; Make roo
03553                    
03554                    ;
03555                    ; Make a buffer for copying the file.
03556                    ;
03557                    
03558    D36C 1F40                      tfr       S,D                 ; move to 
03559    D36E 830100                    subd      #$0100              ; Make roo
03560    D371 931F                      subd      <BasVarEnd          ; Will we 
03561    D373 102BD8CD                  lbmi      BasOMError          ; yes : er
03562                    
03563    D377 5F                        clrb      
03564    D378 4D                        tsta                          ; overwrit
03565    D379 1027D8C7                  lbeq      BasOMError          ; yes : er
03566    D37D ED62                      std       2,S                 ; IO buffe
03567    D37F BDD6D7                    jsr       >DosGetFilenameAndOpen ; Get s
03568    D382 2621                      bne       LD39F               ; Error : 
03569    D384 A7E4                      sta       ,S                  ; save FCB
03570                    
03571    D386 BDCEA5                    jsr       >SuperDosGetFLen    ; Get file



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 057


03572    D389 261A                      bne       LD39F               ; Error : 
03573    D38B 9DA5                      jsr       <BasChrGetCurr      ; scan cur
03574    D38D 81BC                      cmpa      #$BC                ; "TO" tok
03575    D38F 1026DEE4                  lbne      BasSNError          ; no : Err
03576                    
03577    D393 9D9F                      jsr       <BasChrGet          ; Get next
03578    D395 BDD6D7                    jsr       >DosGetFilenameAndOpen ; Get d
03579    D398 2704                      beq       LD398               ; No error
03580    D39A C1A0                      cmpb      #$A0
03581    D39C 2607                      bne       LD39F               ; Error : 
03582    D39E A761       LD398          sta       1,S                 ; Save des
03583    D3A0 BDCF40                    jsr       >SuperDosCreateFile ; re-write
03584    D3A3 2703                      beq       LD3A2               ; no error
03585    D3A5 7EC6CB     LD39F          jmp       >DosHookSysError    ; Error : 
03586                    
03587    D3A8 A6E4       LD3A2          lda       ,S                  ; Get sour
03588    D3AA 97F1                      sta       <DosCurrCtrlBlk     ; Save cur
03589    D3AC BDCED8                    jsr       >DosFCBNoToAddr     ; Get FCB 
03590                    
03591                    ; Compare file pointer position with file length for so
03592                    
03593    D3AF EC0C                      ldd       12,X
03594    D3B1 10A38810                  cmpd      $10,X
03595    D3B5 2507                      bcs       LD3B8
03596    D3B7 A60E                      lda       14,X
03597    D3B9 A18812                    cmpa      $12,X
03598    D3BC 2750                      beq       LD408
03599                    
03600    D3BE EE0C       LD3B8          ldu       12,X
03601    D3C0 A60E                      lda       14,X
03602    D3C2 A766                      sta       6,S
03603    D3C4 EF64                      stu       4,S
03604    D3C6 EC62                      ldd       2,S
03605    D3C8 E365                      addd      5,S
03606    D3CA ED65                      std       5,S
03607    D3CC 2402                      bcc       LD3CA
03608    D3CE 6C64                      inc       4,S
03609    D3D0 A664       LD3CA          lda       4,S
03610    D3D2 A08810                    suba      $10,X
03611    D3D5 250E                      bcs       LD3DF
03612    D3D7 EC65                      ldd       5,S
03613    D3D9 A38811                    subd      $11,X
03614    D3DC 2307                      bls       LD3DF
03615    D3DE EC8811                    ldd       $11,X
03616    D3E1 A30D                      subd      13,X
03617    D3E3 ED62                      std       2,S
03618                    
03619    D3E5 A6E4       LD3DF          lda       ,S                  ; Get sour
03620    D3E7 EE0C                      ldu       12,X                ; Get numb
03621    D3E9 E60E                      ldb       14,X                ; Y:B=posi
03622    D3EB 10AE62                    ldy       2,S
03623    D3EE 9E1F                      ldx       <BasVarEnd          ; Point to
03624    D3F0 BDC9C3                    jsr       >SuperDosFRead      ; Read fro
03625    D3F3 26B0                      bne       LD39F               ; error : 
03626                    
03627    D3F5 A661                      lda       1,S                 ; Get dest
03628    D3F7 97F1                      sta       <DosCurrCtrlBlk     ; Save in 
03629    D3F9 BDCED8                    jsr       >DosFCBNoToAddr     ; Get addr
03630                    
03631    D3FC 10AE8810                  ldy       $10,X



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 058


03632    D400 E68812                    ldb       $12,X
03633    D403 EE62                      ldu       2,S
03634    D405 9E1F                      ldx       <BasVarEnd          ; Point to
03635    D407 BDCB85                    jsr       >SuperDosFWrite     ; Write to
03636    D40A 2699                      bne       LD39F               ; Error : 
03637    D40C 209A                      bra       LD3A2               ; continue
03638                    
03639    D40E BDCEE7     LD408          jsr       >SuperDosCloseAll   ; Close al
03640    D411 2692                      bne       LD39F               ; Error !	
03641    D413 3267                      leas      7,S                 ; drop sta
03642    D415 39                        rts       
03643                    ;
03644                    ; Merge command dispatch routine.
03645                    ;
03646                    ; Syntax :
03647                    ;	MERGE filespec
03648                    ;
03649                    
03650                    CmdMerge                 
03651    D416 BDD6D1                    jsr       >DosValidateAndOpenBas
03652    D419 268A                      bne       LD39F
03653    D41B 8D7D                      bsr       LD494
03654    D41D 2686                      bne       LD39F
03655    D41F 8101                      cmpa      #$01
03656    D421 263E                      bne       LD45B
03657    D423 DE1B                      ldu       <BasVarSimpleAddr
03658    D425 109E19                    ldy       <BasStartProg
03659    D428 3460                      pshs      Y,U
03660    D42A 3341                      leau      1,U
03661    D42C DF19                      stu       <BasStartProg
03662    D42E BDD50D                    jsr       >LD507
03663    D431 3550                      puls      X,U
03664    D433 DF1B                      stu       <BasVarSimpleAddr
03665    D435 9F19                      stx       <BasStartProg
03666    D437 3341                      leau      1,U
03667    D439 ECC1       LD433          ldd       ,U++
03668    D43B 271E                      beq       LD455
03669    D43D ECC1                      ldd       ,U++
03670    D43F FD02DA                    std       BasLinInpHead
03671    D442 DD2B                      std       <BasTempLine
03672    D444 5F                        clrb      
03673    D445 8E02DC                    ldx       #$02DC
03674    D448 5C         LD442          incb      
03675    D449 A6C0                      lda       ,U+
03676    D44B A780                      sta       ,X+
03677    D44D 26F9                      bne       LD442
03678    D44F CB04                      addb      #$04
03679    D451 D703                      stb       <BasGenCount
03680    D453 3440                      pshs      U
03681    D455 8D0D                      bsr       LD45E
03682    D457 3540                      puls      U
03683    D459 20DE                      bra       LD433
03684                    
03685    D45B 7F0611     LD455          clr       DosRunLoadFlag
03686    D45E 7ED4EA                    jmp       >LD4E4
03687                    
03688    D461 7EA616     LD45B          jmp       >BasFMError
03689                    
03690    D464 BDAD01     LD45E          jsr       >BasFindLineNo
03691    D467 2512                      bcs       LD475



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 059


03692    D469 DC47                      ldd       <BasVarFPAcc4+2
03693    D46B A384                      subd      ,X
03694    D46D D31B                      addd      <BasVarSimpleAddr
03695    D46F DD1B                      std       <BasVarSimpleAddr
03696    D471 EE84                      ldu       ,X
03697    D473 A6C0       LD46D          lda       ,U+
03698    D475 A780                      sta       ,X+
03699    D477 9C1B                      cmpx      <BasVarSimpleAddr
03700    D479 26F8                      bne       LD46D
03701    D47B DC1B       LD475          ldd       <BasVarSimpleAddr
03702    D47D DD43                      std       <BasVarFPAcc3+3
03703    D47F DB03                      addb      <BasGenCount
03704    D481 8900                      adca      #$00
03705    D483 DD41                      std       <BasVarFPAcc3+1
03706    D485 BDAC1E                    jsr       >BasChkArrSpaceMv
03707    D488 CE02D8                    ldu       #$02D8
03708    D48B A6C0       LD485          lda       ,U+
03709    D48D A780                      sta       ,X+
03710    D48F 9C45                      cmpx      <BasVarFPAcc4
03711    D491 26F8                      bne       LD485
03712    D493 9E41                      ldx       <BasVarFPAcc3+1
03713    D495 9F1B                      stx       <BasVarSimpleAddr
03714    D497 7EACEF                    jmp       >BasVect2
03715                    
03716                    
03717    D49A 8E0650     LD494          ldx       #DosCurDriveInfo    ; Get curr
03718    D49D 108E0009                  ldy       #$0009
03719    D4A1 DE8A                      ldu       <Misc16BitScratch   ; U=0 ?
03720    D4A3 5F                        clrb      
03721    D4A4 96F1                      lda       <DosCurrCtrlBlk     ; Get curr
03722    D4A6 BDC9C3                    jsr       >SuperDosFRead      ; Go read 
03723    D4A9 2611                      bne       LD4B6               ; Error : 
03724                    
03725    D4AB 8655                      lda       #$55
03726    D4AD 8E0650                    ldx       #DosCurDriveInfo    ; Get curr
03727    D4B0 A184                      cmpa      ,X
03728    D4B2 26AD                      bne       LD45B
03729                    
03730    D4B4 43                        coma      
03731    D4B5 A108                      cmpa      8,X
03732    D4B7 26A8                      bne       LD45B
03733    D4B9 A601                      lda       1,X
03734    D4BB 5F                        clrb      
03735    D4BC 39         LD4B6          rts       
03736                    
03737                    DosHookRun               
03738    D4BD 7F0614                    clr       $0614
03739    D4C0 7F0619                    clr       $0619
03740    D4C3 7F0617                    clr       $0617
03741    D4C6 7F0618                    clr       $0618
03742    D4C9 8122                      cmpa      #$22
03743    D4CB 2702                      beq       LD4C9
03744    D4CD 4D                        tsta      
03745    D4CE 39                        rts                           ; Dragon, 
03746                    
03747    D4CF 3262       LD4C9          leas      2,S
03748    D4D1 C601                      ldb       #$01
03749                    
03750    D4D3 21                        fcb       $21
03751                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 060


03752                    ;
03753                    ; Load command dispatch routine
03754                    ;
03755                    ; Syntax :
03756                    ;	LOAD filespec
03757                    ;	LOAD filespec,offset
03758                    ;
03759                    
03760                    CmdLoad                  
03761    D4D4 5F                        clrb                          ; Set run/
03762    D4D5 F70611                    stb       DosRunLoadFlag
03763                    
03764    D4D8 BDD6D1                    jsr       >DosValidateAndOpenBas ; Open 
03765    D4DB 2604                      bne       LD4DB               ; Error : 
03766                    
03767    D4DD 8DBB                      bsr       LD494
03768    D4DF 2703                      beq       LD4DE               ; No error
03769                    
03770    D4E1 7EC6CB     LD4DB          jmp       >DosHookSysError
03771                    
03772    D4E4 8101       LD4DE          cmpa      #$01
03773    D4E6 2647                      bne       LD529
03774    D4E8 8D23                      bsr       LD507
03775                    
03776    D4EA 0FF6       LD4E4          clr       <DosIOInProgress    ; Flag no 
03777    D4EC 9E19                      ldx       <BasStartProg       ; Get star
03778    D4EE BDAEBB                    jsr       >BasSetProgPtrX     ; Set prog
03779    D4F1 9E27                      ldx       <AddrFWareRamTop    ; Set Top 
03780    D4F3 9F23                      stx       <BasVarStrTop
03781    D4F5 9E1B                      ldx       <BasVarSimpleAddr   ; Set Arra
03782    D4F7 9F1D                      stx       <BasVarArrayAddr
03783    D4F9 9F1F                      stx       <BasVarEnd          ; Set Basi
03784                    
03785    D4FB BDADE4     LD4F5          jsr       >CmdRestore         ; So the e
03786    D4FE BDAD33                    jsr       >BasResetStack      ; Reset ba
03787    D501 7D0611                    tst       DosRunLoadFlag      ; Is this 
03788    D504 2703                      beq       LD503               ; Just a l
03789    D506 7EAD9E                    jmp       >BasRun             ; Run basi
03790                    
03791    D509 4F         LD503          clra                          ; Clear er
03792    D50A 7EAC73                    jmp       >BasCmdMode         ; Go to co
03793                    
03794    D50D EC04       LD507          ldd       4,X
03795    D50F 1F02                      tfr       D,Y
03796    D511 D319                      addd      <BasStartProg
03797    D513 DD1F                      std       <BasVarEnd
03798    D515 C640                      ldb       #$40
03799    D517 BDAC33                    jsr       >BasChkB2Free
03800    D51A 96F1       LD514          lda       <DosCurrCtrlBlk
03801    D51C C609                      ldb       #$09
03802    D51E 9E19                      ldx       <BasStartProg
03803    D520 DE8A                      ldu       <Misc16BitScratch
03804    D522 BDC9C3                    jsr       >SuperDosFRead
03805    D525 26BA                      bne       LD4DB
03806    D527 BDACEF                    jsr       >BasVect2
03807    D52A 3002                      leax      2,X
03808    D52C 9F1B                      stx       <BasVarSimpleAddr
03809    D52E 39                        rts       
03810                    
03811    D52F 8102       LD529          cmpa      #$02



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 061


03812    D531 1026FF2C                  lbne      LD45B
03813    D535 EE06                      ldu       6,X
03814    D537 DF9D                      stu       <BasExecAddr
03815    D539 9DA5                      jsr       <BasChrGetCurr
03816    D53B 2712                      beq       LD549
03817    D53D 3410                      pshs      X
03818    D53F 8D6F                      bsr       LD5AA
03819    D541 1F13                      tfr       X,U
03820    D543 3510                      puls      X
03821    D545 EC06                      ldd       6,X
03822    D547 A302                      subd      2,X
03823    D549 EF02                      stu       2,X
03824    D54B E302                      addd      2,X
03825    D54D DD9D                      std       <BasExecAddr
03826    D54F 10AE04     LD549          ldy       4,X
03827    D552 96F1                      lda       <DosCurrCtrlBlk
03828    D554 C609                      ldb       #$09
03829    D556 DE8A                      ldu       <Misc16BitScratch
03830    D558 AE02                      ldx       2,X
03831    D55A BDC9C3                    jsr       >SuperDosFRead
03832    D55D 2648                      bne       LD5A1
03833    D55F 7D0611                    tst       DosRunLoadFlag
03834    D562 274B                      beq       LD5A9
03835    D564 6E9F009D                  jmp       [>BasExecAddr]
03836                    
03837                    ;
03838                    ; Save command dispatch routine.
03839                    ;
03840                    ; Syntax :
03841                    ;	SAVE filespec
03842                    ;	SAVE filespec,start_addr,end_addr,entry_addr
03843                    ;
03844                    
03845                    CmdSave                  
03846    D568 BDB156                    jsr       >VarGetStr
03847    D56B BDB146                    jsr       >VarGetExpr
03848    D56E 9DA5                      jsr       <BasChrGetCurr
03849    D570 2744                      beq       LD5B0
03850    D572 108EDFA8                  ldy       #DosExtBin
03851    D576 8D26                      bsr       LD598
03852    D578 8D36                      bsr       LD5AA
03853    D57A BF0652                    stx       $0652
03854    D57D 8D31                      bsr       LD5AA
03855    D57F 1F10                      tfr       X,D
03856    D581 BC0652                    cmpx      $0652
03857    D584 1025F141                  lbcs      DosPRError
03858    D588 B30652                    subd      $0652
03859    D58B 102BDEBB                  lbmi      BasFCError
03860    D58F C30001                    addd      #$0001
03861    D592 FD0654                    std       $0654
03862    D595 8D19                      bsr       LD5AA
03863    D597 BF0656                    stx       $0656
03864    D59A C602                      ldb       #$02
03865    D59C 2032                      bra       LD5CA
03866                    
03867    D59E BDD6E5     LD598          jsr       >LD6DF
03868    D5A1 2707                      beq       LD5A4
03869    D5A3 C1A0                      cmpb      #$A0
03870    D5A5 2703                      beq       LD5A4
03871    D5A7 7EC6CB     LD5A1          jmp       >DosHookSysError



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 062


03872                    
03873    D5AA BDCF40     LD5A4          jsr       >SuperDosCreateFile
03874    D5AD 26F8                      bne       LD5A1
03875    D5AF 39         LD5A9          rts       
03876                    
03877    D5B0 BDB26D     LD5AA          jsr       >VarCKComma
03878    D5B3 7EB73D                    jmp       >VarGet16Bit
03879                    
03880    D5B6 108EDFA2   LD5B0          ldy       #DosExtBas
03881    D5BA 8DE2                      bsr       LD598
03882    D5BC 9E19                      ldx       <BasStartProg
03883    D5BE BF0652                    stx       $0652
03884    D5C1 DC1B                      ldd       <BasVarSimpleAddr
03885    D5C3 9319                      subd      <BasStartProg
03886    D5C5 FD0654                    std       $0654
03887    D5C8 8EB44A                    ldx       #BasFCError
03888    D5CB BF0656                    stx       $0656
03889    D5CE C601                      ldb       #$01
03890    D5D0 8E0650     LD5CA          ldx       #DosCurDriveInfo
03891    D5D3 8655                      lda       #$55
03892    D5D5 A784                      sta       ,X
03893    D5D7 43                        coma      
03894    D5D8 A708                      sta       8,X
03895    D5DA E701                      stb       1,X
03896    D5DC 96F1                      lda       <DosCurrCtrlBlk
03897    D5DE 5F                        clrb      
03898    D5DF 109E8A                    ldy       <Misc16BitScratch
03899    D5E2 CE0009                    ldu       #$0009
03900    D5E5 BDCB85                    jsr       >SuperDosFWrite
03901    D5E8 26BD                      bne       LD5A1
03902    D5EA 96F1                      lda       <DosCurrCtrlBlk
03903    D5EC C609                      ldb       #$09
03904    D5EE BE0652                    ldx       $0652
03905    D5F1 FE0654                    ldu       $0654
03906    D5F4 109E8A                    ldy       <Misc16BitScratch
03907    D5F7 BDCB85                    jsr       >SuperDosFWrite
03908    D5FA 26AB                      bne       LD5A1
03909    D5FC 0FF6                      clr       <DosIOInProgress
03910    D5FE 39                        rts       
03911                    
03912                    ;
03913                    ; Chain command dispatch routine.
03914                    ;
03915                    ; Syntax :
03916                    ;	CHAIN filespec	
03917                    ;
03918                    
03919                    CmdChain                 
03920    D5FF 8D75                      bsr       LD670
03921    D601 BDD6D1                    jsr       >DosValidateAndOpenBas
03922    D604 26A1                      bne       LD5A1
03923    D606 BDD49A                    jsr       >LD494
03924    D609 269C                      bne       LD5A1
03925    D60B 8101                      cmpa      #$01
03926    D60D 1026FE50                  lbne      LD45B
03927    D611 9DA5                      jsr       <BasChrGetCurr
03928    D613 270F                      beq       LD61E
03929    D615 BDB26D                    jsr       >VarCKComma
03930    D618 BDAF67                    jsr       >BasGetLineNo
03931    D61B 8D12                      bsr       LD629



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 063


03932    D61D DC2B                      ldd       <BasTempLine
03933    D61F BDAEB4                    jsr       >BasSkipLineNo
03934    D622 2008                      bra       LD626
03935                    
03936    D624 8D09       LD61E          bsr       LD629
03937    D626 DE19                      ldu       <BasStartProg
03938    D628 335F                      leau      -1,U
03939    D62A DFA6                      stu       <BasAddrSigByte
03940    D62C 7ED4FB     LD626          jmp       >LD4F5
03941                    
03942    D62F FC0654     LD629          ldd       $0654
03943    D632 1F02                      tfr       D,Y
03944    D634 D319                      addd      <BasStartProg
03945    D636 931B                      subd      <BasVarSimpleAddr
03946    D638 3406                      pshs      D
03947    D63A D31F                      addd      <BasVarEnd
03948    D63C DD1F                      std       <BasVarEnd
03949    D63E C640                      ldb       #$40
03950    D640 F70611                    stb       DosRunLoadFlag
03951    D643 BDAC33                    jsr       >BasChkB2Free
03952    D646 ECE4                      ldd       ,S
03953    D648 2A0F                      bpl       LD653
03954    D64A 9E1B                      ldx       <BasVarSimpleAddr
03955    D64C 338B                      leau      D,X
03956    D64E A680       LD648          lda       ,X+
03957    D650 A7C0                      sta       ,U+
03958    D652 11931F                    cmpu      <BasVarEnd
03959    D655 23F7                      bls       LD648
03960    D657 200E                      bra       LD661
03961                    
03962    D659 9E1F       LD653          ldx       <BasVarEnd
03963    D65B 3001                      leax      1,X
03964    D65D 338B                      leau      D,X
03965    D65F A682       LD659          lda       ,-X
03966    D661 A7C2                      sta       ,-U
03967    D663 9C1B                      cmpx      <BasVarSimpleAddr
03968    D665 24F8                      bcc       LD659
03969    D667 ECE4       LD661          ldd       ,S
03970    D669 D31B                      addd      <BasVarSimpleAddr
03971    D66B DD1B                      std       <BasVarSimpleAddr
03972    D66D 3506                      puls      D
03973    D66F D31D                      addd      <BasVarArrayAddr
03974    D671 DD1D                      std       <BasVarArrayAddr
03975    D673 7ED51A                    jmp       >LD514
03976                    
03977    D676 9E1B       LD670          ldx       <BasVarSimpleAddr   ; Get poin
03978    D678 3002                      leax      2,X
03979    D67A 9C1D       LD674          cmpx      <BasVarArrayAddr    ; More tha
03980    D67C 240A                      bcc       LD682
03981                    
03982    D67E 6D1F                      tst       -1,X
03983    D680 2A02                      bpl       LD67E
03984    D682 8D2C                      bsr       LD6AA
03985    D684 3007       LD67E          leax      7,X
03986    D686 20F2                      bra       LD674
03987                    
03988    D688 DE1D       LD682          ldu       <BasVarArrayAddr    ; Array po
03989    D68A 11931F     LD684          cmpu      <BasVarEnd          ; any arra
03990    D68D 241E                      bcc       LD6A7
03991    D68F EC42                      ldd       2,U



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 064


03992    D691 30CB                      leax      D,U
03993    D693 3410                      pshs      X
03994    D695 6D41                      tst       1,U
03995    D697 2A10                      bpl       LD6A3
03996    D699 E644                      ldb       4,U
03997    D69B 4F                        clra      
03998    D69C 58                        aslb      
03999    D69D 30CB                      leax      D,U
04000    D69F 3005                      leax      5,X
04001    D6A1 8D0D       LD69B          bsr       LD6AA
04002    D6A3 3005                      leax      5,X
04003    D6A5 ACE4                      cmpx      ,S
04004    D6A7 25F8                      bcs       LD69B
04005    D6A9 3540       LD6A3          puls      U
04006    D6AB 20DD                      bra       LD684
04007                    
04008    D6AD 7EB591     LD6A7          jmp       >VarGarbageCollect
04009                    
04010    D6B0 3450       LD6AA          pshs      X,U
04011    D6B2 9C21                      cmpx      <BasVarStringBase
04012    D6B4 2413                      bcc       LD6C3
04013    D6B6 E684                      ldb       ,X
04014    D6B8 270F                      beq       LD6C3
04015    D6BA BDB56D                    jsr       >BasResStr2
04016    D6BD 1F13                      tfr       X,U
04017    D6BF 10AEE4                    ldy       ,S
04018    D6C2 AE22                      ldx       2,Y
04019    D6C4 EF22                      stu       2,Y
04020    D6C6 BDA59A                    jsr       >UtilCopyBXtoU
04021    D6C9 35D0       LD6C3          puls      X,U,PC
04022                    
04023    D6CB 108EDFA5   LD6C5          ldy       #DosExtDat
04024    D6CF 200A                      bra       DosGetFilenameAndOpenExt
04025                    
04026                    ;
04027                    ; Validate and open Basic program file supplied on comm
04028                    ;
04029                    
04030                    DosValidateAndOpenBas           
04031    D6D1 108EDFA2                  ldy       #DosExtBas          ; Point to
04032    D6D5 2004                      bra       DosGetFilenameAndOpenExt ; Val
04033                    
04034                    ;
04035                    ; Get a filename from Dos and open it
04036                    ; 	Takes a string supplied on command name, fetches it 
04037                    ;	tries to open the file of that name.
04038                    ; 
04039                    ; If entered at DosGetFilenameAndOpenExt then extension
04040                    ;
04041                    ; Exits with :-
04042                    ;		A=FCB number for opened file
04043                    ;		B= Error code ?
04044                    ;		Y=ptr to extension
04045                    ;
04046                    
04047                    
04048                    DosGetFilenameAndOpen           
04049    D6D7 108EDFAB                  ldy       #DosExtNone         ; Point to
04050                    
04051                    DosGetFilenameAndOpenExt           



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 065


04052    D6DB 3420                      pshs      Y
04053    D6DD BDB156                    jsr       >VarGetStr          ; get stri
04054    D6E0 BDB146                    jsr       >VarGetExpr         ; Get addr
04055    D6E3 3520                      puls      Y
04056    D6E5 9E52       LD6DF          ldx       <BasVarAssign16     ; Get stri
04057    D6E7 3410                      pshs      X
04058    D6E9 E684                      ldb       ,X                  ; Get stri
04059    D6EB AE02                      ldx       2,X                 ; Get poin
04060    D6ED BDC7E7                    jsr       >DosValidateAndOpen ; Validate
04061    D6F0 3510                      puls      X
04062    D6F2 3406                      pshs      D
04063    D6F4 BDB659                    jsr       >VarDelVar          ; Delete t
04064    D6F7 3506                      puls      D
04065    D6F9 5D                        tstb                          ; Get erro
04066    D6FA 39                        rts       
04067                    
04068                    DosHookCloseSingle           
04069    D6FB 8609                      lda       #$09
04070    D6FD 97F1                      sta       <DosCurrCtrlBlk
04071    D6FF BDCEFF     LD6F9          jsr       >LCEF9
04072    D702 2619                      bne       LD717
04073    D704 0AF1                      dec       <DosCurrCtrlBlk
04074    D706 2AF7                      bpl       LD6F9
04075    D708 0FF6       LD702          clr       <DosIOInProgress
04076    D70A 8C39FD                    cmpx      #$39FD
04077                    
04078                    DosFlagDrivesOffline           
04079    D70D 4F                        clra                          ; Clears s
04080    D70E 5F                        clrb      
04081    D70F FD0697                    std       DosD0Online         ; Drives 0
04082    D712 FD0699                    std       DosD2Online         ; Drives 2
04083    D715 39                        rts       
04084                    
04085                    DosDrivesOffCLS           
04086    D716 8DF5                      bsr       DosFlagDrivesOffline ; Flag al
04087    D718 7EA928                    jmp       >TextCls            ; Clear sc
04088                    
04089    D71B 27EB       LD715          beq       LD702
04090    D71D 7EC6CB     LD717          jmp       >DosHookSysError
04091                    
04092    D720 BDCEFF     LD71A          jsr       >LCEF9
04093    D723 20F6                      bra       LD715
04094                    
04095                    ;
04096                    ; Create command dispatch routine.
04097                    ; 
04098                    ; Syntax :
04099                    ;	CREATE filespec,length	
04100                    ;
04101                    
04102                    CmdCreate                
04103    D725 8DA4                      bsr       LD6C5
04104    D727 2708                      beq       LD72B
04105    D729 C19E                      cmpb      #$9E
04106    D72B 2704                      beq       LD72B
04107    D72D C1A0                      cmpb      #$A0
04108    D72F 26EC                      bne       LD717
04109    D731 96F1       LD72B          lda       <DosCurrCtrlBlk
04110    D733 BDCF40                    jsr       >SuperDosCreateFile
04111    D736 26E5                      bne       LD717



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 066


04112    D738 9DA5                      jsr       <BasChrGetCurr
04113    D73A 2736                      beq       LD76C
04114    D73C BDB26D                    jsr       >VarCKComma
04115    D73F BDB156                    jsr       >VarGetStr
04116    D742 BDD87F                    jsr       >LD879
04117    D745 0D51       LD73F          tst       <BasVarFPAcc1+2
04118    D747 2712                      beq       LD755
04119    D749 CCFF00                    ldd       #$FF00
04120    D74C 8D1F                      bsr       LD767
04121    D74E DC52                      ldd       <BasVarAssign16
04122    D750 83FF00                    subd      #$FF00
04123    D753 DD52                      std       <BasVarAssign16
04124    D755 24EE                      bcc       LD73F
04125    D757 0A51                      dec       <BasVarFPAcc1+2
04126    D759 26EA                      bne       LD73F
04127    D75B DC52       LD755          ldd       <BasVarAssign16
04128    D75D 2713                      beq       LD76C
04129    D75F 1083FF00                  cmpd      #$FF00
04130    D763 2308                      bls       LD767
04131    D765 83FF00                    subd      #$FF00
04132    D768 8D03                      bsr       LD767
04133    D76A CCFF00                    ldd       #$FF00
04134    D76D BDCC18     LD767          jsr       >LCC12
04135    D770 26AB                      bne       LD717
04136    D772 39         LD76C          rts       
04137                    
04138                    ;
04139                    ; Kill command dispatch routine
04140                    ;
04141                    ; Syntax :
04142                    ;	KILL filespec
04143                    ;
04144                    
04145                    CmdKill                  
04146    D773 BDD6D7                    jsr       >DosGetFilenameAndOpen
04147    D776 2605                      bne       LD777
04148    D778 BDCFE5                    jsr       >SuperDosDeleteFile
04149    D77B 27A3       LD775          beq       LD71A
04150    D77D 7EC6CB     LD777          jmp       >DosHookSysError
04151                    
04152                    ;
04153                    ; Protect command dispatch routine.
04154                    ;
04155                    ; Syntax :
04156                    ;	PROTECT ON filespec
04157                    ;	PROTECT OFF filespec
04158                    ;
04159                    
04160                    CmdProtect               
04161    D780 4D                        tsta      
04162    D781 2A0A                      bpl       LD787
04163    D783 81C2                      cmpa      #$C2
04164    D785 2717                      beq       LD798
04165    D787 8188                      cmpa      #$88
04166    D789 1026DAEA                  lbne      BasSNError
04167    D78D 8D07       LD787          bsr       LD790
04168    D78F C601                      ldb       #$01
04169    D791 BDD0CB     LD78B          jsr       >SuperDosProtect
04170    D794 20E5                      bra       LD775
04171                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 067


04172    D796 9D9F       LD790          jsr       <BasChrGet
04173    D798 BDD6D7                    jsr       >DosGetFilenameAndOpen
04174    D79B 2624                      bne       LD7BB
04175    D79D 39                        rts       
04176                    
04177    D79E 8DF6       LD798          bsr       LD790
04178    D7A0 5F                        clrb      
04179    D7A1 20EE                      bra       LD78B
04180                    
04181                    ;
04182                    ; Rename command dispatch routine
04183                    ;
04184                    ; Syntax :
04185                    ;	RENAME filespec TO filespec
04186                    ;
04187                    
04188                    CmdRename                
04189    D7A3 BDD6D7                    jsr       >DosGetFilenameAndOpen
04190    D7A6 2619                      bne       LD7BB
04191    D7A8 3402                      pshs      A
04192    D7AA C6BC                      ldb       #$BC
04193    D7AC BDB26F                    jsr       >VarCKChar
04194    D7AF BDD6D7                    jsr       >DosGetFilenameAndOpen
04195    D7B2 270B                      beq       LD7B9
04196    D7B4 C1A0                      cmpb      #$A0
04197    D7B6 2609                      bne       LD7BB
04198    D7B8 3502                      puls      A
04199    D7BA BDD0FD                    jsr       >SuperDosRename
04200    D7BD 20BC                      bra       LD775
04201                    
04202    D7BF C69E       LD7B9          ldb       #$9E
04203    D7C1 7EC6CB     LD7BB          jmp       >DosHookSysError
04204                    
04205                    ;
04206                    ; FLread command dispatch routine
04207                    ;
04208                    ; Syntax :
04209                    ;	FLREAD filespec;string
04210                    ;	FLREAD filespec, FROM first_byte,FOR count;string
04211                    ;
04212                    
04213                    CmdFLRead                
04214    D7C4 8D0D                      bsr       LD7CD
04215    D7C6 86FF                      lda       #$FF
04216    D7C8 B70612                    sta       DosFlFreadFlag
04217    D7CB BDD963                    jsr       >LD95D
04218    D7CE 8D2E                      bsr       LD7F8
04219    D7D0 7E89E8                    jmp       >BasLineInputEntry
04220                    
04221    D7D3 BDD6CB     LD7CD          jsr       >LD6C5
04222    D7D6 2650                      bne       LD822
04223    D7D8 8D51                      bsr       LD825
04224    D7DA BDCED8                    jsr       >DosFCBNoToAddr
04225    D7DD 7D067E                    tst       $067E
04226    D7E0 270A                      beq       LD7E6
04227    D7E2 FE0664                    ldu       $0664
04228    D7E5 F60666                    ldb       $0666
04229    D7E8 EF0C                      stu       12,X
04230    D7EA E70E                      stb       14,X
04231    D7EC BDD9D5     LD7E6          jsr       >LD9CF



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 068


04232    D7EF 8E02DC                    ldx       #$02DC
04233    D7F2 6F84                      clr       ,X
04234    D7F4 0E9F                      jmp       <BasChrGet
04235                    
04236                    ;
04237                    ; Fread command dispatch routine
04238                    ;
04239                    ; Syntax :
04240                    ;	FREAD filespec;variable list
04241                    ;	FREAD filespec,FROM startpos,FOR numbytes;variable li
04242                    ;
04243                    
04244                    CmdFRead                 
04245    D7F6 8DDB                      bsr       LD7CD
04246    D7F8 7F0612                    clr       DosFlFreadFlag
04247    D7FB BDB049                    jsr       >CmdReadFromX
04248    D7FE BDCED8     LD7F8          jsr       >DosFCBNoToAddr
04249    D801 F60604                    ldb       $0604
04250    D804 270E                      beq       LD80E
04251    D806 7F0603                    clr       DosErrorCode
04252    D809 EC0D                      ldd       FCBFilePointer+1,X  ; Get file
04253    D80B B30603                    subd      $0603
04254    D80E ED0D                      std       FCBFilePointer+1,X  ; Resave f
04255    D810 2402                      bcc       LD80E
04256    D812 6A0C                      dec       FCBFilePointer,X    ; Decremen
04257    D814 0DF4       LD80E          tst       <DosRecLenFlag
04258    D816 270D                      beq       LD81F
04259    D818 D6F3                      ldb       <DosNoBytesMove
04260    D81A 2709                      beq       LD81F
04261    D81C 4F                        clra      
04262    D81D E30D                      addd      FCBFilePointer+1,X
04263    D81F ED0D                      std       FCBFilePointer+1,X
04264    D821 2402                      bcc       LD81F
04265    D823 6C0C                      inc       FCBFilePointer,X
04266    D825 0F6F       LD81F          clr       <TextDevN
04267    D827 39                        rts       
04268                    
04269    D828 7EC6CB     LD822          jmp       >DosHookSysError
04270                    
04271    D82B BD8866     LD825          jsr       >BasChkDirect
04272    D82E 96F1                      lda       <DosCurrCtrlBlk
04273    D830 BDCEA5                    jsr       >SuperDosGetFLen
04274    D833 26F3                      bne       LD822
04275    D835 FF0664                    stu       $0664
04276    D838 B70666                    sta       $0666
04277    D83B 0FF4                      clr       <DosRecLenFlag
04278    D83D 7F067E                    clr       $067E
04279    D840 8601                      lda       #$01
04280    D842 976F                      sta       <TextDevN
04281    D844 9DA5       LD83E          jsr       <BasChrGetCurr
04282    D846 813B                      cmpa      #$3B
04283    D848 2752                      beq       LD896
04284    D84A BDB26D                    jsr       >VarCKComma
04285    D84D 81E5                      cmpa      #$E5
04286    D84F 2614                      bne       LD85F
04287    D851 9D9F                      jsr       <BasChrGet
04288    D853 BDB156                    jsr       >VarGetStr
04289    D856 8D27                      bsr       LD879
04290    D858 FF0664                    stu       $0664
04291    D85B B70666                    sta       $0666



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 069


04292    D85E 86FF                      lda       #$FF
04293    D860 B7067E                    sta       $067E
04294    D863 20DF                      bra       LD83E
04295                    
04296    D865 8180       LD85F          cmpa      #$80
04297    D867 260D                      bne       LD870
04298    D869 9D9F                      jsr       <BasChrGet
04299    D86B BDC669                    jsr       >Get8BitorError
04300    D86E D7F3                      stb       <DosNoBytesMove
04301    D870 C6FF                      ldb       #$FF
04302    D872 D7F4                      stb       <DosRecLenFlag
04303    D874 20CE                      bra       LD83E
04304                    
04305    D876 7EB277     LD870          jmp       >BasSNError
04306                    
04307    D879 7EB44A     LD873          jmp       >BasFCError
04308                    
04309    D87C 7EB151     LD876          jmp       >BasTMError
04310                    
04311    D87F 0D54       LD879          tst       <BasVarFPAcc1+5
04312    D881 2BF6                      bmi       LD873
04313    D883 0D06                      tst       <BasVarType
04314    D885 26F5                      bne       LD876
04315    D887 86A0                      lda       #$A0
04316    D889 904F                      suba      <BasVarFPAcc1
04317    D88B 270B                      beq       LD892
04318    D88D 0450       LD887          lsr       <BasVarFPAcc1+1
04319    D88F 0651                      ror       <BasVarFPAcc1+2
04320    D891 0652                      ror       <BasVarAssign16
04321    D893 0653                      ror       <BasVarFPAcc1+4
04322    D895 4A                        deca      
04323    D896 26F5                      bne       LD887
04324    D898 DE51       LD892          ldu       <BasVarFPAcc1+2
04325    D89A 9653                      lda       <BasVarFPAcc1+4
04326    D89C 39         LD896          rts       
04327                    
04328                    ;
04329                    ; FWrite command dispatch routine.
04330                    ;
04331                    ; Syntax :
04332                    ;	FWRITE filespec;variable list
04333                    ;	FWRITE filespec,FROM startpos,FOR numbytes;variable l
04334                    ;
04335                    
04336                    CmdFWrite                
04337    D89D BDD6CB                    jsr       >LD6C5
04338    D8A0 2709                      beq       LD8A5
04339    D8A2 C1A0                      cmpb      #$A0
04340    D8A4 2668                      bne       LD908
04341    D8A6 BDCF40                    jsr       >SuperDosCreateFile
04342    D8A9 2663                      bne       LD908
04343    D8AB BDD82B     LD8A5          jsr       >LD825
04344    D8AE BDD2A8                    jsr       >FindFreeDiskBuffer
04345    D8B1 265B                      bne       LD908
04346    D8B3 BF060B                    stx       $060B
04347    D8B6 8655                      lda       #$55
04348    D8B8 A702                      sta       2,X
04349    D8BA 0FF2                      clr       <DosBytesInDTA
04350    D8BC 9D9F                      jsr       <BasChrGet
04351    D8BE BDB8F7                    jsr       >CmdPrint



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 070


04352    D8C1 0DF4                      tst       <DosRecLenFlag
04353    D8C3 270B                      beq       LD8CA
04354    D8C5 D6F3                      ldb       <DosNoBytesMove
04355    D8C7 2707                      beq       LD8CA
04356    D8C9 8620                      lda       #$20
04357    D8CB 8D4A       LD8C5          bsr       LD911
04358    D8CD 5A                        decb      
04359    D8CE 26FB                      bne       LD8C5
04360    D8D0 0DF2       LD8CA          tst       <DosBytesInDTA
04361    D8D2 2718                      beq       LD8E6
04362    D8D4 BE060B                    ldx       $060B
04363    D8D7 AE05                      ldx       5,X
04364    D8D9 4F                        clra      
04365    D8DA D6F2                      ldb       <DosBytesInDTA
04366    D8DC 1F03                      tfr       D,U
04367    D8DE 96F1                      lda       <DosCurrCtrlBlk
04368    D8E0 10BE0664                  ldy       $0664
04369    D8E4 F60666                    ldb       $0666
04370    D8E7 BDCB85                    jsr       >SuperDosFWrite
04371    D8EA 2622                      bne       LD908
04372    D8EC BE060B     LD8E6          ldx       $060B
04373    D8EF 6F02                      clr       2,X
04374    D8F1 39         LD8EB          rts       
04375                    
04376                    DosHookCheckIONum           
04377    D8F2 2FFD                      ble       LD8EB
04378    D8F4 C104                      cmpb      #$04
04379    D8F6 2214                      bhi       LD906
04380    D8F8 3590                      puls      X,PC
04381                    
04382                    DosHookOpenDev           
04383    D8FA 3262                      leas      2,S
04384    D8FC BDB156                    jsr       >VarGetStr
04385    D8FF BDB6A4                    jsr       >BasGetStrFirst
04386    D902 3404                      pshs      B
04387    D904 BDA5A2                    jsr       >BasGetDevNo
04388    D907 5D                        tstb      
04389    D908 102FCCF7                  lble      CmdOpenEntry
04390    D90C C628       LD906          ldb       #$28
04391    D90E 7EC6CB     LD908          jmp       >DosHookSysError
04392                    
04393                    DosHookCharOut           
04394    D911 0D6F                      tst       <TextDevN
04395    D913 2FDC                      ble       LD8EB
04396    D915 3262                      leas      2,S
04397    D917 3476       LD911          pshs      D,X,Y,U
04398    D919 D6F4                      ldb       <DosRecLenFlag
04399    D91B 2704                      beq       LD91B
04400    D91D D6F3                      ldb       <DosNoBytesMove
04401    D91F 2737                      beq       LD952
04402    D921 BE060B     LD91B          ldx       $060B
04403    D924 AE05                      ldx       5,X
04404    D926 D6F2                      ldb       <DosBytesInDTA
04405    D928 3A                        abx       
04406    D929 A784                      sta       ,X
04407    D92B 0AF3                      dec       <DosNoBytesMove
04408    D92D 0CF2                      inc       <DosBytesInDTA
04409    D92F 2627                      bne       LD952
04410    D931 96F1                      lda       <DosCurrCtrlBlk
04411    D933 BE060B                    ldx       $060B



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 071


04412    D936 AE05                      ldx       5,X
04413    D938 CE0100                    ldu       #$0100
04414    D93B 10BE0664                  ldy       $0664
04415    D93F F60666                    ldb       $0666
04416    D942 BDCB85                    jsr       >SuperDosFWrite
04417    D945 2703                      beq       LD944
04418    D947 7EC6CB                    jmp       >DosHookSysError
04419                    
04420    D94A FC0665     LD944          ldd       $0665
04421    D94D C30100                    addd      #$0100
04422    D950 2403                      bcc       LD94F
04423    D952 7C0664                    inc       $0664
04424    D955 FD0665     LD94F          std       $0665
04425    D958 35F6       LD952          puls      D,X,Y,U,PC
04426                    
04427                    DosHookDiskItem           
04428    D95A 0D6F                      tst       <TextDevN
04429    D95C 2F63                      ble       LD9BB
04430    D95E 8E879A                    ldx       #$879A
04431    D961 AFE4                      stx       ,S
04432    D963 96F4       LD95D          lda       <DosRecLenFlag
04433    D965 2704                      beq       LD965
04434    D967 96F3                      lda       <DosNoBytesMove
04435    D969 274D                      beq       LD9B2
04436    D96B 8E02DD     LD965          ldx       #$02DD
04437    D96E D6F2                      ldb       <DosBytesInDTA
04438    D970 F70603                    stb       $0603
04439    D973 3A                        abx       
04440    D974 F60604                    ldb       $0604
04441    D977 F70611                    stb       DosRunLoadFlag
04442    D97A 5F                        clrb      
04443    D97B E71F                      stb       -1,X
04444    D97D D700                      stb       <BasBreakFlag
04445    D97F 0AF3       LD979          dec       <DosNoBytesMove
04446    D981 7A0604                    dec       $0604
04447    D984 0CF2                      inc       <DosBytesInDTA
04448    D986 A680                      lda       ,X+
04449    D988 272E                      beq       LD9B2
04450    D98A 810D                      cmpa      #$0D
04451    D98C 272A                      beq       LD9B2
04452    D98E 7D0612                    tst       DosFlFreadFlag
04453    D991 2608                      bne       LD995
04454    D993 812C                      cmpa      #$2C
04455    D995 2721                      beq       LD9B2
04456    D997 813A                      cmpa      #$3A
04457    D999 271D                      beq       LD9B2
04458    D99B 96F4       LD995          lda       <DosRecLenFlag
04459    D99D 2704                      beq       LD99D
04460    D99F 96F3                      lda       <DosNoBytesMove
04461    D9A1 2715                      beq       LD9B2
04462    D9A3 5C         LD99D          incb      
04463    D9A4 C1FF                      cmpb      #$FF
04464    D9A6 270E                      beq       LD9B0
04465    D9A8 B60604                    lda       $0604
04466    D9AB 26D2                      bne       LD979
04467    D9AD D600                      ldb       <BasBreakFlag
04468    D9AF 2605                      bne       LD9B0
04469    D9B1 8D0F                      bsr       LD9BC
04470    D9B3 5F                        clrb      
04471    D9B4 20C9                      bra       LD979



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 072


04472                    
04473    D9B6 3001       LD9B0          leax      1,X
04474    D9B8 F60603     LD9B2          ldb       $0603
04475    D9BB 6F1F                      clr       -1,X
04476    D9BD 8E02DC                    ldx       #$02DC
04477    D9C0 3A                        abx       
04478    D9C1 39         LD9BB          rts       
04479                    
04480    D9C2 BDCED8     LD9BC          jsr       >DosFCBNoToAddr
04481    D9C5 4F                        clra      
04482    D9C6 F60611                    ldb       DosRunLoadFlag
04483    D9C9 3406                      pshs      D
04484    D9CB EC0D                      ldd       13,X
04485    D9CD A3E1                      subd      ,S++
04486    D9CF ED0D                      std       13,X
04487    D9D1 2402                      bcc       LD9CF
04488    D9D3 6A0C                      dec       12,X
04489    D9D5 3460       LD9CF          pshs      Y,U
04490    D9D7 CE00FF                    ldu       #$00FF
04491    D9DA 8D19                      bsr       LD9EF
04492    D9DC CE02DD                    ldu       #$02DD
04493    D9DF 6FCB                      clr       D,U
04494    D9E1 96F1                      lda       <DosCurrCtrlBlk
04495    D9E3 E60E                      ldb       14,X
04496    D9E5 AE0C                      ldx       12,X
04497    D9E7 1E13                      exg       X,U
04498    D9E9 BDC9C3                    jsr       >SuperDosFRead
04499    D9EC 263D                      bne       LDA25
04500    D9EE 8E02DD                    ldx       #$02DD
04501    D9F1 6F1F                      clr       -1,X
04502    D9F3 35E0                      puls      Y,U,PC
04503                    
04504    D9F5 3440       LD9EF          pshs      U
04505    D9F7 EC0D                      ldd       13,X
04506    D9F9 E3E4                      addd      ,S
04507    D9FB 3406                      pshs      D
04508    D9FD A60C                      lda       12,X
04509    D9FF 8900                      adca      #$00
04510    DA01 A08810                    suba      $10,X
04511    DA04 3506                      puls      D
04512    DA06 2512                      bcs       LDA14
04513    DA08 221F                      bhi       LDA23
04514    DA0A A38811                    subd      $11,X
04515    DA0D 230B                      bls       LDA14
04516    DA0F EC8811                    ldd       $11,X
04517    DA12 A30D                      subd      13,X
04518    DA14 2713                      beq       LDA23
04519    DA16 EDE4                      std       ,S
04520    DA18 0300                      com       <BasBreakFlag
04521    DA1A ECE4       LDA14          ldd       ,S
04522    DA1C F70604                    stb       $0604
04523    DA1F F70611                    stb       DosRunLoadFlag
04524    DA22 7F0603                    clr       $0603
04525    DA25 0FF2                      clr       <DosBytesInDTA
04526    DA27 35A0                      puls      Y,PC
04527                    
04528    DA29 C69A       LDA23          ldb       #$9A
04529    DA2B 7EC6CB     LDA25          jmp       >DosHookSysError
04530                    
04531                    ;



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 073


04532                    ; Dir command dispatch routine
04533                    ;
04534                    ; Syntax :
04535                    ;	DIR drivenum	
04536                    ;
04537                    
04538                    CmdDir                   
04539    DA2E 2705                      beq       LDA2F               ; No drive
04540    DA30 BDC6B9                    jsr       >GetDriveNoInB      ; Else get
04541    DA33 2003                      bra       LDA32
04542                    
04543    DA35 F6060A     LDA2F          ldb       DosDefDriveNo       ; Get defa
04544                    
04545    DA38 D7EB       LDA32          stb       <DosLastDrive       ; Flag as 
04546    DA3A 6FE2                      clr       ,-S                 ; make tem
04547    DA3C BDD716                    jsr       >DosDrivesOffCLS    ; Flag dri
04548                    
04549    DA3F 5F                        clrb      
04550    DA40 BDADEB     LDA3A          jsr       >BasPollKeyboard    ; Read key
04551    DA43 BDD20A                    jsr       >SuperDosGetDirEntry ; Get nex
04552    DA46 26E3                      bne       LDA25               ; Error : 
04553                    
04554    DA48 A684                      lda       ,X                  ; Get Attr
04555    DA4A 8508                      bita      #AttrEndOfDir       ; Check fo
04556    DA4C 265B                      bne       CmdDirDoneAll       ; Yes : st
04557                    
04558    DA4E 8581                      bita      #AttrDeleted+AttrIsCont ; Is e
04559    DA50 264F                      bne       CmdDirDoNextEntry   ; yes : do
04560                    
04561    DA52 3001                      leax      1,X                 ; Point at
04562    DA54 C608                      ldb       #$08                ; Up to 8 
04563    DA56 8D61                      bsr       PrintBCharsFromX    ; Print it
04564    DA58 C604                      ldb       #$04                ; 5 chars
04565    DA5A 862E                      lda       #$2E                ; '.'
04566    DA5C 8D61                      bsr       LDAB8               ; Print ex
04567    DA5E A614                      lda       -12,X               ; Point at
04568    DA60 8502                      bita      #AttrWriteProt      ; Is this 
04569    DA62 2703                      beq       LDA61               ; no skip 
04570    DA64 8670                      lda       #'p                 ; Flag pro
04571                    ;LDA61   EQU     *+1
04572                    ;        CMPX    #$8620
04573                    
04574    DA66 8C                        fcb       Skip2               ; CMPX tri
04575    DA67 8620       LDA61          lda       #$20
04576    DA69 BDA282                    jsr       >TextOutChar        ; output a
04577    DA6C BDB9AC                    jsr       >TextOutSpace       ; And a sp
04578    DA6F CEFFFF                    ldu       #$FFFF
04579    DA72 8E06BD                    ldx       #DosFCB0Addr        ; Point at
04580    DA75 E6E4                      ldb       ,S                  ; Get file
04581    DA77 E7881D                    stb       FCBDiskFileNo,X     ; Save in 
04582    DA7A BDCB26                    jsr       >LCB20
04583    DA7D 26AC                      bne       LDA25               ; Check fo
04584                    
04585    DA7F BDCEC5                    jsr       >LCEBF
04586    DA82 8D42                      bsr       LDABF               ; Print fi
04587    DA84 DC88                      ldd       <TextVDUCursAddr    ; Check fo
04588    DA86 108305A0                  cmpd      #$05A0
04589    DA8A 2312                      bls       LDA97               ; not near
04590    DA8C 3476                      pshs      D,X,Y,U             ; save reg
04591    DA8E 8EDFE4                    ldx       #DosMoreMess        ; Point to



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 074


04592    DA91 BDB99C                    jsr       >TextOutString      ; Print mo
04593    DA94 BDADFB                    jsr       >TextWaitKey        ; wait for
04594    DA97 BDA928                    jsr       >TextCls            ; clear sc
04595    DA9A 3576                      puls      D,X,Y,U             ; Restore 
04596                    ;LDA97   EQU     *+1
04597                    ;        LDA     #$BD
04598                    ;        SUBA    <$A1
04599                    
04600                                   ifne      Tandy
04601    DA9C 2003                      bra       CmdDirDoNextEntry
04602                                   else      
04604                                   endc      
04605                    
04606    DA9E BDB958     LDA97          jsr       TextOutCRLF         ; Output E
04607                    
04608                    CmdDirDoNextEntry           
04609    DAA1 6CE4                      inc       ,S                  ; do next
04610    DAA3 E6E4                      ldb       ,S                  ; Get disk
04611    DAA5 C1A0                      cmpb      #$A0                ; More tha
04612    DAA7 2597                      bcs       LDA3A               ; Less, lo
04613                    
04614                    ;
04615                    ; We come here either when we have processed $A0 entrie
04616                    ; or we have reached an entry with the AttrEndOfDir bit
04617                    ; of the directory.
04618                    ;
04619                    
04620                    CmdDirDoneAll            
04621    DAA9 3502                      puls      A
04622    DAAB BDD179                    jsr       >SuperDosGetFree    ; Get free
04623    DAAE 4F                        clra      
04624    DAAF 1F13                      tfr       X,U
04625    DAB1 8D13                      bsr       LDABF               ; Display 
04626    DAB3 8EDADB                    ldx       #BytesFreeMess-1    ; Point to
04627    DAB6 7EB99C                    jmp       >TextOutString      ; print it
04628                    
04629                    
04630                    ; Print B chars pointed to by X, if char is $00, then o
04631                    ; Used to print filenames.
04632                    
04633                    PrintBCharsFromX           
04634    DAB9 A680                      lda       ,X+                 ; Fetch a 
04635    DABB 2602                      bne       LDAB8               ; Is it ze
04636    DABD 8620                      lda       #$20                ; Replace 
04637    DABF BDA282     LDAB8          jsr       >TextOutChar        ; Output i
04638    DAC2 5A                        decb                          ; Decremen
04639    DAC3 26F4                      bne       PrintBCharsFromX    ; any left
04640    DAC5 39                        rts       
04641                    
04642    DAC6 BDDDA2     LDABF          jsr       >LDD9B
04643    DAC9 7EBDD4                    jmp       >TextOutNumFPA0
04644                    
04645                    DosHookReadInput           
04646    DACC 3456                      pshs      D,X,U
04647    DACE 8E837D                    ldx       #$837D
04648    DAD1 AC68                      cmpx      8,S
04649    DAD3 2605                      bne       LDAD3
04650    DAD5 BDD6FB                    jsr       >DosHookCloseSingle
04651    DAD8 205A                      bra       LDB2D
04652                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 075


04653    DADA 35D6       LDAD3          puls      D,X,U,PC
04654                    
04655                    BytesFreeMess            
04656    DADC 20425954                  fcc       / BYTES FREE/
04657    DAE7 0D                        fcb       $0D
04658    DAE8 00                        fcb       $00
04659    DAE9 00                        fcb       $00
04660    DAEA 00                        fcb       $00
04661    DAEB 00                        fcb       $00
04662                    
04663                    ;
04664                    ; Auto command dispatch routine
04665                    ;
04666                    ; Syntax :
04667                    ;
04668                    ;	AUTO startline,increment
04669                    ;
04670                    
04671                    
04672                    CmdAuto                  
04673    DAEC 9E68                      ldx       <BasCurrentLine     ; Get curr
04674    DAEE 3001                      leax      1,X                 ; Incremen
04675    DAF0 1026D956                  lbne      BasFCError          ; to big :
04676    DAF4 8E000A                    ldx       #$000A              ; Default 
04677    DAF7 1F10                      tfr       X,D
04678    DAF9 3416                      pshs      D,X                 ; make roo
04679    DAFB 9DA5                      jsr       <BasChrGetCurr      ; Fetch cu
04680    DAFD 271E                      beq       CmdAutoDoAuto       ; Last cha
04681    DAFF BDB73D                    jsr       >VarGet16Bit        ; get star
04682    DB02 DC52                      ldd       <BasVarAssign16     ; check fo
04683    DB04 ED62                      std       2,S
04684    DB06 9DA5                      jsr       <BasChrGetCurr      ; Fetch cu
04685    DB08 2713                      beq       CmdAutoDoAuto       ; Last cha
04686    DB0A BDB26D                    jsr       >VarCKComma         ; check fo
04687    DB0D BDB73D                    jsr       >VarGet16Bit        ; Get Line
04688    DB10 DC52                      ldd       <BasVarAssign16
04689    DB12 2706                      beq       CmdAutoErrorExit
04690    DB14 EDE4                      std       ,S
04691    DB16 9DA5                      jsr       <BasChrGetCurr      ; Fetch cu
04692    DB18 2703                      beq       CmdAutoDoAuto       ; Last cha
04693                    CmdAutoErrorExit           
04694    DB1A 7EB277                    jmp       >BasSNError         ; More cha
04695                    
04696                    CmdAutoDoAuto            
04697    DB1D 1A50                      orcc      #$50                ; Disable 
04698    DB1F ECE1                      ldd       ,S++                ; Get Incr
04699    DB21 FD060F                    std       DosAutoInc
04700    DB24 ECE1                      ldd       ,S++                ; Get star
04701    DB26 B3060F                    subd      $060F               ; Subtrack
04702    DB29 FD060D                    std       DosAutoCurrent      ; Save in 
04703    DB2C 86FF                      lda       #AutoFlag           ; Flag in 
04704    DB2E B70613                    sta       DosAutoFlag
04705    DB31 39                        rts       
04706                    
04707    DB32 34                        fcb       $34
04708    DB33 56                        fcb       $56
04709                    
04710    DB34 7D0613     LDB2D          tst       $0613
04711    DB37 2602                      bne       LDB34
04712    DB39 35D6       LDB32          puls      D,X,U,PC



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 076


04713                    
04714    DB3B FC060D     LDB34          ldd       $060D
04715    DB3E F3060F                    addd      $060F
04716    DB41 1083F9FF                  cmpd      #$F9FF
04717    DB45 22F2                      bhi       LDB32
04718    DB47 EDE4                      std       ,S
04719    DB49 BDBDCC                    jsr       >TextOutNum16
04720    DB4C 8620                      lda       #$20
04721    DB4E BDA282                    jsr       >TextOutChar
04722    DB51 CE03DA                    ldu       #$03DA
04723    DB54 ECE4                      ldd       ,S
04724    DB56 FD060D                    std       $060D
04725    DB59 8E02DD                    ldx       #$02DD
04726    DB5C 5F                        clrb      
04727    DB5D A6C0       LDB56          lda       ,U+
04728    DB5F 2705                      beq       LDB5F
04729    DB61 A780                      sta       ,X+
04730    DB63 5C                        incb      
04731    DB64 20F7                      bra       LDB56
04732                    
04733    DB66 8620       LDB5F          lda       #$20
04734    DB68 A780                      sta       ,X+
04735    DB6A 5C                        incb      
04736    DB6B BDA171     LDB64          jsr       >TextWaitKeyCurs2
04737    DB6E 810D                      cmpa      #$0D
04738    DB70 2704                      beq       LDB6F
04739    DB72 8103                      cmpa      #$03
04740    DB74 2616                      bne       LDB85
04741    DB76 7F0613     LDB6F          clr       $0613
04742    DB79 860D                      lda       #$0D
04743    DB7B BDA282                    jsr       >TextOutChar
04744    DB7E 3268                      leas      8,S
04745    DB80 0F85                      clr       <CasLastSine
04746    DB82 8E02DD                    ldx       #$02DD
04747    DB85 860D                      lda       #$0D
04748    DB87 C601                      ldb       #$01
04749    DB89 7EA39D                    jmp       >BasInBuffFromX
04750                    
04751    DB8C 8120       LDB85          cmpa      #$20
04752    DB8E 25DB                      bcs       LDB64
04753    DB90 817B                      cmpa      #$7B
04754    DB92 24D7                      bcc       LDB64
04755    DB94 3268                      leas      8,S
04756    DB96 0F85                      clr       <CasLastSine
04757    DB98 7EA39D                    jmp       >BasInBuffFromX
04758                    
04759    DB9B 4F         LDB94          clra                          ; A=0	
04760    DB9C 8E0008                    ldx       #$0008              ; Repeat 8
04761    DB9F BDA82A     LDB98          jsr       >CasByteOut         ; Output A
04762    DBA2 301F                      leax      -1,X                ; Decremen
04763    DBA4 26F9                      bne       LDB98               ; Loop aga
04764    DBA6 39                        rts       
04765                    
04766                    ;
04767                    ; Beep command dispatch routine
04768                    ;
04769                    ; Syntax :
04770                    ;	BEEP nobeeps
04771                    ;
04772                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 077


04773                    CmdBeep                  
04774    DBA7 2704                      beq       LDBA6               ; if no pa
04775    DBA9 BDC669                    jsr       >Get8BitorError     ; get beep
04776                    
04777                    ;LDBA6   EQU     *+1
04778                    ;        CMPX    #$C601		; LDB #$01 (default beep count
04779                    
04780    DBAC 8C                        fcb       Skip2
04781    DBAD C601       LDBA6          ldb       #$01                ; Default 
04782                    
04783    DBAF 3404                      pshs      B                   ; save cou
04784    DBB1 5F                        clrb      
04785    DBB2 BDA99E                    jsr       >SndDTOAOn          ; switch d
04786    DBB5 8DE4       LDBAE          bsr       LDB94
04787    DBB7 BDADEB                    jsr       >BasPollKeyboard
04788    DBBA 6AE4                      dec       ,S                  ; decremen
04789    DBBC 270A                      beq       LDBC1               ; done all
04790    DBBE 108E6000                  ldy       #$6000              ; wait a s
04791    DBC2 313F       LDBBB          leay      -1,Y
04792    DBC4 27EF                      beq       LDBAE               ; loop bac
04793    DBC6 20FA                      bra       LDBBB
04794                    
04795    DBC8 3584       LDBC1          puls      B,PC                ; restore 
04796                    
04797                    ;
04798                    ; Wait command dispatch routine.
04799                    ;
04800                    ; Syntax :
04801                    ;	WAIT miliseconds
04802                    ;
04803                    
04804                    CmdWait                  
04805    DBCA 2711                      beq       LDBD6
04806    DBCC BDB73D                    jsr       >VarGet16Bit
04807    DBCF 9E52                      ldx       <BasVarAssign16
04808    DBD1 BDADEB     LDBCA          jsr       >BasPollKeyboard
04809    DBD4 C6A0                      ldb       #$A0
04810    DBD6 5A         LDBCF          decb      
04811    DBD7 26FD                      bne       LDBCF
04812    DBD9 301F                      leax      -1,X
04813    DBDB 26F4                      bne       LDBCA
04814    DBDD 39         LDBD6          rts       
04815                    
04816                    ;
04817                    ; Swap command dispatch routine.
04818                    ;
04819                    ; Syntax :
04820                    ;	SWAP var1,var2
04821                    ;
04822                    
04823                    CmdSwap                  
04824    DBDE BDB357                    jsr       >VarGetVar
04825    DBE1 9E39                      ldx       <BasVarPtrLast
04826    DBE3 9606                      lda       <BasVarType
04827    DBE5 3412                      pshs      A,X
04828    DBE7 BDB26D                    jsr       >VarCKComma
04829    DBEA BDB357                    jsr       >VarGetVar
04830    DBED 3522                      puls      A,Y
04831    DBEF 9106                      cmpa      <BasVarType
04832    DBF1 1026D55C                  lbne      BasTMError



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 078


04833    DBF5 DE39                      ldu       <BasVarPtrLast
04834    DBF7 8E0005                    ldx       #$0005
04835    DBFA A6C4       LDBF3          lda       ,U
04836    DBFC E6A4                      ldb       ,Y
04837    DBFE E7C0                      stb       ,U+
04838    DC00 A7A0                      sta       ,Y+
04839    DC02 301F                      leax      -1,X
04840    DC04 26F4                      bne       LDBF3
04841    DC06 39                        rts       
04842                    
04843    DC07 C68E       LDC00          ldb       #$8E
04844    DC09 0D71       LDC02          tst       <WarmStartFlag
04845    DC0B 12                        nop       
04846    DC0C 16EABC                    lbra      DosHookSysError
04847                    
04848    DC0F 8655       LDC08          lda       #$55
04849    DC11 9771                      sta       <WarmStartFlag
04850    DC13 39                        rts       
04851                    
04852                    ;
04853                    ; If assembling for the DragonDos cartrage, this is the
04854                    ; the boot command, if assembling for the dragon Alpha,
04855                    ; the space occupied by the boot command to store the c
04856                    ; activate the Alpha's drive selects and motor on, this
04857                    ; because the Alpha has a graphical boot menu, which al
04858                    ; from disk, so this routine seemed expendable.
04859                    ;
04860                    
04861                                   ifne      DragonAlpha
04909                                   else      
04910                    ;		
04911                    ; Boot command dispatch routine (DragonDos only).
04912                    ;
04913                    ; Syntax :
04914                    ;	BOOT drivenum	
04915                    ;
04916                    
04917                    CmdBoot                  
04918    DC14 2705                      beq       LDC14               ; No drive
04919    DC16 BDC6B9                    jsr       >GetDriveNoInB      ; Get driv
04920    DC19 2003                      bra       LDC17
04921                    
04922    DC1B F6060A     LDC14          ldb       DosDefDriveNo       ; use defa
04923    DC1E 8603       LDC17          lda       #BootFirstSector    ; Read boo
04924    DC20 97ED                      sta       <DskSectorNo
04925    DC22 D7EB                      stb       <LastActiveDrv      ; Set driv
04926    DC24 BDC164                    jsr       >DosDoRestore       ; Restore 
04927    DC27 25E0                      bcs       LDC02               ; Error : 
04928                    
04929    DC29 BDC15E                    jsr       >DosDoReadSec2      ; Read fir
04930    DC2C 25DB                      bcs       LDC02               ; error : 
04931                    
04932    DC2E CC4F53                    ldd       #BootSignature      ; Boot sig
04933    DC31 10934F                    cmpd      <BasVarFPAcc1
04934    DC34 26D1                      bne       LDC00               ; no : err
04935                    
04936    DC36 CC2600                    ldd       #BootLoadAddr       ; start at
04937    DC39 DDEE                      std       <DiskBuffPtr        ; Set disk
04938    DC3B BDC104     LDC34          jsr       >DosDoReadSec       ; Read a s
04939    DC3E 25C9                      bcs       LDC02               ; Error : 



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 079


04940                    
04941    DC40 0CEE                      inc       <DiskBuffPtr        ; incremen
04942    DC42 0CED                      inc       <DskSectorNo        ; incremen
04943    DC44 96ED                      lda       <DskSectorNo        ; get sect
04944    DC46 8112                      cmpa      #BootLastSector     ; Read the
04945    DC48 23F1                      bls       LDC34               ; no : rea
04946                    
04947    DC4A 7E2602                    jmp       >BootEntryAddr      ; jump to 
04948                    
04949                                   endc      
04950                    
04951                    ;
04952                    ;Drive command dispatch routine.
04953                    ;
04954                    ; Syntax :
04955                    ;	DRIVE drivenum	
04956                    ;
04957                    
04958                    CmdDrive                 
04959    DC4D 2707                      beq       LDC4F
04960    DC4F BDC6B9                    jsr       >GetDriveNoInB
04961    DC52 F7060A                    stb       DosDefDriveNo
04962    DC55 39                        rts       
04963                    
04964    DC56 7EB277     LDC4F          jmp       >BasSNError
04965                    
04966                    ;
04967                    ; Error command dispatch routine.
04968                    ;
04969                    ; Syntax :
04970                    ;	ERROR GOTO lineno
04971                    ;
04972                    
04973                    CmdError2                
04974    DC59 8181                      cmpa      #$81
04975    DC5B 26F9                      bne       LDC4F
04976    DC5D 9D9F                      jsr       <BasChrGet
04977    DC5F 81BC                      cmpa      #$BC
04978    DC61 26F3                      bne       LDC4F
04979    DC63 9D9F                      jsr       <BasChrGet
04980    DC65 BDAF67                    jsr       >BasGetLineNo
04981    DC68 9E2B                      ldx       <BasTempLine
04982    DC6A 8CF9FF                    cmpx      #$F9FF
04983    DC6D 1022D7D9                  lbhi      BasFCError
04984    DC71 BF0615                    stx       DosErrDestLine
04985    DC74 2706                      beq       LDC75
04986    DC76 86FF                      lda       #$FF
04987    DC78 B70614                    sta       $0614
04988    DC7B 39                        rts       
04989                    
04990    DC7C 7F0614     LDC75          clr       $0614
04991    DC7F 39                        rts       
04992                    
04993    DC80 BDB26D     LDC79          jsr       >VarCKComma
04994    DC83 BDB357                    jsr       >VarGetVar
04995    DC86 7EB146                    jmp       >VarGetExpr
04996                    
04997                    ;
04998                    ;Sread command dispatch routine.
04999                    ;



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 080


05000                    ; Syntax :
05001                    ;	SREAD driveno,trackno,secno,part1$,part2$
05002                    ;
05003                    
05004                    CmdSread                 
05005    DC89 BDDD28                    jsr       >GetSreadWriteParams ; Get dri
05006    DC8C 8DF2                      bsr       LDC79               ; Get addr
05007    DC8E 3410                      pshs      X                   ; save on 
05008    DC90 8DEE                      bsr       LDC79               ; Get addr
05009                    
05010    DC92 3410                      pshs      X                   ; save on 
05011    DC94 C6FF                      ldb       #$FF
05012    DC96 D7F6                      stb       <DosIOInProgress    ; Flag Dos
05013    DC98 BDD2A8                    jsr       >FindFreeDiskBuffer ; Find a b
05014    DC9B 2624                      bne       LDCBA               ; Error : 
05015                    
05016    DC9D 6F02                      clr       BuffFlag,X          ; Clear bu
05017    DC9F AE05                      ldx       BuffAddr,X          ; Get buff
05018    DCA1 9FEE                      stx       <DiskBuffPtr        ; Save as 
05019    DCA3 BDC104                    jsr       >DosDoReadSec       ; Read the
05020                    
05021    DCA6 F70603                    stb       $0603               ; Save err
05022    DCA9 DEEE                      ldu       <DiskBuffPtr        ; Get poin
05023    DCAB 33C90080                  leau      $0080,U             ; Point to
05024    DCAF 3510                      puls      X                   ; Get addr
05025    DCB1 8D11                      bsr       LDCBD               ; Copy byt
05026    DCB3 DEEE                      ldu       <DiskBuffPtr        ; Point at
05027    DCB5 3510                      puls      X                   ; Get addr
05028    DCB7 8D0B                      bsr       LDCBD               ; Copy byt
05029    DCB9 0FF6                      clr       <DosIOInProgress    ; Flag Dos
05030    DCBB F60603                    ldb       $0603               ; Retrieve
05031    DCBE 2601                      bne       LDCBA               ; Error : 
05032    DCC0 39                        rts                           ; return t
05033                    
05034    DCC1 7EC6CB     LDCBA          jmp       >DosHookSysError    ; Jump to 
05035                    
05036    DCC4 3450       LDCBD          pshs      X,U
05037    DCC6 C680                      ldb       #$80
05038    DCC8 BDB50F                    jsr       >BasResStr
05039    DCCB 3384                      leau      ,X
05040    DCCD 3510                      puls      X
05041    DCCF E784                      stb       ,X
05042    DCD1 EF02                      stu       2,X
05043    DCD3 3510                      puls      X
05044    DCD5 7EA59A                    jmp       >UtilCopyBXtoU
05045                    
05046                    ;
05047                    ; Swrite command dispatch routine.
05048                    ;
05049                    ; Syntax :
05050                    ;	SWRITE driveno,side,sector,part1$,part2$
05051                    ;
05052                    
05053                    CmdSwrite                
05054    DCD8 8D4E                      bsr       GetSreadWriteParams ; Get driv
05055    DCDA 8D46                      bsr       LDD1B
05056    DCDC BDB146                    jsr       >VarGetExpr
05057    DCDF 9E52                      ldx       <BasVarAssign16
05058    DCE1 3410                      pshs      X
05059    DCE3 8D3D                      bsr       LDD1B



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 081


05060    DCE5 BDB654                    jsr       >BasGetStrLenAddr
05061    DCE8 3414                      pshs      B,X
05062    DCEA C6FF                      ldb       #$FF
05063    DCEC D7F6                      stb       <DosIOInProgress
05064    DCEE BDD2A8                    jsr       >FindFreeDiskBuffer
05065    DCF1 26CE                      bne       LDCBA
05066    DCF3 6F02                      clr       2,X
05067    DCF5 AE05                      ldx       5,X
05068    DCF7 9FEE                      stx       <DiskBuffPtr
05069    DCF9 5F                        clrb      
05070    DCFA 6F80       LDCF3          clr       ,X+
05071    DCFC 5A                        decb      
05072    DCFD 26FB                      bne       LDCF3
05073    DCFF 3514                      puls      B,X
05074    DD01 DEEE                      ldu       <DiskBuffPtr
05075    DD03 33C90080                  leau      $0080,U
05076    DD07 5D                        tstb      
05077    DD08 2703                      beq       LDD06
05078    DD0A BDA59A                    jsr       >UtilCopyBXtoU
05079    DD0D 3510       LDD06          puls      X
05080    DD0F BDB659                    jsr       >VarDelVar
05081    DD12 DEEE                      ldu       <DiskBuffPtr
05082    DD14 5D                        tstb      
05083    DD15 2703                      beq       LDD13
05084    DD17 BDA59A                    jsr       UtilCopyBXtoU
05085    DD1A BDC101     LDD13          jsr       >DosDoWriteSec
05086    DD1D 25A2                      bcs       LDCBA
05087    DD1F 0FF6                      clr       <DosIOInProgress
05088    DD21 39                        rts       
05089                    
05090    DD22 BDB26D     LDD1B          jsr       VarCKComma
05091    DD25 7EB156                    jmp       >VarGetStr
05092                    
05093                    GetSreadWriteParams           
05094    DD28 2603                      bne       LDD26               ; params, 
05095    DD2A 7EB277                    jmp       >BasSNError         ; none : S
05096                    
05097                    ;
05098                    ; Get params for Sread/Swrite
05099                    ;
05100                    
05101    DD2D BDC6B9     LDD26          jsr       GetDriveNoInB       ; Drive nu
05102    DD30 D7EB                      stb       <DosLastDrive
05103    DD32 BDB738                    jsr       >VarGetComma8       ; Track nu
05104    DD35 C14F                      cmpb      #$4F                ; greater 
05105    DD37 2208                      bhi       LDD3A               ; Yes : er
05106    DD39 D7EC                      stb       <DskTrackNo         ; Save tra
05107    DD3B BDB738                    jsr       >VarGetComma8       ; Get sect
05108    DD3E D7ED                      stb       <DskSectorNo        ; save it
05109    DD40 39         LDD39          rts       
05110                    
05111    DD41 7EB44A     LDD3A          jmp       >BasFCError
05112                    
05113                    ;
05114                    ; Verify command dispatch routine.
05115                    ;
05116                    ; Syntax :
05117                    ;	VERIFY ON
05118                    ;	VERIFY OFF
05119                    ;



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 082


05120                    
05121                    CmdVerify                
05122    DD44 270E                      beq       LDD4D
05123    DD46 81C2                      cmpa      #$C2
05124    DD48 2603                      bne       LDD46
05125    DD4A 5F                        clrb      
05126    DD4B 2009                      bra       LDD4F
05127                    
05128    DD4D 8188       LDD46          cmpa      #$88
05129    DD4F 2703                      beq       LDD4D
05130    DD51 7EB277                    jmp       >BasSNError
05131                    
05132    DD54 C6FF       LDD4D          ldb       #$FF
05133    DD56 F70608     LDD4F          stb       DosVerifyFlag
05134    DD59 0E9F                      jmp       <BasChrGet
05135                    
05136                    DosHookEOF               
05137    DD5B 0D06                      tst       <BasVarType
05138    DD5D 27E1                      beq       LDD39
05139    DD5F 0F06                      clr       <BasVarType
05140    DD61 3262                      leas      2,S
05141    DD63 108EDFA5                  ldy       #DosExtDat
05142    DD67 BDD6E5                    jsr       LD6DF
05143    DD6A 2619                      bne       LDD7E
05144    DD6C BDCEA5                    jsr       SuperDosGetFLen
05145    DD6F 2614                      bne       LDD7E
05146    DD71 BDCED8                    jsr       DosFCBNoToAddr
05147    DD74 11A30C                    cmpu      12,X
05148    DD77 2204                      bhi       LDD76
05149    DD79 A10E                      cmpa      14,X
05150    DD7B 2302                      bls       LDD78
05151    DD7D 4F         LDD76          clra      
05152                    
05153                    ;LDD78   EQU     *+1
05154                    ;        CMPX    #$8601
05155                    
05156    DD7E 8C                        fcb       Skip2
05157    DD7F 8601       LDD78          lda       #$01
05158                    
05159    DD81 DE8A                      ldu       <Misc16BitScratch
05160    DD83 201B                      bra       LDD99
05161                    
05162    DD85 7EC6CB     LDD7E          jmp       >DosHookSysError
05163                    
05164                    FuncLoc                  
05165    DD88 BDD6CB                    jsr       LD6C5
05166    DD8B 26F8                      bne       LDD7E
05167    DD8D BDCED8                    jsr       DosFCBNoToAddr
05168    DD90 EE0C                      ldu       12,X
05169    DD92 A60E                      lda       14,X
05170    DD94 200A                      bra       LDD99
05171                    
05172                    FuncLof                  
05173    DD96 BDD6CB                    jsr       LD6C5
05174    DD99 26EA                      bne       LDD7E
05175    DD9B BDCEA5                    jsr       SuperDosGetFLen
05176    DD9E 26E5                      bne       LDD7E
05177    DDA0 0F06       LDD99          clr       <BasVarType
05178                    
05179    DDA2 5F         LDD9B          clrb      



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 083


05180    DDA3 DF51                      stu       <BasVarFPAcc1+2
05181    DDA5 DD53                      std       <BasVarFPAcc1+4
05182    DDA7 0F63                      clr       <BasVarFPAcc2+7
05183    DDA9 86A0                      lda       #$A0
05184    DDAB DD4F                      std       <BasVarFPAcc1
05185    DDAD 7EBA1C                    jmp       >VarNormFPA0
05186                    
05187                    FuncFree                 
05188    DDB0 9DA5                      jsr       <BasChrGetCurr
05189    DDB2 2705                      beq       LDDB2
05190    DDB4 BDC6B9                    jsr       GetDriveNoInB
05191    DDB7 2003                      bra       LDDB5
05192                    
05193    DDB9 F6060A     LDDB2          ldb       DosDefDriveNo
05194    DDBC D7EB       LDDB5          stb       <DosLastDrive
05195    DDBE BDD179                    jsr       SuperDosGetFree
05196    DDC1 26C2                      bne       LDD7E
05197    DDC3 1F13                      tfr       X,U
05198    DDC5 4F                        clra      
05199    DDC6 20D8                      bra       LDD99
05200                    
05201                    FuncErl                  
05202    DDC8 FC0617                    ldd       $0617
05203    DDCB 7EB4F3     LDDC4          jmp       >VarAssign16Bit2
05204                    
05205                    FuncErr                  
05206    DDCE 4F                        clra      
05207    DDCF F60619                    ldb       $0619
05208    DDD2 20F7                      bra       LDDC4
05209                    
05210                    FuncHimem                
05211    DDD4 DC27                      ldd       <AddrFWareRamTop
05212    DDD6 20F3                      bra       LDDC4
05213                    
05214                    FuncFres                 
05215    DDD8 BDB591                    jsr       VarGarbageCollect
05216    DDDB DC23                      ldd       <BasVarStrTop
05217    DDDD 9321                      subd      <BasVarStringBase
05218    DDDF 20EA                      bra       LDDC4
05219                    
05220                    ;
05221                    ; The actual core disk IO routine, accepts a function c
05222                    ; these are dispatched through this table
05223                    ;
05224                    
05225                    DosFunctionTable           
05226    DDE1 C2CD                      fdb       DosFunctionRestore  ; Restore 
05227    DDE3 C2D3                      fdb       DosFunctionSeek     ; Seek to 
05228    DDE5 C2FF                      fdb       DosFunctionReadSec  ; Read a s
05229    DDE7 C361                      fdb       DosFunctionWriteSec ; Write a 
05230    DDE9 C35E                      fdb       DosFunctionWriteSec2
05231    DDEB C385                      fdb       DosFunctionWriteTrack ; Write 
05232    DDED C2FC                      fdb       DosFunctionReadAddr ; Read add
05233    DDEF C31F                      fdb       DosFunctionReadSec2 ; Read fir
05234                    
05235                    ;
05236                    ; Data table for Format ?
05237                    ;
05238                    
05239    DDF1 01         DDDEA          fcb       $01



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 084


05240    DDF2 0A                        fcb       $0A
05241    DDF3 02                        fcb       $02
05242    DDF4 0B                        fcb       $0B
05243    DDF5 03                        fcb       $03
05244    DDF6 0C                        fcb       $0C
05245    DDF7 04                        fcb       $04
05246    DDF8 0D                        fcb       $0D
05247    DDF9 05                        fcb       $05
05248    DDFA 0E                        fcb       $0E
05249    DDFB 06                        fcb       $06
05250    DDFC 0F                        fcb       $0F
05251    DDFD 07                        fcb       $07
05252    DDFE 10                        fcb       $10
05253    DDFF 08                        fcb       $08
05254    DE00 11                        fcb       $11
05255    DE01 09                        fcb       $09
05256    DE02 12                        fcb       $12
05257    DE03 00                        fcb       $00
05258                    
05259    DE04 354E4E     DDDFD          fcc       /5NN/
05260    DE07 08                        fcb       $08
05261    DE08 00                        fcb       $00
05262    DE09 00                        fcb       $00
05263    DE0A 03                        fcb       $03
05264    DE0B F6                        fcb       $F6
05265    DE0C FC                        fcb       $FC
05266    DE0D 1F                        fcb       $1F
05267    DE0E 4E                        fcb       $4E
05268    DE0F 4E                        fcb       $4E
05269    DE10 07         DDE09          fcb       $07
05270    DE11 00                        fcb       $00
05271    DE12 00                        fcb       $00
05272    DE13 03                        fcb       $03
05273    DE14 F5                        fcb       $F5
05274    DE15 FE                        fcb       $FE
05275    DE16 01                        fcb       $01
05276    DE17 F7                        fcb       $F7
05277    DE18 4E                        fcb       $4E
05278    DE19 14                        fcb       $14
05279    DE1A 4E                        fcb       $4E
05280    DE1B 4E                        fcb       $4E
05281    DE1C 0B                        fcb       $0B
05282    DE1D 00                        fcb       $00
05283    DE1E 00                        fcb       $00
05284    DE1F 03                        fcb       $03
05285    DE20 F5                        fcb       $F5
05286    DE21 FB                        fcb       $FB
05287    DE22 00                        fcb       $00
05288    DE23 E5                        fcb       $E5
05289    DE24 F7                        fcb       $F7
05290    DE25 17                        fcb       $17
05291    DE26 4E                        fcb       $4E
05292    DE27 4E                        fcb       $4E
05293    DE28 00                        fcb       $00
05294    DE29 4E                        fcb       $4E
05295    DE2A 4E                        fcb       $4E
05296                    
05297                    ;
05298                    ; Data copied into low ram at init, inturrupt vectors e
05299                    ;



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 085


05300                    
05301    DE2B 09         DDE24          fcb       $09                 ; No bytes
05302    DE2C 0109                      fdb       $0109               ; address 
05303                    
05304                    ; Inturrupt vectors
05305                    
05306    DE2E 7EC724     LDE27          jmp       >NMISrv
05307                    
05308    DE31 7EC72D     LDE2A          jmp       >IRQSrv
05309                    
05310    DE34 7EC7E0     LDE2D          jmp       >FIRQSrv
05311                    
05312                    ; Dos vars, step rates for drives
05313                    
05314    DE37 04                        fcb       $04                 ; No bytes
05315    DE38 069F                      fdb       DosD0StepRate       ; address 
05316    DE3A 02                        fcb       SeepRateDefault
05317    DE3B 02                        fcb       SeepRateDefault
05318    DE3C 02                        fcb       SeepRateDefault
05319    DE3D 02                        fcb       SeepRateDefault
05320                    
05321                    ; New basic dispatch stub
05322                    
05323    DE3E 1E                        fcb       $1E                 ; No bytes
05324                    
05325                                   ifeq      Tandy
05327                                   else      
05328    DE3F 0134                      fdb       BasStub2            ; Copy to 
05329                                   endc      
05330                    
05331    DE41 1A                        fcb       $1A
05332    DE42 DEE1                      fdb       DDEDA
05333    DE44 C676                      fdb       LC670
05334    DE46 07                        fcb       $07
05335    DE47 DEC8                      fdb       DDEC1
05336    DE49 C691                      fdb       LC68B
05337    DE4B 00                        fcb       $00
05338    DE4C 0000                      fdb       $0000
05339    DE4E B277                      fdb       BasSNError
05340    DE50 00                        fcb       $00
05341    DE51 0000                      fdb       $0000
05342    DE53 B277                      fdb       BasSNError
05343    DE55 00                        fcb       $00
05344    DE56 00                        fcb       $00
05345    DE57 00                        fcb       $00
05346    DE58 00                        fcb       $00
05347    DE59 00                        fcb       $00
05348    DE5A 00                        fcb       $00
05349    DE5B 00                        fcb       $00
05350    DE5C 00                        fcb       $00
05351    DE5D 00                        fcb       $00
05352                    
05353    DE5E 00                        fcb       $00                 ; No bytes
05354    DE5F 00                        fcb       $00
05355                    
05356                    CommandDispatchTable           
05357    DE60 DAEC                      fdb       CmdAuto             ; Commente
05358    DE62 C54A                      fdb       CmdBackup
05359    DE64 DBA7                      fdb       CmdBeep
05360                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 086


05361                                   ifne      DragonAlpha
05363                                   else      
05364    DE66 DC14                      fdb       CmdBoot             ; Else, if
05365                                   endc      
05366                    
05367    DE68 D5FF                      fdb       CmdChain
05368    DE6A D365                      fdb       CmdCopy
05369    DE6C D725                      fdb       CmdCreate
05370    DE6E DA2E                      fdb       CmdDir
05371    DE70 DC4D                      fdb       CmdDrive
05372    DE72 C3BA                      fdb       CmdDskInit
05373    DE74 D7F6                      fdb       CmdFRead
05374    DE76 D89D                      fdb       CmdFWrite
05375    DE78 DC59                      fdb       CmdError2
05376    DE7A D773                      fdb       CmdKill
05377    DE7C D4D4                      fdb       CmdLoad
05378    DE7E D416                      fdb       CmdMerge
05379    DE80 D780                      fdb       CmdProtect
05380    DE82 DBCA                      fdb       CmdWait
05381    DE84 D7A3                      fdb       CmdRename
05382    DE86 D568                      fdb       CmdSave
05383    DE88 DC89                      fdb       CmdSread
05384    DE8A DCD8                      fdb       CmdSwrite
05385    DE8C DD44                      fdb       CmdVerify
05386    DE8E B277                      fdb       BasSNError
05387    DE90 D7C4                      fdb       CmdFLRead
05388    DE92 DBDE                      fdb       CmdSwap
05389                    
05390                    FunctionDipatchTable           
05391    DE94 DD96                      fdb       FuncLof
05392    DE96 DDB0                      fdb       FuncFree
05393    DE98 DDC8                      fdb       FuncErl
05394    DE9A DDCE                      fdb       FuncErr
05395    DE9C DDD4                      fdb       FuncHimem
05396    DE9E DD88                      fdb       FuncLoc
05397    DEA0 DDD8                      fdb       FuncFres
05398                    
05399                    ;
05400                    ; New ram hook table copied into low ram
05401                    ;
05402                    
05403                                   ifeq      Tandy
05426                                   else      
05427                    ;CoCo Table.
05428                    RamHookTable             
05429    DEA2 D8FA                      fdb       DosHookOpenDev      ; open dev
05430    DEA4 D8F2                      fdb       DosHookCheckIONum   ; check io
05431    DEA6 C2A2                      fdb       DosHookRetDevParam  ; return d
05432    DEA8 D911                      fdb       DosHookCharOut      ; char out
05433    DEAA 8CF1                      fdb       CoCoVect16A         ; char inp
05434    DEAC C2A2                      fdb       DosHookRetDevParam  ; check de
05435    DEAE C2A2                      fdb       DosHookRetDevParam  ; check de
05436    DEB0 C2A2                      fdb       DosHookRetDevParam  ; close al
05437    DEB2 D6FB                      fdb       DosHookCloseSingle  ; close si
05438    DEB4 8E90                      fdb       CoCoVect179         ; first ch
05439    DEB6 D95A                      fdb       DosHookDiskItem     ; Disk fil
05440    DEB8 C2A2                      fdb       DosHookRetDevParam  ; poll for
05441    DEBA DACC                      fdb       DosHookReadInput    ; read lin
05442    DEBC C2A2                      fdb       DosHookRetDevParam  ; finish l
05443    DEBE DD5B                      fdb       DosHookEOF          ; EOF func



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 087


05444    DEC0 8846                      fdb       CoCoVect18B         ; Eval exp
05445    DEC2 C2A2                      fdb       DosHookRetDevParam  ; User err
05446    DEC4 C6CB                      fdb       DosHookSysError     ; System e
05447    DEC6 D4BD                      fdb       DosHookRun          ; run stat
05448                    
05449                                   endc      
05450                    
05451                    ;
05452                    ; New Function names table
05453                    ;
05454                    
05455    DEC8 4C4F       DDEC1          fcc       /LO/
05456    DECA C6                        fcb       $C6
05457    DECB 465245                    fcc       /FRE/
05458    DECE C5                        fcb       $C5
05459    DECF 4552                      fcc       /ER/
05460    DED1 CC                        fcb       $CC
05461    DED2 4552                      fcc       /ER/
05462    DED4 D2                        fcb       $D2
05463    DED5 48494D45                  fcc       /HIME/
05464    DED9 CD                        fcb       $CD
05465    DEDA 4C4F                      fcc       /LO/
05466    DEDC C3                        fcb       $C3
05467    DEDD 465245                    fcc       /FRE/
05468    DEE0 A4                        fcb       $A4
05469                    
05470                    ;
05471                    ; New Command names table
05472                    ;
05473                    
05474    DEE1 415554     DDEDA          fcc       /AUT/
05475    DEE4 CF                        fcb       $CF
05476    DEE5 4241434B                  fcc       /BACKU/
05477    DEEA D0                        fcb       $D0
05478    DEEB 424545                    fcc       /BEE/
05479    DEEE D0                        fcb       $D0
05480    DEEF 424F4F                    fcc       /BOO/
05481    DEF2 D4                        fcb       $D4
05482    DEF3 43484149                  fcc       /CHAI/
05483    DEF7 CE                        fcb       $CE
05484    DEF8 434F50                    fcc       /COP/
05485    DEFB D9                        fcb       $D9
05486    DEFC 43524541                  fcc       /CREAT/
05487    DF01 C5                        fcb       $C5
05488    DF02 4449                      fcc       /DI/
05489    DF04 D2                        fcb       $D2
05490    DF05 44524956                  fcc       /DRIV/
05491    DF09 C5                        fcb       $C5
05492    DF0A 44534B49                  fcc       /DSKINI/
05493    DF10 D4                        fcb       $D4
05494    DF11 46524541                  fcc       /FREA/
05495    DF15 C4                        fcb       $C4
05496    DF16 46575249                  fcc       /FWRIT/
05497    DF1B C5                        fcb       $C5
05498    DF1C 4552524F                  fcc       /ERRO/
05499    DF20 D2                        fcb       $D2
05500    DF21 4B494C                    fcc       /KIL/
05501    DF24 CC                        fcb       $CC
05502    DF25 4C4F41                    fcc       /LOA/
05503    DF28 C4                        fcb       $C4



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 088


05504    DF29 4D455247                  fcc       /MERG/
05505    DF2D C5                        fcb       $C5
05506    DF2E 50524F54                  fcc       /PROTEC/
05507    DF34 D4                        fcb       $D4
05508    DF35 574149                    fcc       /WAI/
05509    DF38 D4                        fcb       $D4
05510    DF39 52454E41                  fcc       /RENAM/
05511    DF3E C5                        fcb       $C5
05512    DF3F 534156                    fcc       /SAV/
05513    DF42 C5                        fcb       $C5
05514    DF43 53524541                  fcc       /SREA/
05515    DF47 C4                        fcb       $C4
05516    DF48 53575249                  fcc       /SWRIT/
05517    DF4D C5                        fcb       $C5
05518    DF4E 56455249                  fcc       /VERIF/
05519    DF53 D9                        fcb       $D9
05520    DF54 46524F                    fcc       /FRO/
05521    DF57 CD                        fcb       $CD
05522    DF58 464C5245                  fcc       /FLREA/
05523    DF5D C4                        fcb       $C4
05524    DF5E 535741                    fcc       /SWA/
05525    DF61 D0                        fcb       $D0
05526                    
05527                    ;
05528                    ; Some mesagaes
05529                    ;
05530                    
05531                    ; Dragon versions slightly more verbose, as I had to cr
05532                    ; code whenporting to RS-DOS cart, by shortening messag
05533                    ; whitespace etc
05534                    ; 
05535                                   ifeq      RSDos
05547                                   else      
05548                    
05549    DF62 494E5345                  fcc       /INSERT SOURCE    /
05550    DF73 0D                        fcb       $0D
05551    DF74 00                        fcb       $00
05552    DF75 494E5345                  fcc       /INSERT DEST/
05553    DF80 494E4154                  fcc       /INATION     /
05554    DF8C 0D                        fcb       $0D
05555                    MessPressAnyKey           
05556    DF8D 00                        fcb       $00
05557    DF8E 50524553                  fcc       /PRESS ANY KEY     /
05558    DFA0 0D                        fcb       $0D
05559    DFA1 00                        fcb       $00
05560                    
05561                                   endc      
05562                    ;
05563                    ; File extensions
05564                    ;
05565                    
05566                    DosExtBas                
05567    DFA2 424153                    fcc       /BAS/
05568                    DosExtDat                
05569    DFA5 444154                    fcc       /DAT/
05570                    DosExtBin                
05571    DFA8 42494E                    fcc       /BIN/
05572                    DosExtNone               
05573    DFAB 202020                    fcc       /   /
05574                    



The Mamou Assembler Version 01.00      01/31/2012 06:57:30      Page 089


05575                    DosErrorCodeTable           
05576    DFAE 4E52534B                  fcc       /NRSKWPRTRFCCLDBTIVFDDFFSPTPEF
05577                    
05578                    DosSignonMess            
05579                                   ifne      DragonDos
05581                                   endc      
05582                    
05583                                   ifne      DragonAlpha
05585                                   endc      
05586                    
05587                                   ifne      RSDos
05588                                   ifne      Tandy
05589    DFD5 3F535550                  fcc       /?SUPERDOS E7C/     ; RSDos ca
05590                                   else      
05592                                   endc      
05593                                   endc      
05594                    
05595    DFE2 0D                        fcb       $0D
05596    DFE3 00                        fcb       $00
05597    DFE4 00         DosMoreMess    fcb       $00
05598                                   ifeq      RSDos
05600                                   endc      
05601    DFE5 204D4F52                  fcc       / MORE:/
05602    DFEB 00                        fcb       $00
05603    DFEC 00                        fcb       $00
05604                    
05605                                   ifne      DragonDos
05607                                   endc      
05608                    
05609                    ;
05610                    ; Drive lookup table used by Dragon Alpha
05611                    ;
05612                                   ifne      DragonAlpha
05616                                   endc      
05617                    
05618                    ;
05619                    ; Drive lookup table used on RS-DOS controler
05620                    ;
05621                    
05622                                   ifne      RSDos
05623                    TDriveTab                
05624    DFED 01020404                  fcb       Drive0,Drive1,Drive2,Drive3
05625                                   endc      
05626                    
05627    DFF1 A602       LDFF3          lda       2,X
05628    DFF3 4A                        deca      
05629    DFF4 2602                      bne       LDFFA
05630    DFF6 A702                      sta       2,X
05631    DFF8 BE066F     LDFFA          ldx       DosCurLSN
05632    DFFB 39                        rts       
05633                    
05634    DFFC 61                        fcb       $61
05635    DFFD 34                        fcb       $34
05636                    
05637                    ;DE000   END
